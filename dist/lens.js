!function t(e,n,r){function i(s,a){if(!n[s]){if(!e[s]){var c="function"==typeof require&&require;if(!a&&c)return c(s,!0);if(o)return o(s,!0);var u=new Error("Cannot find module '"+s+"'");throw u.code="MODULE_NOT_FOUND",u}var l=n[s]={exports:{}};e[s][0].call(l.exports,function(t){var n=e[s][1][t];return i(n?n:t)},l,l.exports,t,e,n,r)}return n[s].exports}for(var o="function"==typeof require&&require,s=0;s<r.length;s++)i(r[s]);return i}({1:[function(t){window.Lens=t("./src/lens")},{"./src/lens":145}],2:[function(t,e){"use strict";var n=t("underscore"),r=t("substance-util"),i=t("substance-document"),o=t("substance-application").$$,s=function(t){t=t||{},t.schema=r.deepclone(i.schema),t.schema.id="lens-article",t.schema.version="0.3.0",n.each(s.types,function(e,n){t.schema.types[n]=e}),n.each(s.annotations,function(e,n){t.schema.types[n]=e}),n.each(s.nodeTypes,function(e,n){t.schema.types[n]=e.Model.type}),n.each(s.indexes,function(e,n){t.schema.indexes[n]=e}),i.call(this,t),this.bySourceId=this.addIndex("by_source_id",{types:["content"],property:"source_id"}),this.nodeTypes=s.nodeTypes,void 0===t.seed&&(this.create({id:"document",type:"document",guid:t.id,creator:t.creator,created_at:t.created_at,views:s.views,title:"","abstract":"",authors:[]}),n.each(s.views,function(t){this.create({id:t,type:"view",nodes:[]})},this))};s.Renderer=function(t,e){this.docCtrl=t,this.nodeTypes=s.nodeTypes,this.options=e||{},this.nodes={},n.each(this.docCtrl.getNodes(),function(t){this.nodes[t.id]=this.createView(t)},this)},s.Renderer.Prototype=function(){this.createView=function(t){var e=this.nodeTypes[t.type].View;if(!e)throw new Error('Node type "'+t.type+'" not supported');var n=new e(t,this);return n.listenTo(this.docCtrl,"operation:applied",n.onGraphUpdate),n},this.render=function(){n.each(this.nodes,function(t){t.dispose()});var t=document.createDocumentFragment(),e=this.docCtrl.container.getTopLevelNodes();return n.each(e,function(e){this.renderNode(e,t)},this),t},this.renderNode=function(t,e){var n=this.createView(t);e.appendChild(n.render().el),"heading"===t.type&&n.el.appendChild(o("a.top",{href:"#",html:'<i class="icon-chevron-up"></i>'})),this.options.afterRender&&this.options.afterRender(this.docCtrl,n)}},s.Renderer.prototype=new s.Renderer.Prototype,s.Prototype=function(){this.fromSnapshot=function(t,e){return s.fromSnapshot(t,e)},this.getNodeBySourceId=function(t){var e=this.bySourceId.get(t),n=Object.keys(e)[0],r=e[n];return r},this.getHeadings=function(){var t=n.filter(this.get("content").getNodes(),function(t){return"heading"===t.type});return t}},s.fromSnapshot=function(t,e){return e=e||{},e.seed=t,new s(e)},s.views=["content","figures","citations","definitions","info"],s.nodeTypes=t("./nodes"),s.annotations={strong:{parent:"annotation",properties:{}},emphasis:{properties:{},parent:"annotation"},subscript:{properties:{},parent:"annotation"},superscript:{properties:{},parent:"annotation"},underline:{properties:{},parent:"annotation"},code:{parent:"annotation",properties:{}},link:{parent:"annotation",properties:{url:"string"}},idea:{parent:"annotation",properties:{}},error:{parent:"annotation",properties:{}},question:{parent:"annotation",properties:{}},resource_reference:{parent:"annotation",properties:{target:"node"}},contributor_reference:{parent:"resource_reference",properties:{target:"contributor"}},figure_reference:{parent:"resource_reference",properties:{target:"figure"}},citation_reference:{parent:"resource_reference",properties:{target:"content"}},definition_reference:{parent:"resource_reference",properties:{target:"content"}},cross_reference:{parent:"annotation",properties:{target:"content"}},formula_reference:{parent:"annotation",properties:{target:"content"}},author_callout:{parent:"annotation",properties:{style:"string"}},inline_image:{parent:"annotation",properties:{url:"string"}},label:{parent:"annotation",properties:{}},custom:{parent:"annotation",properties:{name:"string"}}},s.types={annotation:{properties:{path:["array","string"],range:"object"}},figure:{properties:{}},institution:{properties:{}},email:{properties:{}},funding:{properties:{}},caption:{properties:{}},citation:{properties:{}},document:{properties:{views:["array","view"],guid:"string",creator:"string",title:"string",authors:["array","contributor"],on_behalf_of:"string","abstract":"string"}},comment:{properties:{content:"string",created_at:"string",creator:"string",node:"node"}}};var a={id:"lens_article",nodes:{document:{type:"document",id:"document",views:["content"],title:"The Anatomy of a Lens Article",authors:["contributor_1","contributor_2","contributor_3"],guid:"lens_article"},content:{type:"view",id:"content",nodes:["cover"]},cover:{id:"cover",type:"cover"},contributor_1:{id:"contributor_1",type:"contributor",name:"Michael Aufreiter"},contributor_2:{id:"contributor_2",type:"contributor",name:"Ivan Grubisic"},contributor_3:{id:"contributor_3",type:"contributor",name:"Rebecca Close"}}};s.describe=function(){var t=new s({seed:a}),e=0;return n.each(s.nodeTypes,function(r){r=r.Model;var i="heading_"+r.type.id;t.create({id:i,type:"heading",content:r.description.name,level:1});var o=r.description.remarks.join(" "),s="text_"+r.type.id+"_intro";t.create({id:s,type:"text",content:o}),t.show("content",[i,s],-1),t.create({id:i+"_properties",type:"text",content:r.description.name+" uses the following properties:"}),t.show("content",[i+"_properties"],-1);var a=[];n.each(r.description.properties,function(n,r){var i="text_"+ ++e;t.create({id:i,type:"text",content:r+": "+n}),t.create({id:e+"_annotation",type:"code",path:[i,"content"],range:[0,r.length]}),a.push(i)}),t.create({id:i+"_property_list",type:"list",items:a,ordered:!1}),t.show("content",[i+"_property_list"],-1),t.create({id:i+"_example",type:"text",content:"Here's an example:"}),t.create({id:i+"_example_codeblock",type:"codeblock",content:JSON.stringify(r.example,null,"  ")}),t.show("content",[i+"_example",i+"_example_codeblock"],-1)}),t},s.Prototype.prototype=i.prototype,s.prototype=new s.Prototype,s.prototype.constructor=s,Object.defineProperties(s.prototype,{id:{get:function(){return this.get("document").guid},set:function(t){this.get("document").guid=t}},creator:{get:function(){return this.get("document").creator},set:function(t){this.get("document").creator=t}},created_at:{get:function(){return this.get("document").created_at},set:function(t){this.get("document").created_at=t}},title:{get:function(){return this.get("document").title},set:function(t){this.get("document").title=t}},"abstract":{get:function(){return this.get("document").abstract},set:function(t){this.get("document").abstract=t}},on_behalf_of:{get:function(){return this.get("document").on_behalf_of},set:function(t){this.get("document").on_behalf_of=t}},authors:{get:function(){var t=this.get("document");return t.authors?n.map(t.authors,function(t){return this.get(t)},this):""},set:function(t){var e=this.get("document");e.authors=n.clone(t)}},views:{get:function(){return this.get("document").views.slice(0)}}}),e.exports=s},{"./nodes":34,"substance-application":62,"substance-document":73,"substance-util":139,underscore:144}],3:[function(t,e){var n={1:"January",2:"February",3:"March",4:"April",5:"May",6:"June",7:"July",8:"August",9:"September",19:"October",11:"November",12:"December"},r={};r.formatDate=function(t){var e=t.split("-");if(t.split("-").length>=3){var r=new Date(e[0],e[1]-1,e[2]);return r.toUTCString().slice(0,16)}var i=e[1].replace("0",""),o=e[0];return n[i]+" "+o},e.exports=r},{}],4:[function(t,e){"use strict";var n=t("./article");e.exports=n},{"./article":2}],5:[function(t,e){"use strict";var n=t("substance-document").Node,r=t("underscore"),i=function(t,e){n.call(this,t,e)};i.type={id:"affiliation",parent:"content",properties:{source_id:"string",city:"string",country:"string",department:"string",institution:"string",label:"string"}},i.description={name:"Affiliation",description:"Person affiliation",remarks:["Name of a institution or organization, such as a university or corporation, that is the affiliation for a contributor such as an author or an editor."],properties:{institution:"Name of institution",department:"Department name",country:"Country where institution is located",city:"City of institution",label:"Affilation label. Usually a number counting up"}},i.example={id:"affiliation_1",source_id:"aff1",city:"Jena",country:"Germany",department:"Department of Molecular Ecology",institution:"Max Planck Institute for Chemical Ecology",label:"1",type:"affiliation"},i.Prototype=function(){},i.Prototype.prototype=n.prototype,i.prototype=new i.Prototype,i.prototype.constructor=i;var o={};r.each(i.type.properties,function(t,e){o[e]={get:function(){return this.properties[e]}}}),Object.defineProperties(i.prototype,o),e.exports=i},{"substance-document":73,underscore:144}],6:[function(t,e){"use strict";e.exports={Model:t("./affiliation")}},{"./affiliation":5}],7:[function(t,e){var n=t("underscore"),r=t("substance-document").Node,i=function(t,e){r.call(this,t,e)};i.type={id:"box",parent:"content",properties:{source_id:"string",label:"string",children:["array","paragraph"]}},i.description={name:"Box",remarks:["A box type."],properties:{label:"string",children:"0..n Paragraph nodes"}},i.example={id:"box_1",type:"box",label:"Box 1",children:["paragraph_1","paragraph_2"]},i.Prototype=function(){},i.Prototype.prototype=r.prototype,i.prototype=new i.Prototype,i.prototype.constructor=i;var o={},o={header:{get:function(){return this.properties.label}}};n.each(i.type.properties,function(t,e){o[e]={get:function(){return this.properties[e]}}}),Object.defineProperties(i.prototype,o),e.exports=i},{"substance-document":73,underscore:144}],8:[function(t,e){"use strict";var n=t("underscore"),r=t("substance-util"),i=(r.html,t("../node").View),o=t("substance-application").$$,s=function(t,e){i.call(this,t,e),this.$el.attr({id:t.id}),this.$el.addClass("content-node box")};s.Prototype=function(){this.render=function(){if(i.prototype.render.call(this),this.node.label){var t=o(".label",{text:this.node.label});this.content.appendChild(t)}var e=this.node.children;return n.each(e,function(t){var e=this.node.document.get(t),n=this.viewFactory.createView(e),r=n.render().el;this.content.appendChild(r)},this),this.el.appendChild(this.content),this}},s.Prototype.prototype=i.prototype,s.prototype=new s.Prototype,e.exports=s},{"../node":36,"substance-application":62,"substance-util":139,underscore:144}],9:[function(t,e){"use strict";e.exports={Model:t("./box"),View:t("./box_view")}},{"./box":7,"./box_view":8}],10:[function(t,e){"use strict";var n=t("substance-document"),r=function(t,e){n.Composite.call(this,t,e)};r.type={id:"caption",parent:"content",properties:{source_id:"string",title:"paragraph",children:["array","paragraph"]}},r.description={name:"Caption",remarks:["Container element for the textual description that is associated with a Figure, Table, Video node etc.","This is the title for the figure or the description of the figure that prints or displays with the figure."],properties:{title:"Caption title (optional)",children:"0..n Paragraph nodes"}},r.example={id:"caption_1",children:["paragraph_1","paragraph_2"]},r.Prototype=function(){this.hasTitle=function(){return!!this.properties.title},this.getNodes=function(){var t=[];return this.properties.children&&(t=t.concat(this.properties.children)),t},this.getTitle=function(){return this.properties.title?this.document.get(this.properties.title):void 0}},r.Prototype.prototype=n.Composite.prototype,r.prototype=new r.Prototype,r.prototype.constructor=r,n.Node.defineProperties(r.prototype,["title","children"]),e.exports=r},{"substance-document":73}],11:[function(t,e){"use strict";var n=t("../composite").View,r=(t("substance-document").List,t("substance-application").$$),i=function(t,e){n.call(this,t,e)};i.Prototype=function(){this.render=function(){this.content=r("div.content");var t;for(t=0;t<this.childrenViews.length;t++)this.childrenViews[t].dispose();var e=this.node.getTitle();if(e){var n=this.viewFactory.createView(e),i=n.render().el;i.classList.add("caption-title"),this.content.appendChild(i)}var o=this.node.getNodes();for(t=0;t<o.length;t++){var s=this.node.document.get(o[t]),a=this.viewFactory.createView(s),c=a.render().el;this.content.appendChild(c),this.childrenViews.push(a)}return this.el.appendChild(this.content),this},this.onNodeUpdate=function(t){t.path[0]===this.node.id&&"items"===t.path[1]&&this.render()}},i.Prototype.prototype=n.prototype,i.prototype=new i.Prototype,e.exports=i},{"../composite":17,"substance-application":62,"substance-document":73}],12:[function(t,e){"use strict";e.exports={Model:t("./caption"),View:t("./caption_view")}},{"./caption":10,"./caption_view":11}],13:[function(t,e){var n=t("underscore"),r=t("substance-document").Node,i=function(t,e){r.call(this,t,e)};i.type={id:"article_citation",parent:"content",properties:{source_id:"string",title:"string",label:"string",authors:["array","string"],doi:"string",source:"string",volume:"string",citation_type:"string",publisher_name:"string",publisher_location:"string",fpage:"string",lpage:"string",year:"string",comment:"string",citation_urls:["array","object"]}},i.description={name:"Citation",remarks:["A journal citation.","This element can be used to describe all kinds of citations."],properties:{title:"The article's title",label:"Optional label (could be a number for instance)",doi:"DOI reference",source:"Usually the journal name",volume:"Issue number",citation_type:"Citation Type",publisher_name:"Publisher Name",publisher_location:"Publisher Location",fpage:"First page",lpage:"Last page",year:"The year of publication",comment:"Author comment.",citation_urls:"A list of links for accessing the article on the web"}},i.example={id:"article_nature08160",type:"article_citation",label:"5",title:"The genome of the blood fluke Schistosoma mansoni",authors:["M Berriman","BJ Haas","PT LoVerde"],citation_type:"Journal Article",doi:"http://dx.doi.org/10.1038/nature08160",source:"Nature",volume:"460",fpage:"352",lpage:"8",year:"1984",comment:"This is a comment.",citation_urls:[{name:"PubMed",url:"http://www.ncbi.nlm.nih.gov/pubmed/19606141"}]},i.Prototype=function(){this.urls=function(){return this.properties.citation_urls.length>0?this.properties.citation_urls:[this.properties.doi]}},i.Prototype.prototype=r.prototype,i.prototype=new i.Prototype,i.prototype.constructor=i;var o={header:{get:function(){return n.compact([this.properties.label,this.properties.citation_type||"Citation"]).join(" - ")}}};n.each(i.type.properties,function(t,e){o[e]={get:function(){return this.properties[e]}}}),Object.defineProperties(i.prototype,o),e.exports=i},{"substance-document":73,underscore:144}],14:[function(t,e){"use strict";var n=t("underscore"),r=t("substance-util"),i=(r.html,t("../node").View),o=t("../text").View,s=t("substance-application").$$,a=function(t){var e=document.createDocumentFragment(),r=t.node,i=new o(r,{path:[r.id,"title"],classes:"title"});e.appendChild(i.render().el),e.appendChild(s(".authors",{html:r.authors.join(", ")}));var a=[];if(r.source&&""===r.volume&&a.push(r.source),r.source&&r.volume&&a.push([r.source,r.volume].join(", ")+": "),r.fpage&&r.lpage&&a.push([r.fpage,r.lpage].join("-")+", "),r.publisher_name&&r.publisher_location&&a.push([r.publisher_name,r.publisher_location].join(", ")+", "),r.year&&a.push(r.year),e.appendChild(s(".source",{html:a.join("")})),r.comment){var c=new o(r,{path:[r.id,"comment"],classes:"comment"});e.appendChild(c.render().el)}r.doi&&e.appendChild(s(".doi",{children:[s("b",{text:"DOI: "}),s("a",{href:r.doi,target:"_new",text:r.doi})]}));var u=s(".citation-urls");return n.each(r.citation_urls,function(t){u.appendChild(s("a.url",{href:t.url,text:t.name,target:"_blank"}))}),e.appendChild(u),e},c=function(t){i.call(this,t),this.$el.attr({id:t.id}),this.$el.addClass("citation")};c.Prototype=function(){this.render=function(){return i.prototype.render.call(this),this.content.appendChild(new a(this)),this}},c.Prototype.prototype=i.prototype,c.prototype=new c.Prototype,c.prototype.constructor=c,e.exports=c},{"../node":36,"../text":47,"substance-application":62,"substance-util":139,underscore:144}],15:[function(t,e){"use strict";e.exports={Model:t("./citation"),View:t("./citation_view")}},{"./citation":13,"./citation_view":14}],16:[function(t,e){"use strict";var n=t("substance-nodes");e.exports=n.codeblock},{"substance-nodes":84}],17:[function(t,e){"use strict";var n=t("substance-nodes");e.exports=n.composite},{"substance-nodes":84}],18:[function(t,e){var n=t("underscore"),r=t("substance-document").Node,i=function(t,e){r.call(this,t,e)};i.type={id:"contributor",parent:"content",properties:{source_id:"string",name:"string",role:"string",affiliations:["array","affiliation"],present_address:["string"],fundings:["array","string"],image:"string",emails:["array","string"],contribution:"string",deceased:"boolean",members:["array","string"],orcid:"string",equal_contrib:["array","string"],competing_interests:["array","string"]}},i.description={name:"Contributor",remarks:["A contributor entity."],properties:{name:"Full name",affiliations:"A list of affiliation ids",present_address:"Present address of the contributor",role:"Role of contributor (e.g. Author, Editor)",fundings:"A list of funding descriptions",deceased:!1,emails:"A list of emails",orcid:"ORCID",contribution:"Description of contribution",equal_contrib:"A list of people who contributed equally",competing_interests:"A list of conflicts",members:"a list of group members"}},i.example={id:"person_1",type:"contributor",name:"John Doe",affiliations:["affiliation_1","affiliation_2"],role:"Author",fundings:["Funding Organisation 1"],emails:["a@b.com"],contribution:"Revising the article, data cleanup",equal_contrib:["John Doe","Jane Doe"]},i.Prototype=function(){this.getAffiliations=function(){return n.map(this.properties.affiliations,function(t){return this.document.get(t)},this)}},i.Prototype.prototype=r.prototype,i.prototype=new i.Prototype,i.prototype.constructor=i;var o={},o={header:{get:function(){return"Author"}}};n.each(i.type.properties,function(t,e){o[e]={get:function(){return this.properties[e]}}}),Object.defineProperties(i.prototype,o),e.exports=i},{"substance-document":73,underscore:144}],19:[function(t,e){"use strict";var n=t("underscore"),r=t("substance-util"),i=(r.html,t("../node").View),o=t("substance-application").$$,s=function(t){i.call(this,t),this.$el.attr({id:t.id}),this.$el.addClass("content-node contributor")};s.Prototype=function(){this.render=function(){return i.prototype.render.call(this),this.content.appendChild(o(".contributor-name",{text:this.node.name})),this.content.appendChild(o(".affiliations",{children:n.map(this.node.getAffiliations(),function(t){var e=n.compact([t.department,t.institution,t.city,t.country]).join(", ");return o(".affiliation",{text:e})})})),this.node.present_address&&(this.content.appendChild(o(".label",{text:"Present address"})),this.content.appendChild(o(".contribution",{text:this.node.present_address}))),this.node.contribution&&(this.content.appendChild(o(".label",{text:"Contribution"})),this.content.appendChild(o(".contribution",{text:this.node.contribution}))),this.node.equal_contrib&&this.node.equal_contrib.length>0&&(this.content.appendChild(o(".label",{text:"Contributed equally with"})),this.content.appendChild(o(".equal-contribution",{text:this.node.equal_contrib}))),this.node.emails.length>0&&(this.content.appendChild(o(".label",{text:"For correspondence"})),this.content.appendChild(o(".emails",{children:n.map(this.node.emails,function(t){return o("a",{href:"mailto:"+t,text:t})})}))),this.node.fundings.length>0&&(this.content.appendChild(o(".label",{text:"Funding"})),this.content.appendChild(o(".fundings",{children:n.map(this.node.fundings,function(t){return o(".funding",{text:t})})}))),this.node.competing_interests.length>0&&(this.content.appendChild(o(".label",{text:"Competing Interests"})),this.content.appendChild(o(".competing-interests",{children:n.map(this.node.competing_interests,function(t){return o(".conflict",{text:t})})}))),this.node.orcid&&(this.content.appendChild(o(".label",{text:"ORCID"})),this.content.appendChild(o("a.orcid",{href:this.node.orcid,text:this.node.orcid}))),this.node.members.length>0&&(this.content.appendChild(o(".label",{text:"Group Members"})),this.content.appendChild(o(".members",{children:n.map(this.node.members,function(t){return o(".member",{text:t})})}))),this.node.deceased&&this.content.appendChild(o(".label",{text:"* Deceased"})),this}},s.Prototype.prototype=i.prototype,s.prototype=new s.Prototype,e.exports=s},{"../node":36,"substance-application":62,"substance-util":139,underscore:144}],20:[function(t,e){"use strict";e.exports={Model:t("./contributor"),View:t("./contributor_view")}},{"./contributor":18,"./contributor_view":19}],21:[function(t,e){var n=t("underscore"),r=t("substance-document").Node,i=function(t,e){r.call(this,t,e)};i.type={id:"cover",parent:"content",properties:{source_id:"string",authors:["array","paragraph"],breadcrumbs:"object"}},i.description={name:"Cover",remarks:["Virtual view on the title and authors of the paper."],properties:{authors:"A paragraph that has the authors names plus references to the person cards"}},i.example={id:"cover",type:"cover"},i.Prototype=function(){this.getAuthors=function(){return n.map(this.properties.authors,function(t){return this.document.get(t)},this)}},i.Prototype.prototype=r.prototype,i.prototype=new i.Prototype,i.prototype.constructor=i;Object.defineProperties(i.prototype,{title:{get:function(){return this.document.title}},authors:{get:function(){return this.document.authors}},breadcrumbs:{get:function(){return this.properties.breadcrumbs}}}),e.exports=i},{"substance-document":73,underscore:144}],22:[function(t,e){"use strict";var n=t("underscore"),r=t("substance-util"),i=(r.html,t("../node").View),o=t("../text").View,s=t("substance-application").$$,a=t("../../article_util"),c=function(t,e){i.call(this,t,e),this.$el.attr({id:t.id}),this.$el.addClass("content-node cover")};c.Prototype=function(){this.render=function(){i.prototype.render.call(this);var t=this.node,e=this.node.document.get("publication_info");if("HighWire"===e.provider){var r=s(".intro.container",{children:[s(".intro-text",{html:'<i class="icon-info"></i>&nbsp;&nbsp;Lens provides a novel way of looking at research on the web.'}),s("a.send-feedback",{href:"http://home.highwire.org/feedback/lens-feedback",text:"Send feedback",target:"_blank"})]});this.content.appendChild(r)}if(t.breadcrumbs&&t.breadcrumbs.length>0){var c=s(".breadcrumbs",{children:n.map(t.breadcrumbs,function(t){var e;return e=t.image?'<img src="'+t.image+'" title="'+t.name+'"/>':t.name,s("a",{href:t.url,html:e})})});this.content.appendChild(c)}if(e){var u=e.published_on;u&&this.content.appendChild(s(".published-on",{text:a.formatDate(u)}))}var l=new o(this.node,{path:["document","title"],classes:"title"});this.content.appendChild(l.render().el);var p=s(".authors",{children:n.map(t.getAuthors(),function(t){var e=this.viewFactory.createView(t),n=e.render().el;return this.content.appendChild(n),n},this)});if(p.appendChild(s(".content-node.text.plain",{children:[s(".content",{text:this.node.document.on_behalf_of})]})),this.content.appendChild(p),e&&e.links.length>0){var h=s(".links");n.each(e.links,function(t){if("json"===t.type&&""===t.url){var e=JSON.stringify(this.node.document.toJSON(),null,"  "),n=new Blob([e],{type:"application/json"});h.appendChild(s("a.json",{href:window.URL?window.URL.createObjectURL(n):"#",html:'<i class="icon-external-link-sign"></i> '+t.name,target:"_blank"}))}else h.appendChild(s("a."+t.type,{href:t.url,html:'<i class="icon-external-link-sign"></i> '+t.name,target:"_blank"}))},this),this.content.appendChild(h)}if(e){var d=e.doi;d&&this.content.appendChild(s(".doi",{html:'DOI: <a href="'+d+'">'+d+"</a>"}))}return this}},c.Prototype.prototype=i.prototype,c.prototype=new c.Prototype,e.exports=c},{"../../article_util":3,"../node":36,"../text":47,"substance-application":62,"substance-util":139,underscore:144}],23:[function(t,e){"use strict";e.exports={Model:t("./cover"),View:t("./cover_view")}},{"./cover":21,"./cover_view":22}],24:[function(t,e){var n=t("underscore"),r=t("substance-document").Node,i=function(t){r.call(this,t)};i.type={id:"definition",parent:"content",properties:{source_id:"string",title:"string",description:"string"}},i.description={name:"Definition",remarks:["A journal citation.","This element can be used to describe all kinds of citations."],properties:{title:"The article's title",description:"Definition description"}},i.example={id:"definition_def1",type:"Definition",title:"IAP",description:"Integrated Analysis Platform"},i.Prototype=function(){this.urls=function(){return this.properties.citation_urls.length>0?this.properties.citation_urls:[this.properties.doi]}},i.Prototype.prototype=r.prototype,i.prototype=new i.Prototype,i.prototype.constructor=i;var o={header:{get:function(){return this.properties.label?[this.properties.label,this.properties.title].join(". "):this.properties.title}}};n.each(i.type.properties,function(t,e){o[e]={get:function(){return this.properties[e]}}}),Object.defineProperties(i.prototype,o),e.exports=i},{"substance-document":73,underscore:144}],25:[function(t,e){"use strict";var n=(t("underscore"),t("substance-util")),r=(n.html,t("../node").View),i=t("substance-application").$$,o=function(t){r.call(this,t),this.$el.attr({id:t.id}),this.$el.addClass("definition")};o.Prototype=function(){this.render=function(){return r.prototype.render.call(this),this.content.appendChild(i(".description",{text:this.node.description})),this}},o.Prototype.prototype=r.prototype,o.prototype=new o.Prototype,o.prototype.constructor=o,e.exports=o},{"../node":36,"substance-application":62,"substance-util":139,underscore:144}],26:[function(t,e){"use strict";e.exports={Model:t("./definition"),View:t("./definition_view")}},{"./definition":24,"./definition_view":25}],27:[function(t,e){"use strict";var n=t("substance-document"),r=function(t,e){n.Composite.call(this,t,e)};r.type={parent:"content",properties:{source_id:"string",label:"string",url:"string",caption:"caption",attrib:"string"}},r.config={zoomable:!0},r.description={name:"Figure",remarks:["A figure is a figure is figure."],properties:{label:"Label used as header for the figure cards",url:"Image url",caption:"A reference to a caption node that describes the figure",attrib:"Figure attribution"}},r.example={id:"figure_1",label:"Figure 1",url:"http://example.com/fig1.png",caption:"caption_1"},r.Prototype=function(){this.hasCaption=function(){return!!this.properties.caption},this.getNodes=function(){var t=[];return this.properties.caption&&t.push(this.properties.caption),t},this.getCaption=function(){return this.properties.caption?this.document.get(this.properties.caption):void 0}},r.Prototype.prototype=n.Composite.prototype,r.prototype=new r.Prototype,r.prototype.constructor=r,n.Node.defineProperties(r.prototype,["source_id","label","url","caption","attrib"]),Object.defineProperties(r.prototype,{header:{get:function(){return this.properties.label}}}),e.exports=r},{"substance-document":73}],28:[function(t,e){"use strict";var n=t("../composite").View,r=t("substance-application").$$,i=function(t,e){n.call(this,t,e)};i.Prototype=function(){this.render=function(){this.el.innerHTML="",this.content=r("div.content");var t=r(".image-wrapper",{children:[r("a",{href:this.node.url,target:"_blank",children:[r("img",{src:this.node.url})]})]});this.content.appendChild(t);var e=this.node.getCaption();if(e){var n=this.viewFactory.createView(e),i=n.render().el;this.content.appendChild(i),this.childrenViews.push(n)}return this.node.attrib&&(console.log("ATTRIB!!"),this.content.appendChild(r(".figure-attribution",{text:this.node.attrib}))),this.el.appendChild(this.content),this}},i.Prototype.prototype=n.prototype,i.prototype=new i.Prototype,e.exports=i},{"../composite":17,"substance-application":62}],29:[function(t,e){"use strict";e.exports={Model:t("./figure"),View:t("./figure_view")}},{"./figure":27,"./figure_view":28}],30:[function(t,e){"use strict";var n=t("substance-nodes");e.exports=n.footnote},{"substance-nodes":84}],31:[function(t,e){"use strict";var n=t("substance-nodes");e.exports=n.formula},{"substance-nodes":84}],32:[function(t,e){"use strict";var n=t("substance-nodes");e.exports=n.heading},{"substance-nodes":84}],33:[function(t,e){"use strict";var n=t("substance-nodes");e.exports=n.image},{"substance-nodes":84}],34:[function(t,e){"use strict";e.exports={publication_info:t("./publication_info"),box:t("./box"),cover:t("./cover"),text:t("./text"),paragraph:t("./paragraph"),heading:t("./heading"),figure:t("./figure"),caption:t("./caption"),image:t("./image"),webresource:t("./web_resource"),table:t("./table"),supplement:t("./supplement"),video:t("./video"),contributor:t("./contributor"),definition:t("./definition"),citation:t("./citation"),formula:t("./formula"),list:t("./list"),codeblock:t("./codeblock"),affiliation:t("./_affiliation"),footnote:t("./footnote")}},{"./_affiliation":6,"./box":9,"./caption":12,"./citation":15,"./codeblock":16,"./contributor":20,"./cover":23,"./definition":26,"./figure":29,"./footnote":30,"./formula":31,"./heading":32,"./image":33,"./list":35,"./paragraph":37,"./publication_info":38,"./supplement":41,"./table":44,"./text":47,"./video":49,"./web_resource":52}],35:[function(t,e){"use strict";var n=t("substance-nodes");e.exports=n.list},{"substance-nodes":84}],36:[function(t,e){"use strict";var n=t("substance-nodes");e.exports=n.node},{"substance-nodes":84}],37:[function(t,e){"use strict";var n=t("substance-nodes");e.exports=n.paragraph},{"substance-nodes":84}],38:[function(t,e){"use strict";e.exports={Model:t("./publication_info"),View:t("./publication_info_view")}},{"./publication_info":39,"./publication_info_view":40}],39:[function(t,e){"use strict";var n=t("substance-document").Node,r=t("underscore"),i=function(t,e){n.call(this,t,e)};i.type={id:"publication_info",parent:"content",properties:{received_on:"string",accepted_on:"string",published_on:"string",journal:"string",provider:"string",article_type:"string",keywords:["array","string"],research_organisms:["array","string"],subjects:["array","string"],links:["array","objects"],doi:"string",supplements:["array","object"],related_article:"string",article_info:"paragraph"}},i.description={name:"PublicationInfo",description:"PublicationInfo Node",remarks:["Summarizes the article's meta information. Meant to be customized by publishers"],properties:{received_on:"Submission received",accepted_on:"Paper accepted on",published_on:"Paper published on",journal:"The Journal",provider:"Who is hosting this article",article_type:"Research Article vs. Insight, vs. Correction etc.",keywords:"Article's keywords",research_organisms:"Research Organisms",subjects:"Article Subjects",doi:"Article DOI",related_article:"DOI of related article if there is any"}},i.example={id:"publication_info",received_on:"2012-06-20",accepted_on:"2012-09-05",published_on:"2012-11-13",journal:"eLife",provider:"eLife",article_type:"Research Article",keywords:["innate immunity","histones","lipid droplet","anti-bacterial"],research_organisms:["B. subtilis","D. melanogaster","E. coli","Mouse"],subjects:["Immunology","Microbiology and infectious disease"],doi:"http://dx.doi.org/10.7554/eLife.00003"},i.Prototype=function(){this.getArticleInfo=function(){return this.document.get("articleinfo")}},i.Prototype.prototype=n.prototype,i.prototype=new i.Prototype,i.prototype.constructor=i;var o={};r.each(i.type.properties,function(t,e){o[e]={get:function(){return this.properties[e]}}}),Object.defineProperties(i.prototype,o),e.exports=i},{"substance-document":73,underscore:144}],40:[function(t,e){"use strict";var n=t("../node").View,r=t("substance-application").$$,i=t("../../article_util"),o=t("underscore"),s=function(t,e){n.call(this,t,e),this.$el.addClass("publication-info"),this.$el.attr("id",this.node.id)
};s.Prototype=function(){this.render=function(){n.prototype.render.call(this);var t=r(".meta-data");if(this.node.article_type){var e=r(".article-type.container",{children:[r("div.label",{text:"Article Type"}),r("div.value",{text:this.node.article_type})]});t.appendChild(e)}if(this.node.subjects&&this.node.subjects.length>0){var s=r(".subject.container",{children:[r("div.label",{text:"Subject"}),r("div.value",{text:this.node.subjects.join(", ")})]});t.appendChild(s)}if(this.node.research_organisms&&this.node.research_organisms.length>0){var a=r(".subject.container",{children:[r("div.label",{text:"Organism"}),r("div.value",{text:this.node.research_organisms.join(", ")})]});t.appendChild(a)}if(this.node.keywords&&this.node.keywords.length>0){var c=r(".keywords.container",{children:[r("div.label",{text:"Keywords"}),r("div.value",{text:this.node.keywords.join(", ")})]});t.appendChild(c)}if(this.node.doi){var u=r(".doi.container",{children:[r("div.label",{text:"DOI"}),r("div.value",{children:[r("a",{href:this.node.doi,text:this.node.doi,target:"_blank"})]})]});t.appendChild(u)}if(this.node.related_article){var l=r(".related-article.container",{children:[r("div.label",{text:"Related Article"}),r("div.value",{children:[r("a",{href:this.node.related_article,text:this.node.related_article})]})]});t.appendChild(l)}var p=[];this.node.received_on&&p.push("received on <b>"+i.formatDate(this.node.received_on)+"</b>"),this.node.accepted_on&&p.push("accepted on <b>"+i.formatDate(this.node.accepted_on)+"</b>"),this.node.published_on&&p.push("published on <b>"+i.formatDate(this.node.published_on)+"</b>");var h=r(".dates");h.appendChild(r("span",{text:"The article was "})),1===p.length?h.appendChild(r("span",{html:" "+p[0]+"."})):(h.appendChild(r("span",{html:p.slice(0,-1).join(", ")})),h.appendChild(r("span",{html:" and "+o.last(p)+"."}))),t.appendChild(h),this.content.appendChild(t);var d=this.node.getArticleInfo(),f=this.viewFactory.createView(d),g=f.render().el;return this.content.appendChild(g),this},this.dispose=function(){n.prototype.dispose.call(this)}},s.Prototype.prototype=n.prototype,s.prototype=new s.Prototype,e.exports=s},{"../../article_util":3,"../node":36,"substance-application":62,underscore:144}],41:[function(t,e){"use strict";e.exports={Model:t("./supplement"),View:t("./supplement_view")}},{"./supplement":42,"./supplement_view":43}],42:[function(t,e){var n=t("underscore"),r=t("substance-document"),i=function(t,e){r.Composite.call(this,t,e)};i.type={id:"supplement",parent:"content",properties:{source_id:"string",label:"string",url:"string",caption:"caption"}},i.description={name:"Supplement",remarks:["A Supplement entity."],properties:{source_id:"Supplement id as it occurs in the source NLM file",label:"Supplement label",caption:"References a caption node, that has all the content",url:"URL of downloadable file"}},i.example={id:"supplement_1",source_id:"SD1-data",type:"supplement",label:"Supplementary file 1.",url:"http://myserver.com/myfile.pdf",caption:"caption_supplement_1"},i.Prototype=function(){this.getNodes=function(){var t=[];return this.properties.caption&&t.push(this.properties.caption),t},this.getCaption=function(){return this.properties.caption?this.document.get(this.properties.caption):null}},i.Prototype.prototype=r.Composite.prototype,i.prototype=new i.Prototype,i.prototype.constructor=i;var o={};n.each(i.type.properties,function(t,e){o[e]={get:function(){return this.properties[e]}}}),o.header={get:function(){return this.properties.label}},Object.defineProperties(i.prototype,o),e.exports=i},{"substance-document":73,underscore:144}],43:[function(t,e){"use strict";var n=(t("underscore"),t("substance-util")),r=(n.html,t("../composite").View),i=t("substance-application").$$,o=function(t,e){r.call(this,t,e),this.$el.attr({id:t.id}),this.$el.addClass("content-node supplement")};o.Prototype=function(){this.render=function(){var t=this.node;this.content=i("div.content");var e=t.getCaption();if(e){var n=this.viewFactory.createView(e),r=n.render().el;this.content.appendChild(r),this.childrenViews.push(n)}var o=i("div.file",{children:[i("a",{href:t.url,html:'<i class="icon-download-alt"/> Download'})]});return this.content.appendChild(o),this.el.appendChild(this.content),this}},o.Prototype.prototype=r.prototype,o.prototype=new o.Prototype,o.prototype.constructor=o,e.exports=o},{"../composite":17,"substance-application":62,"substance-util":139,underscore:144}],44:[function(t,e){"use strict";e.exports={Model:t("./table"),View:t("./table_view")}},{"./table":45,"./table_view":46}],45:[function(t,e){var n=t("underscore"),r=t("substance-document").Node,i=function(t,e){r.call(this,t,e)};i.type={id:"table",parent:"content",properties:{source_id:"string",label:"string",content:"string",footers:["array","string"],caption:"caption"}},i.config={zoomable:!0},i.description={name:"Table",remarks:["A table figure which is expressed in HTML notation"],properties:{source_id:"string",label:"Label shown in the resource header.",title:"Full table title",content:"HTML data",footers:"Table footers expressed as an array strings",caption:"References a caption node, that has all the content"}},i.example={id:"table_1",type:"table",label:"Table 1.",title:"Lorem ipsum table",content:"<table>...</table>",footers:[],caption:"caption_1"},i.Prototype=function(){this.getCaption=function(){return this.properties.caption?this.document.get(this.properties.caption):void 0}},i.Prototype.prototype=r.prototype,i.prototype=new i.Prototype,i.prototype.constructor=i;var o={header:{get:function(){return this.properties.label}}};n.each(i.type.properties,function(t,e){o[e]={get:function(){return this.properties[e]}}}),Object.defineProperties(i.prototype,o),e.exports=i},{"substance-document":73,underscore:144}],46:[function(t,e){"use strict";var n=t("underscore"),r=t("substance-util"),i=(r.html,t("../node").View),o=t("substance-application").$$,s=function(t,e){i.call(this,t),this.viewFactory=e,this.$el.attr({id:t.id}),this.$el.addClass("content-node table")};s.Prototype=function(){this.render=function(){var t=this.node;i.prototype.render.call(this);var e=o(".table-wrapper",{html:t.content});this.content.appendChild(e);var r=o(".footers",{children:n.map(t.footers,function(t){return o(".footer",{html:"<b>"+t.label+"</b> "+t.content})})}),s=this.node.getCaption();if(s){var a=this.viewFactory.createView(s),c=a.render().el;this.content.appendChild(c)}return this.content.appendChild(r),this}},s.Prototype.prototype=i.prototype,s.prototype=new s.Prototype,e.exports=s},{"../node":36,"substance-application":62,"substance-util":139,underscore:144}],47:[function(t,e){"use strict";var n=t("substance-nodes"),r=n.text,i=t("./text_view_patch");i(r.View),e.exports=r},{"./text_view_patch":48,"substance-nodes":84}],48:[function(t,e){function n(t){t.prototype.createAnnotationElement=a,t.prototype.renderWithAnnotations=c}var r=t("substance-document"),i=r.Annotator,o=t("substance-application").$$,s={link:1,cross_reference:1,definition_reference:1,figure_reference:1,person_reference:1,contributor_reference:1,citation_reference:1,strong:2,emphasis:2,code:2,subscript:2,superscript:2,underline:2,author_callout:3,inline_image:3,label:3,custom:3},a=function(t){var e;if("link"===t.type)e=o("a.annotation."+t.type,{id:t.id,href:this.node.document.get(t.id).url});else if("author_callout"===t.type){var n=this.node.document.get(t.id);e=o("span.annotation."+n.style,{id:t.id})}else e="inline_image"===t.type?o("img.annotation."+t.type,{id:t.id,src:this.node.document.get(t.id).url}):"custom"===t.type?o("span.annotation."+this.node.document.get(t.id).name,{id:t.id}):o("span.annotation."+t.type,{id:t.id});return e},c=function(t){var e=this,n=this.property.get(),r=document.createDocumentFragment(),o=new i.Fragmenter({levels:s});o.onText=function(t,e){t.appendChild(document.createTextNode(e))},o.onEnter=function(t,n){var r=e.createAnnotationElement(t);return n.appendChild(r),r},o.start(r,n,t),this.content.innerHTML="",this.content.appendChild(r)};e.exports=n},{"substance-application":62,"substance-document":73}],49:[function(t,e){"use strict";e.exports={Model:t("./video"),View:t("./video_view")}},{"./video":50,"./video_view":51}],50:[function(t,e){var n=t("underscore"),r=t("substance-document").Node,i=function(t,e){r.call(this,t,e)};i.type={id:"video",parent:"content",properties:{source_id:"string",label:"string",url:"string",url_webm:"string",url_ogv:"string",caption:"caption",poster:"string"}},i.config={zoomable:!0},i.description={name:"Video",remarks:["A video type intended to refer to video resources.","MP4, WebM and OGV formats are supported."],properties:{label:"Label shown in the resource header.",url:"URL to mp4 version of the video.",url_webm:"URL to WebM version of the video.",url_ogv:"URL to OGV version of the video.",poster:"Video poster image.",caption:"References a caption node, that has all the content"}},i.example={id:"video_1",type:"video",label:"Video 1.",url:"http://cdn.elifesciences.org/video/eLifeLensIntro2.mp4",url_webm:"http://cdn.elifesciences.org/video/eLifeLensIntro2.webm",url_ogv:"http://cdn.elifesciences.org/video/eLifeLensIntro2.ogv",poster:"http://cdn.elifesciences.org/video/eLifeLensIntro2.png",caption:"caption_25"},i.Prototype=function(){},i.Prototype.prototype=r.prototype,i.prototype=new i.Prototype,i.prototype.constructor=i;var o={};n.each(i.type.properties,function(t,e){o[e]={get:function(){return this.properties[e]}}}),Object.defineProperties(i.prototype,n.extend(o,{header:{get:function(){return this.properties.label}},caption:{get:function(){return this.properties.caption?this.document.get(this.properties.caption):""}}})),e.exports=i},{"substance-document":73,underscore:144}],51:[function(t,e){"use strict";var n=(t("underscore"),t("substance-util")),r=(n.html,t("../node").View),i=t("substance-application").$$,o=function(t,e){r.call(this,t,e),this.$el.attr({id:t.id}),this.$el.addClass("content-node video")};o.Prototype=function(){this.render=function(){r.prototype.render.call(this);var t=this.node,e=[i("source",{src:t.url,type:"video/mp4; codecs=&quot;avc1.42E01E, mp4a.40.2&quot;"})];t.url_ogv&&e.push(i("source",{src:t.url_ogv,type:"video/ogg; codecs=&quot;theora, vorbis&quot;"})),t.url_webm&&e.push(i("source",{src:t.url_webm,type:"video/webm; codecs=&quot;vp8, vorbis%quot;"}));var n=i(".video-wrapper",{children:[i("video",{controls:"controls",poster:t.poster,preload:"none",children:e})]});if(this.content.appendChild(n),t.title&&this.content.appendChild(i(".title",{text:t.title})),this.node.caption){var o=this.viewFactory.createView(this.node.caption);this.content.appendChild(o.render().el),this.captionView=o}return t.doi&&this.content.appendChild(i(".doi",{children:[i("b",{text:"DOI: "}),i("a",{href:t.doi,target:"_new",text:t.doi})]})),this}},o.Prototype.prototype=r.prototype,o.prototype=new o.Prototype,e.exports=o},{"../node":36,"substance-application":62,"substance-util":139,underscore:144}],52:[function(t,e){"use strict";var n=t("substance-nodes");e.exports=n.webresource},{"substance-nodes":84}],53:[function(t,e){"use strict";var n=t("./src/lens_converter");e.exports=n},{"./src/lens_converter":59}],54:[function(t,e){var n=(t("underscore"),function(){});n.Prototype=function(){this.enhanceSupplement=function(){},this.enhanceTable=function(){},this.enhanceCover=function(){},this.getBaseURL=function(t){var e=t.xmlDoc.querySelector("article").getAttribute("xml:base");return e||t.options.baseURL},this.enhanceVideo=function(t,e,n){var r=(n.querySelector("media")||n,n.getAttribute("xlink:href"));if(r.match(/http:/)){var i=r.lastIndexOf("."),o=r.substring(0,i);return e.url=o+".mp4",e.url_ogv=o+".ogv",e.url_webm=o+".webm",void(e.poster=o+".png")}var s=this.getBaseURL(t),o=r.split(".")[0];e.url=s+o+".mp4",e.url_ogv=s+o+".ogv",e.url_webm=s+o+".webm",e.poster=s+o+".png"},this.enhanceFigure=function(t,e,n){var r=n.querySelector("graphic"),i=r.getAttribute("xlink:href");e.url=this.resolveURL(t,i)},this.enhanceArticle=function(){},this.extractPublicationInfo=function(){},this.resolveURL=function(t){return t},this.resolveURL=function(t,e){return e.match(/http:/)?e:[t.options.baseURL,e].join("")}},n.prototype=new n.Prototype,e.exports=n},{underscore:144}],55:[function(t,e){"use strict";var n=t("substance-util"),r=t("underscore"),i=t("./default"),o=function(){};o.Prototype=function(){this.enhanceCover=function(t,e,n){var r=n.querySelector("subj-group[subj-group-type=display-channel] subject").textContent;try{var i=n.querySelector("subj-group[subj-group-type=heading] subject").textContent}catch(o){var i=null}e.breadcrumbs=[{name:"eLife",url:"http://elifesciences.org/",image:"http://lens.elifesciences.org/lens-elife/styles/elife.png"},{name:r,url:"http://elifesciences.org/category/"+r.replace(/ /g,"-").toLowerCase()}],i&&e.breadcrumbs.push({name:i,url:"http://elifesciences.org/category/"+i.replace(/ /g,"-").toLowerCase()})},this.enhanceFigure=function(t,e,n){var r=n.querySelector("graphic"),i=r.getAttribute("xlink:href");e.url=this.resolveURL(t,i)},this.enhanceVideo=function(t,e,n){var r=(n.querySelector("media")||n,n.getAttribute("xlink:href").split(".")),i=r[0];e.url="http://static.movie-usa.glencoesoftware.com/mp4/10.7554/"+i+".mp4",e.url_ogv="http://static.movie-usa.glencoesoftware.com/ogv/10.7554/"+i+".ogv",e.url_webm="http://static.movie-usa.glencoesoftware.com/webm/10.7554/"+i+".webm",e.poster="http://static.movie-usa.glencoesoftware.com/jpg/10.7554/"+i+".jpg"},this.resolveURL=function(t,e){if(e.match(/http:\/\//))return e;var n=this.getBaseURL(t);return n?[n,e].join(""):["http://cdn.elifesciences.org/elife-articles/",t.doc.id,"/jpg/",e,".jpg"].join("")},this.enhanceSupplement=function(t,e){var n=this.getBaseURL(t);return n?[n,e.url].join(""):void(e.url=["http://cdn.elifesciences.org/elife-articles/",t.doc.id,"/suppl/",e.url].join(""))},this.extractPublicationInfo=function(t,e,i){function o(t){if(!t)return null;var e=t.querySelector("day").textContent,n=t.querySelector("month").textContent,r=t.querySelector("year").textContent;return[r,n,e].join("-")}var s=e.doc,a={id:"articleinfo",type:"paragraph",children:[]},c=a.children,u=i.querySelectorAll("meta-value"),l=u[1];if(l){var p={type:"heading",id:e.nextId("heading"),level:3,content:"Impact"};s.create(p),c.push(p.id);var h=t.paragraphGroup(e,l);c.push(h[0].id)}var d=i.querySelector("contrib[contrib-type=editor]");if(d){var f=[],g=t.getName(d.querySelector("name"));g&&f.push(g);var m=d.querySelector("institution");m&&f.push(m.textContent);var y=d.querySelector("country");y&&f.push(y.textContent);var p={type:"heading",id:e.nextId("heading"),level:3,content:"Reviewing Editor"};s.create(p),c.push(p.id);var v={type:"text",id:e.nextId("text"),content:f.join(", ")};s.create(v),c.push(v.id)}for(var b=i.querySelectorAll("sec"),w=0;w<b.length;w++){var x=b[w],_=x.getAttribute("sec-type");if("datasets"===_){var p={type:"heading",id:e.nextId("heading"),level:3,content:"Major Datasets"};s.create(p),c.push(p.id);for(var C=t.datasets(e,n.dom.getChildren(x)),P=0;P<C.length;P++)C[P]&&c.push(C[P])}}var S=i.querySelector("ack");if(S){var p={type:"heading",id:e.nextId("heading"),level:3,content:"Acknowledgements"};s.create(p),c.push(p.id);var h=t.bodyNodes(e,n.dom.getChildren(S));c.push(h[0].id)}var N=i.querySelector("permissions");if(N){var p={type:"heading",id:e.nextId("heading"),level:3,content:"Copyright and License"};s.create(p),c.push(p.id);var k=N.querySelector("copyright-statement");if(k){var h=t.paragraphGroup(e,k),A=h[0].children[0];s.nodes[A].content+=". ",c.push(h[0].id)}for(var E=N.querySelector("license"),T=n.dom.getChildren(E),w=0;w<T.length;w++){var $=T[w],_=n.dom.getNodeType($);if("p"===_||"license-p"===_){var h=t.paragraphGroup(e,$);c.push(h[0].id)}}}s.create(a);var V=i.querySelector("article-meta"),I=V.querySelector("pub-date"),O=V.querySelector("date[date-type=received]"),j=V.querySelector("date[date-type=accepted]"),L=V.querySelectorAll("kwd-group[kwd-group-type=author-keywords] kwd"),R=V.querySelectorAll("kwd-group[kwd-group-type=research-organism] kwd"),q=V.querySelectorAll("subj-group[subj-group-type=heading] subject"),M=V.querySelector("subj-group[subj-group-type=display-channel] subject"),F=i.querySelector("journal-title"),D=i.querySelector("article-id[pub-id-type=doi]"),U=i.querySelector("self-uri[content-type=pdf]"),B=["http://cdn.elifesciences.org/elife-articles/",e.doc.id,"/pdf/",U?U.getAttribute("xlink:href"):"#"].join(""),H=i.querySelector("related-article"),G=[];B&&G.push({url:B,name:"PDF",type:"pdf"}),G.push({url:"https://s3.amazonaws.com/elife-cdn/elife-articles/"+e.doc.id+"/elife"+e.doc.id+".xml",name:"Source XML",type:"xml"}),G.push({url:"",name:"Lens JSON",type:"json"});var J={id:"publication_info",type:"publication_info",published_on:o(I),received_on:o(O),accepted_on:o(j),keywords:r.pluck(L,"textContent"),research_organisms:r.pluck(R,"textContent"),subjects:r.pluck(q,"textContent"),article_type:M?M.textContent:"",journal:F?F.textContent:"",related_article:H?["http://dx.doi.org/",H.getAttribute("xlink:href")].join(""):"",doi:D?["http://dx.doi.org/",D.textContent].join(""):"",article_info:a.id,links:G};s.create(J),s.show("info",J.id,0)},this.enhanceInfo=function(){},this.enhanceArticle=function(t,e,r){var i=[],o=r.querySelector("#SA1");if(o){var s={id:e.nextId("heading"),type:"heading",level:1,content:"Article Commentary"};doc.create(s),i.push(s);var s={id:e.nextId("heading"),type:"heading",level:2,content:"Decision letter"};doc.create(s),i.push(s);var a=o.querySelector("body");i=i.concat(t.bodyNodes(e,n.dom.getChildren(a)))}var c=r.querySelector("#SA2");if(c){var s={id:e.nextId("heading"),type:"heading",level:2,content:"Author response"};doc.create(s),i.push(s);var a=c.querySelector("body");i=i.concat(t.bodyNodes(e,n.dom.getChildren(a)))}i.length>0&&t.show(e,i),this.enhanceInfo(t,e,r)}},o.Prototype.prototype=i.prototype,o.prototype=new o.Prototype,o.prototype.constructor=o,e.exports=o},{"./default":54,"substance-util":139,underscore:144}],56:[function(t,e){var n=t("./default"),r=function(){};r.Prototype=function(){{var t={CC:"cc",INTV:"intravital",CIB:"cib"};n.prototype}this.enhanceSupplement=function(e,n,r){var i=r.querySelector("graphic, media")||r,o=i.getAttribute("xlink:href"),s=e.xmlDoc.querySelector("journal-id").textContent,o=["https://www.landesbioscience.com/journals/",t[s],"/",o].join("");n.url=o},this.enhanceVideo=function(t,e){e.url="provide_url_here"},this.enhanceFigure=function(e,n,r){var i=r.querySelector("graphic"),o=i.getAttribute("xlink:href"),s=e.xmlDoc.querySelector("journal-id").textContent,o=["https://www.landesbioscience.com/article_figure/journals/",t[s],"/",o].join("");if(n.url=o,!n.label){var a=n.type;n.label=a.charAt(0).toUpperCase()+a.slice(1)}}},r.Prototype.prototype=n.prototype,r.prototype=new r.Prototype,r.prototype.constructor=r,e.exports=r},{"./default":54}],57:[function(t,e){var n=t("./default"),r=function(){};r.Prototype=function(){this.enhanceFigure=function(t,e,n){var r=n.querySelector("graphic"),i=r.getAttribute("xlink:href");e.url=i},this.enhanceVideo=function(t,e){e.url="http://mickey.com/mouse.mp4"}},r.Prototype.prototype=n.prototype,r.prototype=new r.Prototype,r.prototype.constructor=r,e.exports=r},{"./default":54}],58:[function(t,e){var n=t("./default"),r=function(){};r.Prototype=function(){this.enhanceFigure=function(t,e,n){var r=n.querySelector("graphic"),i=r.getAttribute("xlink:href");i=["http://www.plosone.org/article/fetchObject.action?uri=",i,"&representation=PNG_L"].join(""),e.url=i},this.enhanceVideo=function(t,e){e.url="http://mickey.com/mouse.mp4"}},r.Prototype.prototype=n.prototype,r.prototype=new r.Prototype,r.prototype.constructor=r,e.exports=r},{"./default":54}],59:[function(t,e){"use strict";var n=t("underscore"),r=t("substance-util"),i=r.errors,o=i.define("ImporterError"),s=t("./configurations/elife"),a=t("./configurations/landes"),c=t("./configurations/default"),u=t("./configurations/plos"),l=t("./configurations/peerj"),p=function(t){this.options=t||{}};p.Prototype=function(){var e=function(t){if(!t)return"N/A";var e=[],n=t.querySelector("surname"),r=t.querySelector("given-names"),i=t.querySelector("suffix");return r&&e.push(r.textContent),n&&e.push(n.textContent),i?[e.join(" "),i.textContent].join(", "):e.join(" ")};this.getName=e;var i=function(t){if(!t)return"";var e=document.createElement("DIV");return e.appendChild(t.cloneNode(!0)),e.innerHTML};this.import=function(t,e){var r;if(n.isString(t)){var i=new DOMParser;r=i.parseFromString(t,"text/xml")}else r=t;var o=this.createDocument();window.doc=o;var s=new p.State(r,o,e);return this.document(s,r)},this.createDocument=function(){var e=t("lens-article"),n=new e;return n};var h={box:"content",supplement:"figures",figure:"figures",table:"figures",video:"figures"};this.show=function(t,e){var r=t.doc;n.each(e,function(t){var e=h[t.type]||"content";r.show(e,t.id)})},this.extractCover=function(t,e){var r=t.doc,i=r.get("document"),o={id:"cover",type:"cover",title:i.title,authors:[],"abstract":i.abstract};n.each(i.authors,function(e){var n=r.get(e),i={id:"text_"+e+"_reference",type:"text",content:n.name};r.create(i),o.authors.push(i.id);var s={id:t.nextId("contributor_reference"),type:"contributor_reference",path:["text_"+e+"_reference","content"],range:[0,n.name.length],target:e};r.create(s)},this),t.config.enhanceCover(t,o,e),r.create(o),r.show("content",o.id,0)},this.contribGroup=function(t,e){var n,r=e.querySelectorAll("aff");for(n=0;n<r.length;n++)this.affiliation(t,r[n]);var i=e.querySelectorAll("contrib");for(n=0;n<i.length;n++)this.contributor(t,i[n]);var o=t.doc,s=e.querySelector("on-behalf-of");s&&(o.on_behalf_of=s.textContent.trim())},this.affiliation=function(t,e){var n=t.doc,r=e.querySelector("institution"),i=e.querySelector("country"),o=e.querySelector("label"),s=e.querySelector("addr-line named-content[content-type=department]"),a=e.querySelector("addr-line named-content[content-type=city]"),c={id:t.nextId("affiliation"),type:"affiliation",source_id:e.getAttribute("id"),label:o?o.textContent:null,department:s?s.textContent:null,city:a?a.textContent:null,institution:r?r.textContent:null,country:i?i.textContent:null};n.create(c)},this.contributor=function(t,r){function i(i){var o=[],s=t.xmlDoc.querySelectorAll("xref[rid="+i+"]");return n.each(s,function(t){var n=t.parentNode;n!==r&&o.push(e(n.querySelector("name")))}),o}var o=t.doc,s=t.nextId("contributor"),a={id:s,source_id:r.getAttribute("id"),type:"contributor",name:"",affiliations:[],fundings:[],image:"",deceased:!1,emails:[],contribution:"",members:[]};"yes"===r.getAttribute("deceased")&&(a.deceased=!0);var c=r.querySelector("uri[content-type=orcid]");c&&(a.orcid=c.getAttribute("xlink:href"));var u=r.querySelector("name");if(u)a.name=e(u);else{var l=r.querySelector("collab");a.name=l?l.textContent:"N/A";var p=r.querySelector("xref[ref-type=other]");if(p){var h=p.getAttribute("rid"),d=t.xmlDoc.querySelectorAll("#"+h+" contrib");a.members=n.map(d,function(t){return e(t.querySelector("name"))})}}var f=[],g=r.querySelectorAll("xref"),m=[];n.each(g,function(e){if("aff"===e.getAttribute("ref-type")){var n=e.getAttribute("rid"),r=o.getNodeBySourceId(n);r&&a.affiliations.push(r.id)}else if("other"===e.getAttribute("ref-type")){var s=t.xmlDoc.getElementById(e.getAttribute("rid"));if(!s)return;var c=s.querySelector("funding-source");if(!c)return;var u=s.querySelector("award-id");u=u?", "+u.textContent:"";var l=c.childNodes[0].textContent;a.fundings.push([l,u].join(""))}else if("corresp"===e.getAttribute("ref-type")){var p=t.xmlDoc.getElementById(e.getAttribute("rid"));if(!p)return;var h=p.querySelector("email");if(!h)return;a.emails.push(h.textContent)}else if("fn"===e.getAttribute("ref-type")){var d=t.xmlDoc.getElementById(e.getAttribute("rid"));d&&"con"===d.getAttribute("fn-type")?a.contribution=d.textContent:d&&"conflict"===d.getAttribute("fn-type")?m.push(d.textContent.trim()):d&&"present-address"===d.getAttribute("fn-type")?a.present_address=d.querySelector("p").textContent:d&&"equal"===d.getAttribute("fn-type")?f=i(d.getAttribute("id")):d&&"other"===d.getAttribute("fn-type")&&d.getAttribute("id").indexOf("equal-contrib")>=0&&(f=i(d.getAttribute("id")))}}),a.equal_contrib=f,m.length>1&&(m=n.filter(m,function(t){return t.indexOf("no competing")<0})),a.competing_interests=m,"author"===r.getAttribute("contrib-type")&&o.nodes.document.authors.push(s),o.create(a),o.show("info",a.id)};var d={bold:"strong",italic:"emphasis",monospace:"code",sub:"subscript",sup:"superscript",underline:"underline","ext-link":"link",xref:"","named-content":""};this.isAnnotation=function(t){return void 0!==d[t]};var f=/author-callout-style/;this.createAnnotation=function(t,e,r,i){var o=e.tagName.toLowerCase(),s={path:n.last(t.stack).path,range:[r,i]};if("xref"===o){var a=e.getAttribute("ref-type"),c=e.getAttribute("rid");s.type="bibr"===a?"citation_reference":"fig"===a||"table"===a||"supplementary-material"===a||"other"===a?"figure_reference":"cross_reference",c&&(s.target=c.split(" ")[0])}else if("named-content"===o){var u=e.getAttribute("content-type");if(!f.test(u))return;s.type="author_callout",s.style=u}else{if(void 0===d[o])return void console.log("Ignoring annotation: ",o,e);s.type=d[o],"ext-link"===o&&(s.url=e.getAttribute("xlink:href"),"doi"===e.getAttribute("ext-link-type")&&(s.url=["http://dx.doi.org/",s.url].join("")))}s.id=t.nextId(s.type),t.annotations.push(s)},this.annotatedText=function(t,e,n,i){var s="";for(void 0===n&&(n=0);e.hasNext();){var a=e.next();if(a.nodeType===Node.TEXT_NODE){var c=t.acceptText(a.textContent);s+=c,n+=c.length}else{var u=r.dom.getNodeType(a);if(!this.isAnnotation(u)){if(i)throw new o("Node not yet supported in annoted text: "+u);e.back();break}var l=n,p=new r.dom.ChildNodeIterator(a),h=this.annotatedText(t,p,n,"nested");s+=h,n+=h.length,t.ignoreAnnotations||this.createAnnotation(t,a,l,n)}}return s},this.document=function(t,e){var r=e.querySelector("publisher-name").textContent;t.config="Landes Bioscience"===r?new a:"eLife Sciences Publications, Ltd"===r?new s:"Public Library of Science"===r?new u:"PeerJ Inc."===r?new l:new c;var i=t.doc,p=e.querySelector("article");if(!p)throw new o("Expected to find an 'article' element.");this.article(t,p);for(var h=0;h<t.annotations.length;h++){var d=t.annotations[h];if(d.target){var f=t.doc.getNodeBySourceId(d.target);f&&(d.target=f.id)}i.create(t.annotations[h])}return n.each(i.views,function(t){i.get(t).rebuild()}),i},this.extractContributors=function(t,e){var n=e.querySelector("article-meta contrib-group");n&&this.contribGroup(t,n)},this.extractFigures=function(t,e){for(var n,i=e.querySelectorAll("fig, table-wrap, supplementary-material, media[mimetype=video]"),o=[],s=0;s<i.length;s++){var a=i[s],c=r.dom.getNodeType(a);"fig"===c?(n=this.figure(t,a),n&&o.push(n)):"table-wrap"===c?(n=this.tableWrap(t,a),n&&o.push(n)):"media"===c?(n=this.video(t,a),n&&o.push(n)):"supplementary-material"===c&&(n=this.supplement(t,a),n&&o.push(n))}o.length>0&&this.show(t,o)},this.extractCitations=function(t,e){var n=e.querySelector("ref-list");n&&this.refList(t,n)},this.figure=function(t,e){var n=t.doc,r=e.querySelector("label"),i={type:"figure",id:t.nextId("figure"),source_id:e.getAttribute("id"),label:r?r.textContent:"Figure",url:"http://images.wisegeek.com/young-calico-cat.jpg",caption:null},o=e.querySelector("caption");if(o){var s=this.caption(t,o);s&&(i.caption=s.id)}var a=e.querySelector("attrib");return a&&(i.attrib=a.textContent),t.config.enhanceFigure(t,i,e),n.create(i),i},this.supplement=function(t,e){var n=t.doc,r=e.querySelector("label"),i=e.querySelector("media"),o=i?i.getAttribute("xlink:href"):null,s=e.querySelector("object-id[pub-id-type='doi']");s=s?"http://dx.doi.org/"+s.textContent:"";var a={id:t.nextId("supplement"),source_id:e.getAttribute("id"),type:"supplement",label:r?r.textContent:"",url:o,caption:null},c=e.querySelector("caption");if(c){var u=this.caption(t,c);u&&(a.caption=u.id)}return t.config.enhanceSupplement(t,a,e),n.create(a),a},this.caption=function(t,e){var r=t.doc,i=e.querySelector("title"),o=n.select(e.querySelectorAll("p"),function(t){return t.parentNode===e});if(0===o.length)return null;var s={id:t.nextId("caption"),source_id:e.getAttribute("id"),type:"caption",title:"",children:[]};if(i){var a=this.paragraph(t,i);a&&(s.title=a.id)}var c=[];return n.each(o,function(e){var n=this.paragraph(t,e);n&&c.push(n.id)},this),s.children=c,r.create(s),s},this.video=function(t,e){var n=t.doc,r=e.querySelector("label").textContent,i=t.nextId("video"),o={id:i,source_id:e.getAttribute("id"),type:"video",label:r,title:"",caption:null,poster:""},s=e.querySelector("caption");if(s){var a=this.caption(t,s);a&&(o.caption=a.id)}return t.config.enhanceVideo(t,o,e),n.create(o),o},this.tableWrap=function(t,e){var n=t.doc,r=e.querySelector("label"),o={id:t.nextId("table"),source_id:e.getAttribute("id"),type:"table",title:"",label:r?r.textContent:"Table",content:"",caption:null,footers:[]},s=e.querySelector("table");o.content=i(s);var a=e.querySelector("caption");if(a){var c=this.caption(t,a);c&&(o.caption=c.id)}return t.config.enhanceTable(t,o,e),n.create(o),o},this.article=function(t,e){var n=t.doc,i=e.querySelector("article-id");n.id=i?i.textContent:r.uuid(),this.extractContributors(t,e),this.extractCitations(t,e),this.extractFigures(t,e),this.extractCover(t,e),this.extractArticleMeta(t,e);var o=e.querySelector("body");o&&this.body(t,o),t.config.enhanceArticle(this,t,e)},this.extractArticleMeta=function(t,e){var r=e.querySelector("article-meta");if(!r)throw new o("Expected element: 'article-meta'");var i=r.querySelectorAll("article-id");this.articleIds(t,i);var s=r.querySelector("title-group");s&&this.titleGroup(t,s);var a=r.querySelectorAll("pub-date");this.pubDates(t,a);var c=r.querySelectorAll("abstract");n.each(c,function(e){this.abstract(t,e)},this),t.config.extractPublicationInfo(this,t,e)},this.articleIds=function(t,e){var n=t.doc;n.id=e.length>0?e[0].textContent:r.uuid()},this.titleGroup=function(t,e){var n=t.doc,r=e.querySelector("article-title");r&&(n.title=r.textContent)},this.pubDates=function(t,e){var n=t.doc;if(e.length>0){var r=this.pubDate(t,e[0]);n.created_at=r.date}},this.pubDate=function(t,e){var i=-1,o=-1,s=-1;n.each(r.dom.getChildren(e),function(t){var e=r.dom.getNodeType(t),n=t.textContent;"day"===e?i=parseInt(n,10):"month"===e?o=parseInt(n,10):"year"===e&&(s=parseInt(n,10))},this);var a=new Date(s,o,i);return{date:a}},this.abstract=function(t,e){var n=t.doc,i=[],o=e.querySelector("title"),s={id:t.nextId("heading"),type:"heading",level:1,content:o?o.textContent:"Abstract"};n.create(s),i.push(s),i=i.concat(this.bodyNodes(t,r.dom.getChildren(e))),i.length>0&&this.show(t,i)},this.body=function(t,e){var n=t.doc,i={id:t.nextId("heading"),type:"heading",level:1,content:"Main Text"};n.create(i);var o=[i].concat(this.bodyNodes(t,r.dom.getChildren(e)));o.length>0&&this.show(t,o)},this.bodyNodes=function(t,e,n){var i,o=[];n=n||0;for(var s=n;s<e.length;s++){var a=e[s],c=r.dom.getNodeType(a);"p"===c?o=o.concat(this.paragraphGroup(t,a)):"sec"===c?o=o.concat(this.section(t,a)):"list"===c?(i=this.list(t,a),i&&o.push(i)):"disp-formula"===c?(i=this.formula(t,a),i&&o.push(i)):"caption"===c?(i=this.caption(t,a),i&&o.push(i)):"boxed-text"===c?(i=this.boxedText(t,a),i&&o.push(i)):"disp-quote"===c&&(i=this.boxedText(t,a),i&&o.push(i))}return o},this.boxedText=function(t,e){var i=t.doc,o=this.bodyNodes(t,r.dom.getChildren(e)),s=e.querySelector("label"),a=t.nextId("box"),c={type:"box",id:a,source_id:e.getAttribute("id"),children:n.pluck(o,"id")};return i.create(c),s?(i.show("figures",a,-1),null):c},this.datasets=function(t,e){for(var n=[],i=0;i<e.length;i++){var o=e[i],s=r.dom.getNodeType(o);if("p"===s){var a=o.querySelector("related-object");if(a)n=n.concat(this.indivdata(t,a));else{var c=this.paragraphGroup(t,o);c.length>0&&n.push(c[0].id)}}}return n},this.indivdata=function(t,e){var n=t.doc,i={type:"paragraph",id:t.nextId("paragraph"),children:[]},o={type:"text",id:t.nextId("text"),content:""};
i.children.push(o.id);for(var s=r.dom.getChildren(e),a=0;a<s.length;a++){var c,u=s[a],l=r.dom.getNodeType(u);if("name"===l)for(var p=r.dom.getChildren(u),h=0;h<p.length;h++){var d=p[h];if(0===h)c=this.paragraphGroup(t,d),i.children.push(c[0].children[0]);else{var f={type:"text",id:t.nextId("text"),content:", "};n.create(f),i.children.push(f.id),c=this.paragraphGroup(t,d),i.children.push(c[0].children[0])}}else c=this.paragraphGroup(t,u),c&&c[0]&&c[0].children&&i.children.push(c[0].children[0])}return n.create(i),n.create(o),i.id},this.section=function(t,e){t.sectionLevel++;var n=t.doc,i=r.dom.getChildren(e),o=i[0];t.ignoreAnnotations=!0;var s=new r.dom.ChildNodeIterator(o),a=this.annotatedText(t,s);t.ignoreAnnotations=!1;var c={id:t.nextId("heading"),source_id:e.getAttribute("id"),type:"heading",level:t.sectionLevel,content:a};n.create(c);var u=this.bodyNodes(t,i,1);return u.unshift(c),t.sectionLevel--,u},this.ignoredParagraphElements={comment:!0,"supplementary-material":!0,fig:!0,"fig-group":!0,"table-wrap":!0,media:!0},this.acceptedParagraphElements={"boxed-text":{handler:"boxedText"},list:{handler:"list"},"disp-formula":{handler:"formula"}},this.inlineParagraphElements={"inline-graphic":!0,"inline-formula":!0},this.segmentParagraphElements=function(t){for(var e=[],i="",o=new r.dom.ChildNodeIterator(t);o.hasNext();){var s=o.next(),a=r.dom.getNodeType(s);this.ignoredParagraphElements[a]||("text"===a||this.isAnnotation(a)||this.inlineParagraphElements[a]?("paragraph"!==i&&(e.push({handler:"paragraph",nodes:[]}),i="paragraph"),n.last(e).nodes.push(s)):(this.acceptedParagraphElements[a]&&e.push(n.extend({node:s},this.acceptedParagraphElements[a])),i=a))}return e},this.paragraphGroup=function(t,e){for(var n=[],r=this.segmentParagraphElements(e),i=0;i<r.length;i++){var o,s=r[i];"paragraph"===s.handler?(o=this.paragraph(t,s.nodes),o&&(o.source_id=e.getAttribute("id"))):o=this[s.handler](t,s.node),o&&n.push(o)}return n},this.paragraph=function(t,e){for(var i=t.doc,o={id:t.nextId("paragraph"),type:"paragraph",children:null},s=[],a=new r.dom.ChildNodeIterator(e);a.hasNext();){var c=a.next(),u=r.dom.getNodeType(c);if("text"===u||this.isAnnotation(u)){var l={id:t.nextId("text"),type:"text",content:null};t.stack.push({node:l,path:[l.id,"content"]});var p=this.annotatedText(t,a.back(),0);p.length>0&&(l.content=p,i.create(l),s.push(l)),t.stack.pop()}else if("inline-graphic"===u){var h=c.getAttribute("xlink:href"),d={id:t.nextId("image"),type:"image",url:t.config.resolveURL(t,h)};i.create(d),s.push(d)}else if("inline-formula"===u){var f=this.formula(t,c,"inline");f&&s.push(f)}}return 0===s.length?null:(o.children=n.map(s,function(t){return t.id}),i.create(o),o)},this.list=function(t,e){var n=t.doc,i={id:t.nextId("list"),source_id:e.getAttribute("id"),type:"list",items:[],ordered:!1};"ordered"===e.getAttribute("list-type")&&(i.ordered=!0);for(var o=e.querySelectorAll("list-item"),s=0;s<o.length;s++)for(var a=o[s],c=this.bodyNodes(t,r.dom.getChildren(a),0),u=0;u<c.length;u++)i.items.push(c[u].id);return n.create(i),i};var g=function(t,e){for(var n=r.dom.getChildren(t),o=0;o<n.length;o++){var s=n[o],a=r.dom.getNodeType(s);if("mml:math"===a)return e||s.setAttribute("display","block"),{format:"mathml",data:i(s)};if("tex-math"===a)return{format:"latex",data:s.textContent}}return null};this.formula=function(t,e,n){var r=t.doc,i=t.nextId(n?"inline_formula":"formula"),o={id:i,source_id:e.getAttribute("id"),type:"formula",label:"",data:"",format:""};n&&(o.inline=!0);var s=e.querySelector("label");s&&(o.label=s.textContent);var a=g(e,n);return a?(o.format=a.format,o.data=a.data,r.create(o),o):null},this.refList=function(t,e){for(var n=e.querySelectorAll("ref"),r=0;r<n.length;r++)this.ref(t,n[r])},this.ref=function(t,e){for(var n=r.dom.getChildren(e),i=0;i<n.length;i++){var o=n[i],s=r.dom.getNodeType(o);"mixed-citation"===s||"element-citation"===s?this.citation(t,e,o):"label"===s||console.error("Not supported in 'ref': ",s)}},this.citation=function(t,n,r){var i,o,s=t.doc,a=t.nextId("article_citation"),c=r.querySelector("person-group");if(!c)return void console.error("FIXME: there is one of those 'mixed-citation' without any structure. Skipping ...",r);i={id:a,source_id:n.getAttribute("id"),type:"citation",title:"N/A",label:"",authors:[],doi:"",source:"",volume:"",fpage:"",lpage:"",citation_urls:[]};var u=c.querySelectorAll("name");for(o=0;o<u.length;o++)i.authors.push(e(u[o]));var l=c.querySelectorAll("collab");for(o=0;o<l.length;o++)i.authors.push(l[o].textContent);var p=r.querySelector("source");p&&(i.source=p.textContent);var h=r.querySelector("article-title");if(h)i.title=h.textContent;else{var d=r.querySelector("comment");d?i.title=d.textContent:p?i.title=p.textContent:console.error("FIXME: this citation has no title",r)}var f=r.querySelector("volume");f&&(i.volume=f.textContent);var g=r.querySelector("publisher-loc");g&&(i.publisher_location=g.textContent);var m=r.querySelector("publisher-name");m&&(i.publisher_name=m.textContent);var y=r.querySelector("fpage");y&&(i.fpage=y.textContent);var v=r.querySelector("lpage");v&&(i.lpage=v.textContent);var b=r.querySelector("year");b&&(i.year=b.textContent);var w=n.querySelector("label");w&&(i.label=w.textContent);var x=r.querySelector("pub-id[pub-id-type='doi'], ext-link[ext-link-type='doi']");x&&(i.doi="http://dx.doi.org/"+x.textContent),s.create(i),s.show("citations",a)}},p.State=function(t,e,n){this.xmlDoc=t,this.doc=e,this.options=n||{},this.annotations=[],this.stack=[],this.sectionLevel=1;var r={};this.nextId=function(t){return r[t]=r[t]||0,r[t]++,t+"_"+r[t]};var i=/^\s+/g,o=/^\s*/g,s=/\s+$/g,a=/\s+/g,c=" ",u=/[\t\n\r]+/g;this.lastChar="",this.acceptText=function(t){return this.options.TRIM_WHITESPACES?(t=t.replace(u,""),t=this.lastChar===c?t.replace(o,""):t.replace(i,c),t=t.replace(s,c),this.options.REMOVE_INNER_WS&&(t=t.replace(a,c)),this.lastChar=t[t.length-1]||this.lastChar,t):t}},p.prototype=new p.Prototype,e.exports={Importer:p}},{"./configurations/default":54,"./configurations/elife":55,"./configurations/landes":56,"./configurations/peerj":57,"./configurations/plos":58,"lens-article":4,"substance-util":139,underscore:144}],60:[function(t,e){"use strict";var n=t("./outline");e.exports=n},{"./outline":61}],61:[function(t,e){"use strict";var n=t("substance-application").View,r=t("substance-application").$$,i=t("underscore"),o=function(t){n.call(this),this.surface=t,this.state={selectedNode:null,highlightedNodes:[]},this.$el.addClass("lens-outline"),i.bindAll(this,"mouseDown","mouseUp","mouseMove","updateVisibleArea"),this.$el.mousedown(this.mouseDown),$(window).mousemove(this.mouseMove),$(window).mouseup(this.mouseUp)};o.Prototype=function(){this.render=function(){var t=this,e=0,n=document.createDocumentFragment();this.visibleArea=r(".visible-area"),n.appendChild(this.visibleArea);var o=this.surface.$(".nodes").height(),s=this.surface.$el.height(),a=o/s;this.factor=a;var c=this.surface.doc.container,u=c.getTopLevelNodes();i.each(u,function(t){var r=this.surface.$("#"+t.id),i=r.outerHeight(!0)/a,o=$('<div class="node">').attr({id:"outline_"+t.id}).css({position:"absolute",height:i-1,top:e}).addClass(t.type).append('<div class="arrow">');n.appendChild(o[0]),e+=i},this);var l=t.surface.$el.scrollTop();return t.el.innerHTML="",t.el.appendChild(n),t.updateVisibleArea(l),this},this.updateVisibleArea=function(t){$(this.visibleArea).css({top:t/this.factor,height:this.surface.$el.height()/this.factor})},this.update=function(t){this.render(),this.state=t,this.$(".node").removeClass("selected").removeClass("highlighted"),this.$el.removeClass("figures").removeClass("citations"),this.$el.addClass(t.context),this.$("#outline_"+t.selectedNode).addClass("selected"),i.each(t.highlightedNodes,function(t){this.$("#outline_"+t).addClass("highlighted")},this)},this.mouseDown=function(t){this._mouseDown=!0;var e=t.pageY;return t.target!==this.visibleArea?(this.offset=$(this.visibleArea).height()/2,this.mouseMove(t)):this.offset=e-$(this.visibleArea).position().top,!1},this.mouseUp=function(){this._mouseDown=!1},this.mouseMove=function(t){if(this._mouseDown){var e=t.pageY,n=(e-this.offset)*this.factor;this.surface.$el.scrollTop(n)}}},o.Prototype.prototype=n.prototype,o.prototype=new o.Prototype,e.exports=o},{"substance-application":62,underscore:144}],62:[function(t,e){"use strict";var n=t("./src/application");n.View=t("./src/view"),n.Router=t("./src/router"),n.Controller=t("./src/controller"),n.ElementRenderer=t("./src/renderers/element_renderer"),n.$$=n.ElementRenderer.$$,e.exports=n},{"./src/application":63,"./src/controller":64,"./src/renderers/element_renderer":65,"./src/router":66,"./src/view":67}],63:[function(t,e){"use strict";var n=t("./view"),r=t("./router"),i=(t("substance-util"),t("underscore")),o=function(t){n.call(this),this.config=t};o.Prototype=function(){this.initRouter=function(){this.router=new r,i.each(this.config.routes,function(t){this.router.route(t.route,t.name,i.bind(this.controller[t.command],this.controller))},this),r.history.start()},this.start=function(){this.$el=$("body"),this.el=this.$el[0],this.render(),this.initRouter()}},o.Prototype.prototype=n.prototype,o.prototype=new o.Prototype,e.exports=o},{"./router":66,"./view":67,"substance-util":139,underscore:144}],64:[function(t,e){"use strict";var n=t("substance-util"),r=t("underscore"),i=function(){this.state={},this.context=null};i.Prototype=function(){this.updateState=function(t,e){console.error("updateState is deprecated, use modifyState. State is now a rich object where context replaces the old state variable");var n=this.context;this.context=t,this.state=e,this.trigger("state-changed",this.context,n,e)},this.modifyState=function(t){var e=this.state.context;r.extend(this.state,t),t.context&&t.context!==e&&this.trigger("context-changed",t.context),this.trigger("state-changed",this.state.context)}},i.Prototype.prototype=n.Events,i.prototype=new i.Prototype,e.exports=i},{"substance-util":139,underscore:144}],65:[function(t,e){"use strict";var n=t("substance-util"),r=t("substance-regexp"),i=function(t){return this.attributes=t,this.tagName=t.tag,this.children=t.children||[],this.text=t.text||"",this.html=t.html,delete t.children,delete t.text,delete t.html,delete t.tag,this.render()};i.Prototype=function(){this.render=function(){var t=document.createElement(this.tagName);this.html?t.innerHTML=this.html:t.textContent=this.text;for(var e in this.attributes){var n=this.attributes[e];t.setAttribute(e,n)}for(var r=0;r<this.children.length;r++){var i=this.children[r];t.appendChild(i)}return this.el=t,t}};var o=function(t,e){var e=e||{},n=/^([a-zA-Z0-9]*)/.exec(t);e.tag=n&&n[1]?n[1]:"div";var o=/#([a-zA-Z0-9_]*)/.exec(t);o&&o[1]&&(e.id=o[1]);var s=new r(/\.([a-zA-Z0-9_-]*)/g);return e.class||(e.class=s.match(t).map(function(t){return t.match[1]}).join(" ")),new i(e)};i.$$=o,i.Prototype.prototype=n.Events,i.prototype=new i.Prototype,e.exports=i},{"substance-regexp":133,"substance-util":139}],66:[function(t,e){"use strict";var n=t("substance-util"),r=t("underscore"),i=function(t){t||(t={}),t.routes&&(this.routes=t.routes),this._bindRoutes(),this.initialize.apply(this,arguments)},o=/\((.*?)\)/g,s=/(\(\?)?:\w+/g,a=/\*\w+/g,c=/[\-{}\[\]+?.,\\\^$|#\s]/g;r.extend(i.prototype,n.Events,{initialize:function(){},route:function(t,e,n){r.isRegExp(t)||(t=this._routeToRegExp(t)),r.isFunction(e)&&(n=e,e=""),n||(n=this[e]);var o=this;return i.history.route(t,function(r){var s=o._extractParameters(t,r);n&&n.apply(o,s),o.trigger.apply(o,["route:"+e].concat(s)),o.trigger("route",e,s),i.history.trigger("route",o,e,s)}),this},navigate:function(t,e){return i.history.navigate(t,e),this},_bindRoutes:function(){if(this.routes){this.routes=r.result(this,"routes");for(var t,e=r.keys(this.routes);null!=(t=e.pop());)this.route(t,this.routes[t])}},_routeToRegExp:function(t){return t=t.replace(c,"\\$&").replace(o,"(?:$1)?").replace(s,function(t,e){return e?t:"([^/]+)"}).replace(a,"(.*?)"),new RegExp("^"+t+"$")},_extractParameters:function(t,e){var n=t.exec(e).slice(1);return r.map(n,function(t){return t?decodeURIComponent(t):null})}});var u=i.History=function(){this.handlers=[],r.bindAll(this,"checkUrl"),"undefined"!=typeof window&&(this.location=window.location,this.history=window.history)},l=/^[#\/]|\s+$/g,p=/^\/+|\/+$/g,h=/msie [\w.]+/,d=/\/$/;u.started=!1,r.extend(u.prototype,n.Events,{interval:50,getHash:function(t){var e=(t||this).location.href.match(/#(.*)$/);return e?e[1]:""},getFragment:function(t,e){if(null==t)if(this._hasPushState||!this._wantsHashChange||e){t=this.location.pathname;var n=this.root.replace(d,"");t.indexOf(n)||(t=t.substr(n.length))}else t=this.getHash();return t.replace(l,"")},start:function(t){if(u.started)throw new Error("Router.history has already been started");u.started=!0,this.options=r.extend({},{root:"/"},this.options,t),this.root=this.options.root,this._wantsHashChange=this.options.hashChange!==!1,this._wantsPushState=!!this.options.pushState,this._hasPushState=!!(this.options.pushState&&this.history&&this.history.pushState);var e=this.getFragment(),n=document.documentMode,i=h.exec(navigator.userAgent.toLowerCase())&&(!n||7>=n);this.root=("/"+this.root+"/").replace(p,"/"),i&&this._wantsHashChange&&(this.iframe=$('<iframe src="javascript:0" tabindex="-1" />').hide().appendTo("body")[0].contentWindow,this.navigate(e)),this._hasPushState?$(window).on("popstate",this.checkUrl):this._wantsHashChange&&"onhashchange"in window&&!i?$(window).on("hashchange",this.checkUrl):this._wantsHashChange&&(this._checkUrlInterval=setInterval(this.checkUrl,this.interval)),this.fragment=e;var o=this.location,s=o.pathname.replace(/[^\/]$/,"$&/")===this.root;return this._wantsHashChange&&this._wantsPushState&&!this._hasPushState&&!s?(this.fragment=this.getFragment(null,!0),this.location.replace(this.root+this.location.search+"#"+this.fragment),!0):(this._wantsPushState&&this._hasPushState&&s&&o.hash&&(this.fragment=this.getHash().replace(l,""),this.history.replaceState({},document.title,this.root+this.fragment+o.search)),this.options.silent?void 0:this.loadUrl())},stop:function(){$(window).off("popstate",this.checkUrl).off("hashchange",this.checkUrl),clearInterval(this._checkUrlInterval),u.started=!1},route:function(t,e){this.handlers.unshift({route:t,callback:e})},checkUrl:function(){var t=this.getFragment();return t===this.fragment&&this.iframe&&(t=this.getFragment(this.getHash(this.iframe))),t===this.fragment?!1:(this.iframe&&this.navigate(t),void(this.loadUrl()||this.loadUrl(this.getHash())))},loadUrl:function(t){var e=this.fragment=this.getFragment(t),n=r.any(this.handlers,function(t){return t.route.test(e)?(t.callback(e),!0):void 0});return n},navigate:function(t,e){if(!u.started)return!1;if(e&&e!==!0||(e={trigger:e}),t=this.getFragment(t||""),this.fragment!==t){this.fragment=t;var n=this.root+t;if(this._hasPushState)this.history[e.replace?"replaceState":"pushState"]({},document.title,n);else{if(!this._wantsHashChange)return this.location.assign(n);this._updateHash(this.location,t,e.replace),this.iframe&&t!==this.getFragment(this.getHash(this.iframe))&&(e.replace||this.iframe.document.open().close(),this._updateHash(this.iframe.location,t,e.replace))}e.trigger&&this.loadUrl(t)}},_updateHash:function(t,e,n){if(n){var r=t.href.replace(/(javascript:|#).*$/,"");t.replace(r+"#"+e)}else t.hash="#"+e}}),i.history=new u,e.exports=i},{"substance-util":139,underscore:144}],67:[function(t,e){"use strict";var n=t("substance-util"),r=function(){this.$el=$("<div/>"),this.el=this.$el[0],this.dispatchDOMEvents()};r.Prototype=function(){this.$=function(t){return this.$el.find(t)},this.dispatchDOMEvents=function(){function t(t){var e=/(\w+)\((.*)\)/.exec(t);if(!e)throw new Error("Invalid click handler '"+t+"'");return{method:e[1],args:e[2].split(",")}}var e=this;this.$el.delegate("[sbs-click]","click",function(n){var r=t($(n.currentTarget).attr("sbs-click")),i=e[r.method];return i?(i.apply(e,r.args),!1):void 0})}},r.Prototype.prototype=n.Events,r.prototype=new r.Prototype,e.exports=r},{"substance-util":139}],68:[function(t,e){"use strict";var n={};n.VERSION="0.8.0",n.Graph=t("./src/simple_graph"),e.exports=n},{"./src/simple_graph":72}],69:[function(t,e){var n=t("underscore"),r=t("substance-util"),i=function(t,e){e=e||{},this.graph=t,this.nodes={},this.scopes={},e.filter?this.filter=e.filter:e.types&&(this.filter=i.typeFilter(t.schema,e.types)),e.property&&(this.property=e.property),this.createIndex()};i.Prototype=function(){var t=function(t){var e=this;if(null!==t)for(var n=0;n<t.length;n++){var r=t[n];e.scopes[r]=e.scopes[r]||{nodes:{},scopes:{}},e=e.scopes[r]}return e},e=function(t){if(!this.property)return null;var e=t[this.property]?t[this.property]:null;return n.isString(e)&&(e=[e]),e},r=function(t){var e=n.extend({},t.nodes);return n.each(t.scopes,function(t,i){"nodes"!==i&&n.extend(e,r(t))}),e};this.onGraphChange=function(t){this.applyOp(t)},this._add=function(n){if(!this.filter||this.filter(n)){var r=e.call(this,n),i=t.call(this,r);i.nodes[n.id]=n.id}},this._remove=function(n){if(!this.filter||this.filter(n)){var r=e.call(this,n),i=t.call(this,r);delete i.nodes[n.id]}},this._update=function(e,r,i,o){if(this.property===r&&(!this.filter||this.filter(e))){var s=o;n.isString(s)&&(s=[s]);var a=t.call(this,s);delete a.nodes[e.id],s=i,a.nodes[e.id]=e.id}},this.applyOp=function(t){if("create"===t.type)this._add(t.val);else if("delete"===t.type)this._remove(t.val);else{var e,n=this.graph.resolve(this,t.path),r=n.get();if(void 0===r)return;"set"===t.type?e=t.original:console.error("Operational updates are not supported in this implementation"),this._update(n.node,n.key,r,e)}},this.createIndex=function(){this.reset();var r=this.graph.nodes;n.each(r,function(n){if(!this.filter||this.filter(n)){var r=e.call(this,n),i=t.call(this,r);i.nodes[n.id]=n.id}},this)},this.get=function(e){0===arguments.length?e=null:n.isString(e)&&(e=[e]);var i,o=t.call(this,e);return i=r(o),n.each(i,function(t){i[t]=this.graph.get(t)},this),i},this.reset=function(){this.nodes={},this.scopes={}},this.dispose=function(){this.stopListening()},this.rebuild=function(){this.reset(),this.createIndex()}},i.prototype=n.extend(new i.Prototype,r.Events.Listener),i.typeFilter=function(t,e){return function(n){for(var r=t.typeChain(n.type),i=0;i<e.length;i++)if(r.indexOf(e[i])>=0)return!0;return!1}},e.exports=i},{"substance-util":139,underscore:144}],70:[function(t,e){"use strict";var n=t("underscore"),r=function(t,e){if(!e)throw new Error("Illegal argument: path is null/undefined.");this.graph=t,this.schema=t.schema,n.extend(this,this.resolve(e))};r.Prototype=function(){this.resolve=function(t){for(var e,n,r=this.graph,i=r,o="graph",s=0;s<t.length;s++)if("graph"===o||void 0!==this.schema.types[o]){if(i=this.graph.get(t[s]),void 0===i)return void 0;r=i,o=this.schema.properties(i.type),n=r,e=void 0}else{if(void 0===i)return void 0;e=t[s];var a=t[s];o=o[a],n=i[e],s<t.length-1&&(i=i[a])}return{node:r,parent:i,type:o,key:e,value:n}},this.get=function(){return void 0!==this.key?this.parent[this.key]:this.node},this.set=function(t){if(void 0===this.key)throw new Error("'set' is only supported for node properties.");this.parent[this.key]=this.schema.parseValue(this.baseType,t)}},r.prototype=new r.Prototype,Object.defineProperties(r.prototype,{baseType:{get:function(){return n.isArray(this.type)?this.type[0]:this.type}},path:{get:function(){return[this.node.id,this.key]}}}),e.exports=r},{underscore:144}],71:[function(t,e){"use strict";var n=t("underscore"),r=t("substance-util"),i=function(t){n.extend(this,t)};i.Prototype=function(){this.defaultValue=function(t){return"object"===t?{}:"array"===t?[]:"string"===t?"":"number"===t?0:"boolean"===t?!1:"date"===t?new Date:null},this.parseValue=function(t,e){if(null===e)return e;if(n.isString(e)){if("object"===t)return JSON.parse(e);if("array"===t)return JSON.parse(e);if("string"===t)return e;if("number"===t)return parseInt(e,10);if("boolean"===t){if("true"===e)return!0;if("false"===e)return!1;throw new Error("Can not parse boolean value from: "+e)}return"date"===t?new Date(e):e}if("array"===t){if(!n.isArray(e))throw new Error("Illegal value type: expected array.");e=r.deepclone(e)}else if("string"===t){if(!n.isString(e))throw new Error("Illegal value type: expected string.")}else if("object"===t){if(!n.isObject(e))throw new Error("Illegal value type: expected object.");e=r.deepclone(e)}else if("number"===t){if(!n.isNumber(e))throw new Error("Illegal value type: expected number.")}else if("boolean"===t){if(!n.isBoolean(e))throw new Error("Illegal value type: expected boolean.")}else{if("date"!==t)throw new Error("Unsupported value type: "+t);e=new Date(e)}return e},this.type=function(t){return this.types[t]},this.typeChain=function(t){var e=this.types[t];if(!e)throw new Error("Type "+t+" not found in schema");var n=e.parent?this.typeChain(e.parent):[];return n.push(t),n},this.isInstanceOf=function(t,e){var n=this.typeChain(t);return n&&n.indexOf(e)>=0?!0:!1},this.baseType=function(t){return this.typeChain(t)[0]},this.properties=function(t){t=n.isObject(t)?t:this.type(t);var e=t.parent?this.properties(t.parent):{};return n.extend(e,t.properties),e},this.propertyType=function(t,e){var r=this.properties(t),i=r[e];if(!i)throw new Error("Property not found for"+t+"."+e);return n.isArray(i)?i:[i]},this.propertyBaseType=function(t,e){return this.propertyType(t,e)[0]}},i.prototype=new i.Prototype,e.exports=i},{"substance-util":139,underscore:144}],72:[function(t,e){"use strict";var n=t("underscore"),r=t("substance-util"),i=r.errors,o=t("./schema"),s=t("./property"),a=t("./graph_index"),c=i.define("GraphError"),u=["object","array","string","number","boolean","date"],l=function(t){return n.isArray(t)&&(t=t[0]),u.indexOf(t)>=0},p=function(t,e){if(e=e||{},this.schema=new o(t),this.schema.id&&e.seed&&e.seed.schema&&!n.isEqual(e.seed.schema,[this.schema.id,this.schema.version]))throw new c(["Graph does not conform to schema. Expected: ",this.schema.id+"@"+this.schema.version," Actual: ",e.seed.schema[0]+"@"+e.seed.schema[1]].join(""));this.nodes={},this.indexes={},this.__seed__=e.seed,this.init()};p.Prototype=function(){n.extend(this,r.Events),this.create=function(t){this.nodes[t.id]=t,this._updateIndexes({type:"create",path:[t.id],val:t})},this.delete=function(t){var e=this.nodes[t];delete this.nodes[t],this._updateIndexes({type:"delete",path:[t],val:e})},this.set=function(t,e){var n=this.resolve(t);if(!n)throw new c("Could not resolve property with path "+JSON.stringify(t));var r=n.get();n.set(e),this._updateIndexes({type:"set",path:t,val:e,original:r})},this.get=function(t){if(!n.isArray(t)&&!n.isString(t))throw new c("Invalid argument path. Must be String or Array");if(arguments.length>1&&(t=n.toArray(arguments)),n.isString(t))return this.nodes[t];var e=this.resolve(t);return e.get()},this.query=function(t){var e=this.resolve(t),n=e.type,r=e.baseType,i=e.get();return"array"===r?this._queryArray.call(this,i,n):l(r)?i:this.get(i)},this.toJSON=function(){return{id:this.id,schema:[this.schema.id,this.schema.version],nodes:r.deepclone(this.nodes)}},this.contains=function(t){return!!this.nodes[t]},this.resolve=function(t){return new s(this,t)},this.reset=function(){this.init(),this.trigger("graph:reset")},this.init=function(){this.__is_initializing__=!0,this.nodes=this.__seed__?r.clone(this.__seed__.nodes):{},n.each(this.indexes,function(t){t.reset()}),delete this.__is_initializing__},this.addIndex=function(t,e){if(this.indexes[t])throw new c("Index with name "+t+"already exists.");var n=new a(this,e);return this.indexes[t]=n,n},this.removeIndex=function(t){delete this.indexes[t]},this._updateIndexes=function(t){n.each(this.indexes,function(e){t?e.onGraphChange(t):e.rebuild()},this)},this._queryArray=function(t,e){if(!n.isArray(e))throw new c("Illegal argument: array types must be specified as ['array'(, 'array')*, <type>]");var r,i;if("array"===e[1])for(r=[],i=0;i<t.length;i++)r.push(this._queryArray(t[i],e.slice(1)));else if(l(e[1]))r=t;else for(r=[],i=0;i<t.length;i++)r.push(this.get(t[i]));return r}},p.STRICT_INDEXING=2,p.DEFAULT_MODE=p.STRICT_INDEXING,p.prototype=new p.Prototype,p.Schema=o,p.Property=s,p.Index=a,e.exports=p},{"./graph_index":69,"./property":70,"./schema":71,"substance-util":139,underscore:144}],73:[function(t,e){"use strict";var n=(t("underscore"),t("./src/document"));n.Annotator=t("./src/annotator"),n.Container=t("./src/container"),n.Cursor=t("./src/cursor"),n.Selection=t("./src/selection"),n.Controller=t("./src/controller"),n.Node=t("./src/node"),n.Composite=t("./src/composite"),n.TextNode=t("./src/text_node"),n.Writer=t("./src/controller"),e.exports=n},{"./src/annotator":74,"./src/composite":76,"./src/container":77,"./src/controller":78,"./src/cursor":79,"./src/document":80,"./src/node":81,"./src/selection":82,"./src/text_node":83,underscore:144}],74:[function(t,e){"use strict";var n=t("underscore"),r=t("substance-util"),i=(t("substance-data"),t("./document")),o=(t("./selection"),i.DocumentError),s=t("substance-operator"),a=function(t,e){e=e||{},this.document=t,this.document.on("operation:applied",this.handleOperation,this),this.group={emphasis:"style",strong:"style",link:"style",question:"marker",idea:"marker",error:"marker"},this.expansion={emphasis:{left:a.isOnNodeStart},strong:{left:a.isOnNodeStart}},this.splittable=["emphasis","strong"],this._index=a.createIndex(t),this.withTransformation=e.withTransformation};a.Prototype=function(){var t=function(t,e){for(var n=e.getNodes(),r={},i=0;i<n.length;i++){var o=n[i],s=[0,null];0===i&&(s[0]=e.startChar()),i===n.length-1&&(s[1]=e.endChar()),r[o.id]=s}return r},e=function(t,e,i,o,s){var a={id:r.uuid(),type:i,path:e,range:o};return s&&n.extend(a,s),t.create(a)},i=function(t,e){t.document.delete(e.id)},a=function(t,e,n){t.document.apply(s.ObjectOperation.Set([e.id,"range"],e.range,n))},c=function(t,e,r){var i=this._index.get(e);if(r){var o=r[0],s=r[1],a={};n.each(i,function(t){var e=t.range[0],n=t.range[1],r=n>=o;s&&(r&=s>=e),r&&(a[t.id]=t)}),i=a}return i},u=function(t,n,r){var o,s=n.range[0],c=r[0],u=n.range[1],l=r[1];if(s>=c&&l>=u)i(t,n);else if(s>=c&&u>l)o=[l,u],a(t,n,o);else if(c>s&&l>=u)o=[s,c],a(t,n,o);else if(t.isSplittable(n.type)){o=[s,c],a(t,n,o);var p=[l,u];e(t,n.path,n.type,p)}else i(t,n)};this.handleOperation=function(t){var e,r,o;if("delete"===t.type||"create"===t.type)e=this.document.schema.typeChain(t.val.type),e.indexOf("annotation")>=0?(o=t.val,this.triggerLater("annotation:changed",t.type,o)):"delete"===t.type&&(r=this._index.get(t.path),n.each(r,function(t){i(this,t)},this));else if("update"===t.type||"set"===t.type){var s=this.document.get(t.path[0]);if(void 0===s)return;if(e=this.document.schema.typeChain(s.type),e.indexOf("annotation")>=0){if("range"!==t.path[1])return;this.triggerLater("annotation:changed","update",s)}else this.withTransformation&&this.transform(t)}},this.create=function(t){return this.document.create(t),t};var l=function(t,e){if(n.isEqual(e.path,t.path))if("update"===t.type){var o=!1,a=!1,c=this.expansion[e.type];c&&(c.left&&(o=c.left(e)),c.right&&(a=c.right(e)));var u=r.clone(e.range),l=s.TextOperation.Range.transform(u,t.diff,o,a);l&&(u[0]===u[1]?i(this,e):this.document.set([e.id,"range"],u))}else("delete"===t.type||"set"===t.type)&&i(this,e)};this.transform=function(t){var e=this._index.get(t.path);n.each(e,function(e){l.call(this,t,e)},this)},this.paste=function(t,e,r){for(var i=0;i<t.length;i++){var o=t[i];void 0!==e&&(o.path=n.clone(o.path),o.path[0]=e),void 0!==r&&(o.range[0]+=r,o.range[1]+=r),this.create(o)}},this.copy=function(e){var i=t(this,e),o=this.getAnnotations({selection:e}),s=[];return n.each(o,function(t){var e,n=i[t.path[0]],o=n[0]>t.range[0]||n[1]<t.range[1];o?this.isSplittable(t.type)&&(e=r.clone(t),e.id=r.uuid(),e.range=[Math.max(0,t.range[0]-n[0]),t.range[1]-n[0]],s.push(e)):(e=r.clone(t),e.id=r.uuid(),e.range=[e.range[0]-n[0],e.range[1]-n[0]],s.push(e))},this),s},this.getAnnotations=function(t){t=t||{},t.view||(t.view="content");var e=this.document,r={};if(t.node)r=c.call(this,t.view,t.node,t.range);else if(t.selection)for(var i=t.selection,o=i.getRanges(),s=0;s<o.length;s++){var a=o[s];n.extend(r,c.call(this,t.view,a.node.id,[a.start,a.end]))}else n.each(e.nodes,function(t){var n=e.schema.baseType(t.type);"annotation"===n&&(r[t.id]=t)});if(t.filter){var u={};n.each(r,function(e){t.filter(e)&&(u[e.id]=e)}),r=u}return r},this.isExclusive=function(t,e){return this.group[t]===this.group[e]},this.isSplittable=function(t){return this.splittable.indexOf(t)>=0},this.annotate=function(t,r,s){var a=t.range(),c=t.cursor.node;if(a.start[0]!==a.end[0])throw new o("Multi-node annotations are not supported.");var l=[a.start[1],a.end[1]],p=this.getAnnotations({node:c.id,range:l});if(t.isCollapsed())n.each(p,function(t){t.type===r&&i(this,t)},this);else{var h=!1;if(n.each(p,function(t){this.isExclusive(r,t.type)&&(u(this,t,l),r===t.type&&(h=!0))},this),!h)return e(this,[c.id,"content"],r,l,s)}}},a.Prototype.prototype=r.Events,a.prototype=new a.Prototype,a.isOnNodeStart=function(t){return 0===t.range[0]},a.isTrue=function(){return!0},a.createIndex=function(t){if(void 0===t.indexes.annotations){var e={types:["annotation"],property:"path"},n=t.addIndex("annotations",e);n.ENABLE_LOGGING=!0,t.indexes.annotations=n}return t.indexes.annotations};var c={idea:1,question:1,error:1,link:1,strong:2,emphasis:2,code:2,subscript:2,superscript:2,underline:2,cross_reference:1,figure_reference:1,person_reference:1,contributor_reference:1,citation_reference:1},u=1,l=-1,p=function(t){this.levels=t.levels||c};p.Prototype=function(){var t=function(t,e){if(t.pos<e.pos)return-1;if(t.pos>e.pos)return 1;if(t.mode<e.mode)return-1;if(t.mode>e.mode)return 1;if(t.mode===u){if(t.level<e.level)return-1;if(t.level>e.level)return 1}if(t.mode===l){if(t.level>e.level)return-1;if(t.level<e.level)return 1}return 0},e=function(t){var e=[];return n.each(t,function(t){var n=this.levels[t.type];void 0!==n&&(e.push({pos:t.range[0],mode:u,level:n,id:t.id,type:t.type}),e.push({pos:t.range[1],mode:l,level:n,id:t.id,type:t.type}))},this),e};this.onText=function(){},this.onEnter=function(){return null},this.enter=function(t,e){return this.onEnter(t,e)},this.createText=function(t,e){this.onText(t,e)},this.start=function(n,r,i){var o=e.call(this,i);o.sort(t.bind(this));for(var s=[{context:n,entry:null}],a=0,c=0;c<o.length;c++){var p=o[c];this.createText(s[s.length-1].context,r.substring(a,p.pos)),a=p.pos;var h,d=1;if(p.mode===u){for(;d<s.length&&!(p.level<s[d].entry.level);d++);s.splice(d,0,{entry:p})}else if(p.mode===l){for(;d<s.length&&s[d].entry.id!==p.id;d++);s.splice(d,1)}for(h=d;h<s.length;h++)s[h].context=this.enter(s[h].entry,s[h-1].context)}this.createText(n,r.substring(a))}},p.prototype=new p.Prototype,a.Fragmenter=p,e.exports=a},{"./document":80,"./selection":82,"substance-data":68,"substance-operator":152,"substance-util":139,underscore:144}],75:[function(t,e){"use strict";var n=(t("underscore"),t("substance-util")),r=function(){};r.Prototype=function(){this.setContent=function(t){this.content=t},this.getContent=function(){return this.content}},r.Prototype.prototype=n.Events,r.prototype=new r.Prototype,e.exports=r},{"substance-util":139,underscore:144}],76:[function(t,e){var n=t("./node"),r=function(t,e){n.call(this,t,e)};r.type={id:"composite",parent:"content",properties:{}},r.description={name:"Composite",remarks:["A file reference to an external resource."],properties:{}},r.example={no_example:"yet"},r.Prototype=function(){this.getLength=function(){throw new Error("Composite.getLength() is abstract.")},this.getNodes=function(){throw new Error("Composite.getNodes() is abstract.")},this.isMutable=function(){return!1},this.insertOperation=function(){return null},this.deleteOperation=function(){return null},this.insertChild=function(){throw new Error("This composite is immutable.")},this.deleteChild=function(){throw new Error("This composite is immutable.")},this.getChangePosition=function(){return 0
}},r.Prototype.prototype=n.prototype,r.prototype=new r.Prototype,e.exports=r},{"./node":81}],77:[function(t,e){"use strict";var n=t("underscore"),r=t("substance-util"),i=t("./composite"),o=function(t,e){this.document=t,this.view=e,this.treeView=[],this.listView=[],this.__parents={},this.__composites={},this.rebuild()};o.Prototype=function(){var t=function(t,e){var n,r=[];for(n=this.treeView.length-1;n>=0;n--)r.unshift({id:this.treeView[n],parent:null});for(var o,s;r.length>0;){if(o=r.shift(),s=this.document.get(o.id),s instanceof i){var a=s.getNodes();for(n=a.length-1;n>=0;n--)r.unshift({id:a[n],parent:s.id})}t.call(e,s,o.parent)}};this.rebuild=function(){this.treeView.splice(0,this.treeView.length),this.listView.splice(0,this.listView.length),this.treeView=n.clone(this.view.nodes);for(var e=0;e<this.view.length;e++)this.treeView.push(this.view[e]);this.__parents={},this.__composites={},t.call(this,function(t,e){if(t instanceof i)this.__parents[t.id]=e,this.__composites[e]=e;else{if(this.listView.push(t.id),this.__parents[t.id])throw new Error("Nodes must be unique in one view.");this.__parents[t.id]=e,this.__composites[e]=e}},this)},this.getTopLevelNodes=function(){return n.map(this.treeView,function(t){return this.document.get(t)},this)},this.getNodes=function(t){var e=this.listView;if(t)return n.clone(e);for(var r=[],i=0;i<e.length;i++)r.push(this.document.get(e[i]));return r},this.getPosition=function(t){var e=this.listView;return e.indexOf(t)},this.getNodeFromPosition=function(t){var e=this.listView,n=e[t];return void 0!==n?this.document.get(n):null},this.getParent=function(t){return this.__parents[t]},this.getRoot=function(t){for(var e=t;e;)t=e,e=this.getParent(t);return t},this.update=function(t){var e=t.path,n=e[0]===this.view.id||void 0!==this.__composites[e[0]];n&&this.rebuild()},this.getLength=function(){return this.listView.length},this.hasSuccessor=function(t){var e=this.getLength();return e-1>t},this.hasPredecessor=function(t){return t>0},this.getPredecessor=function(t){var e=this.getPosition(t);return 0>=e?null:this.getNodeFromPosition(e-1)},this.getSuccessor=function(t){var e=this.getPosition(t);return e>=this.getLength()-1?null:this.getNodeFromPosition(e+1)},this.firstChild=function(t){if(t instanceof i){var e=this.document.get(t.getNodes()[0]);return this.firstChild(e)}return t},this.lastChild=function(t){if(t instanceof i){var e=this.document.get(n.last(t.getNodes()));return this.lastChild(e)}return t},this.before=function(t){var e=this.firstChild(t),n=this.getPosition(e.id);return[n,0]},this.after=function(t){var e=this.lastChild(t),n=this.getPosition(e.id),r=e.getLength();return[n,r]}},o.prototype=n.extend(new o.Prototype,r.Events.Listener),Object.defineProperties(o.prototype,{id:{get:function(){return this.view.id}},type:{get:function(){return this.view.type}},nodes:{get:function(){return this.view.nodes},set:function(t){this.view.nodes=t}}}),e.exports=o},{"./composite":76,"substance-util":139,underscore:144}],78:[function(t,e){"use strict";var n=t("underscore"),r=t("substance-util"),i=t("substance-operator"),o=t("./selection"),s=t("./annotator"),a=t("./clipboard"),c=t("./composite"),u=function(t,e){e=e||{},this.view=e.view||"content",this.__document=t,this.chronicle=t.chronicle,this.annotator=new s(t),this.container=t.get(this.view),this.selection=new o(this.container),this.clipboard=new a};u.Prototype=function(){this.getNodes=function(t){return this.container.getNodes(t)},this.getContainer=function(){return this.container},this.getPosition=function(t,e){return this.container.getPosition(t,e)},this.getNodeFromPosition=function(t){return this.container.getNodeFromPosition(t)},this.getAnnotations=function(t){return t=t||{},t.view=this.view,this.annotator.getAnnotations(t)},this.delete=function(t){var e=this.startManipulation(),n=e.sel,r=n.container;if(!n.isNull())if(n.isCollapsed()&&n.expand(t,"char"),e.deleteSelection(),e.save(),0===r.getLength())this.selection.clear();else{var i=r.listView.length;if(n.cursor.nodePos>=i){var o=r.getNodeFromPosition(i-1).getLength();this.selection.set([i-1,o])}else n.collapse("left"),this.selection.set(n)}},this.copy=function(){console.log("I am sorry. Currently disabled.")},this.cut=function(){this.copy(),this.delete()},this.paste=function(){console.log("I am sorry. Currently disabled.")},this.modifyNode=function(){this.breakNode()},this.breakNode=function(){if(this.selection.isNull())return void console.log("Can not write, as no position has been selected.");var t=this.startManipulation(),e=t.doc,n=t.sel,r=n.container;n.isCollapsed()||t.deleteSelection();var i=n.getNodes()[0],o=(n.start[0],n.start[1]);if(i.isBreakable()){var s,a=r.getParent(i.id);if(a){var c=e.get(a);if(c.isBreakable()){{c.getNodes()}s=c.break(e,i.id,o)}else console.log("Node type '"+c.type+"' is not splittable.")}else{s=i.break(e,o);var u=r.treeView.indexOf(i.id)+1;e.show(this.view,s.id,u)}}if(s){var l=r.before(s);n.set(l)}t.save(),this.selection.set(n)},this.insertNode=function(t,e){console.log("I am sorry. Currently disabled.",t,e)},this.annotate=function(t,e){return this.annotator.annotate(this.selection,t,e)},this.startManipulation=function(){var t=this.__document.startSimulation();new s(t,{withTransformation:!0});var e=new o(t.get(this.view),this.selection);return new u.ManipulationSession(t,e)},this.write=function(t){if(this.selection.isNull())return void console.log("Can not write, as no position has been selected.");var e=this.startManipulation(),n=e.doc,r=e.sel;r.isCollapsed()||e.deleteSelection();var i=r.getNodes()[0],o=r.start[0],s=r.start[1],a=i.insertOperation(s,t);a&&n.apply(a),e.save(),this.selection.set([o,s+t.length])},this.get=function(){return this.__document.get.apply(this.__document,arguments)},this.on=function(){return this.__document.on.apply(this.__document,arguments)},this.off=function(){return this.__document.off.apply(this.__document,arguments)};var t=function(t){function e(t){if("update"===t.type||"set"===t.type){var e=n.get(t.path[0]);if(!e)return void console.log("Hmmm... this.should not happen, though.");var i=-1,o=-1;return e instanceof c||e.getChangePosition&&(i=r.getPosition(e.id),o=e.getChangePosition(t)),i>=0&&o>=0?[i,o]:void 0}}if(t){var n=(this.view,this.__document),r=this.container;i.Helpers.each(t,function(t){var n=e(t);return n?(this.selection.set(n),!1):void 0},this,"reverse")}};this.undo=function(){var e=this.chronicle.rewind();t.call(this,e)},this.redo=function(){var e=this.chronicle.forward();t.call(this,e)},this.getDocument=function(){return this.__document}},u.prototype=n.extend(new u.Prototype,r.Events.Listener),Object.defineProperties(u.prototype,{id:{get:function(){return this.__document.id},set:function(){throw"immutable property"}},nodeTypes:{get:function(){return this.__document.nodeTypes},set:function(){throw"immutable property"}},title:{get:function(){return this.__document.get("document").title},set:function(){throw"immutable property"}},updated_at:{get:function(){return this.__document.get("document").updated_at},set:function(){throw"immutable property"}},creator:{get:function(){return this.__document.get("document").creator},set:function(){throw"immutable property"}}});var l=function(t,e){this.doc=t,this.sel=e,this.container=e.container,this.viewId=this.container.view.id};l.Prototype=function(){this.save=function(){this.doc.save()},this.join=function(t,e){var n=this.doc,r=this.container,i=n.get(t),o=n.get(e),s=r.getParent(t),a=r.getParent(e),c=s?n.get(s):null;if(!i.canJoin(o)||c&&!c.isMutable())return!1;i.join(n,o),this.deleteNode(o.id);var u=a?n.get(a):null;if(c&&u&&c.id!==u.id&&c.canJoin(u)&&r.getParent(s)!==a){var l=c.getNodes(),p=u.getNodes(),h=l.indexOf(t)+1;if(h===l.length){this.deleteNode(u.id);for(var d=0;d<p.length;d++)c.insertChild(n,h+d,p[d])}}return!0},this.deleteNode=function(t){var e=this.doc,n=this.container.getParent(t),r=n?e.get(n):null;n?(r.deleteChild(e,t),0===r.getLength()&&this.deleteNode(r.id)):(e.hide(this.viewId,t),e.delete(t))},this.deleteSelection=function(){function t(t){var e=n.clone(t.getNodes());for(r.deleteNode(t.id);e.length>0;){var o=e.shift();i.delete(o),p[o]=!0}p[t.id]=!0}function e(n){if(void 0===p[n.id]){var r=s.firstChild(n),o=l[r.id],a=s.lastChild(n),c=l[a.id];if(o&&c&&o.isFull()&&c.isFull()){var u=s.getParent(n.id);u&&e(i.get(u)),p[u]||t(n)}else p[n.id]=!1}return p[n.id]}var r=this,i=this.doc,o=this.sel,s=o.container,a=o.getRanges(),c=a.length>1&&!a[0].isFull()&&!n.last(a).isFull(),u=0,l={};for(u=0;u<a.length;u++)l[a[u].node.id]=a[u];var p={};for(u=0;u<a.length;u++){var h=a[u],d=h.node;if(!p[d.id])if(h.isFull()){var f=s.getParent(d.id);if(f&&e(i.get(f)),!p[f])if(0===h.node.getLength())this.deleteNode(d.id);else{var g=h.node.deleteOperation(h.start,h.end);g&&!g.isNOP()&&i.apply(g),u>0&&this.deleteNode(d.id)}}else{var g=h.node.deleteOperation(h.start,h.end);g&&!g.isNOP()&&i.apply(g)}}c&&this.join(a[0].node.id,a[a.length-1].node.id)}},l.prototype=new l.Prototype,u.ManipulationSession=l,e.exports=u},{"./annotator":74,"./clipboard":75,"./composite":76,"./selection":82,"substance-operator":152,"substance-util":139,underscore:144}],79:[function(t,e){var n=t("underscore"),r=(t("substance-regexp"),t("substance-util")),i=r.errors,o=i.define("CursorError"),s=function(t,e,r,i){if(this.container=t,this.view=i||"content",this.nodePos=e,this.charPos=r,null!==e&&!n.isNumber(e))throw new o("Illegal argument: expected nodePos as number");if(null!==r&&!n.isNumber(r))throw new o("Illegal argument: expected charPos as number")};s.Prototype=function(){this.copy=function(){return new s(this.container,this.nodePos,this.charPos,this.view)},this.isValid=function(){if(null===this.nodePos||null===this.charPos)return!1;if(this.nodePos<0||this.charPos<0)return!1;var t=this.container.getNodeFromPosition(this.nodePos);return t?this.charPos>=t.getLength()?!1:!0:!1},this.isRightBound=function(){return this.charPos===this.node.getLength()},this.isLeftBound=function(){return 0===this.charPos},this.isEndOfDocument=function(){return this.isRightBound()&&this.nodePos===this.container.getLength()-1},this.isBeginOfDocument=function(){return this.isLeftBound()&&0===this.nodePos},this.prevNode=function(){this.isLeftBound()?this.nodePos>0&&(this.nodePos-=1,this.charPos=this.node.length):this.charPos=0},this.nextNode=function(){this.isRightBound()?this.nodePos<this.container.getLength()-1&&(this.nodePos+=1,this.charPos=0):this.charPos=this.node.length},this.prevWord=function(){if(!this.node)throw new o("Invalid node position");if(this.isLeftBound())this.prevChar();else{if(!this.node.prevWord)return this.prevChar();this.charPos=this.node.prevWord(this.charPos)}},this.nextWord=function(){if(!this.node)throw new o("Invalid node position");this.isRightBound()?this.nextChar():this.node.nextWord?this.charPos=this.node.nextWord(this.charPos):this.nextChar()},this.nextChar=function(){if(!this.node)throw new o("Invalid node position");this.isRightBound()?this.nodePos<this.container.getLength()-1&&(this.nodePos+=1,this.charPos=0):this.charPos+=1},this.prevChar=function(){if(!this.node)throw new o("Invalid node position");if(this.charPos<0)throw new o("Invalid char position");this.isLeftBound()?this.nodePos>0&&(this.nodePos-=1,this.charPos=this.node.getLength()):this.charPos-=1},this.move=function(t,e){"left"===t?"word"===e?this.prevWord():"char"===e?this.prevChar():"node"===e&&this.prevNode():"word"===e?this.nextWord():"char"===e?this.nextChar():"node"===e&&this.nextNode()},this.set=function(t,e){if(this.nodePos=t,this.charPos=e,null!==t&&!n.isNumber(t))throw new o("Illegal argument: expected nodePos as number");if(null!==e&&!n.isNumber(e))throw new o("Illegal argument: expected charPos as number");if(null!==t){if(!n.isNumber(t))throw new o("Illegal argument: expected nodePos as number");var r=this.container.getLength();if(0>t||t>=r)throw new o("Invalid node position: "+t);var i=this.container.getNodeFromPosition(t),s=i.getLength();if(0>e||e>s)throw new o("Invalid char position: "+e)}},this.position=function(){return[this.nodePos,this.charPos]}},s.prototype=new s.Prototype,Object.defineProperties(s.prototype,{node:{get:function(){return this.container.getNodeFromPosition(this.nodePos)}}}),e.exports=s},{"substance-regexp":133,"substance-util":139,underscore:144}],80:[function(t,e){"use strict";var n=t("underscore"),r=t("substance-util"),i=r.errors,o=t("substance-data"),s=t("./container"),a=i.define("DocumentError"),c=function(t){o.Graph.call(this,t.schema,t),this.containers={}};c.schema={indexes:{},types:{content:{properties:{}},view:{properties:{nodes:["array","content"]}}}},c.Prototype=function(){var t=r.prototype(this);this.getIndex=function(t){return this.indexes[t]},this.getSchema=function(){return this.schema},this.create=function(e){return t.create.call(this,e),this.get(e.id)},this.get=function(e){var n=t.get.call(this,e);if(!n)return n;if("view"===n.type)return this.containers[n.id]||(this.containers[n.id]=new s(this,n)),this.containers[n.id];var r=this.nodeTypes[n.type],i=void 0!==r?r.Model:null;return!i||n instanceof i||(n=new i(n,this),this.nodes[n.id]=n),n},this.toJSON=function(){var e=t.toJSON.call(this);return e.id=this.id,e},this.hide=function(t,e){var r=this.get(t);if(!r)throw new a("Invalid view id: "+t);n.isString(e)&&(e=[e]);var i=[];if(n.each(e,function(t){var e=r.nodes.indexOf(t);e>=0&&i.push(e)},this),0!==i.length){i=i.sort().reverse(),i=n.uniq(i);for(var o=this.nodes[t],s=0;s<i.length;s++)o.nodes.slice(i[s],1)}},this.show=function(t,e,n){void 0===n&&(n=-1);var r=this.get(t);if(!r)throw new a("Invalid view id: "+t);var i=r.nodes.length;n=Math.min(n,i),0>n&&(n=Math.max(0,i+n+1)),r.nodes.splice(n,0,e)},this.fromSnapshot=function(t,e){return c.fromSnapshot(t,e)},this.uuid=function(t){return t+"_"+r.uuid()}},c.Prototype.prototype=o.Graph.prototype,c.prototype=new c.Prototype,c.fromSnapshot=function(t,e){return e=e||{},e.seed=t,new c(e)},c.DocumentError=a,e.exports=c},{"./container":77,"substance-data":68,"substance-util":139,underscore:144}],81:[function(t,e){"use strict";var n=t("underscore"),r=function(t,e){this.document=e,this.properties=t};r.type={parent:"content",properties:{}},r.properties={"abstract":!0,immutable:!0,mergeableWith:[],preventEmpty:!0,allowedAnnotations:[]},r.Prototype=function(){this.toJSON=function(){return n.clone(this.properties)},this.getLength=function(){throw new Error("Node.getLength() is abstract.")},this.getChangePosition=function(){throw new Error("Node.getCharPosition() is abstract.")},this.insertOperation=function(){throw new Error("Node.insertOperation() is abstract.")},this.deleteOperation=function(){throw new Error("Node.deleteOperation() is abstract.")},this.canJoin=function(){return!1},this.join=function(){throw new Error("Node.join() is abstract.")},this.isBreakable=function(){return!1},this.break=function(){throw new Error("Node.split() is abstract.")},this.getAnnotations=function(){return this.document.getIndex("annotations").get(this.properties.id)}},r.prototype=new r.Prototype,r.prototype.constructor=r,r.defineProperties=function(t,e,r){n.each(e,function(e){var n={get:function(){return this.properties[e]}};r||(n.set=function(t){return this.properties[e]=t,this}),Object.defineProperty(t,e,n)})},r.defineProperties(r.prototype,["id","type"]),e.exports=r},{underscore:144}],82:[function(t,e){"use strict";var n=t("underscore"),r=t("substance-util"),i=r.errors,o=t("./cursor"),s=i.define("SelectionError"),a=function(t,e){this.container=t,this.start=null,this.__cursor=new o(t,null,null),e&&this.set(e)};a.Prototype=function(){this.__node=function(t){return this.container.getNodeFromPosition(t)},this.copy=function(){var t=new a(this.container);return this.isNull()||t.set(this),t},this.set=function(t){var e=this.__cursor;t instanceof a?(this.start=n.clone(t.start),e.set(t.__cursor.nodePos,t.__cursor.charPos)):n.isArray(t)?(this.start=n.clone(t),e.set(t[0],t[1])):(this.start=n.clone(t.start),e.set(t.end[0],t.end[1]));var r=this.start,i=this.container.getLength();if(r[0]<0||r[0]>=i)throw new s("Invalid node position: "+r[0]);var o=this.__node(r[0]).getLength();if(r[1]<0||r[1]>o)throw new s("Invalid char position: "+r[1]);return this.trigger("selection:changed",this.range()),this},this.clear=function(){this.start=null,this.__cursor.set(null,null),this.trigger("selection:changed",null)},this.range=function(){if(this.isNull())return null;var t=this.start,e=this.__cursor.position();return this.isReverse()?{start:e,end:t}:{start:t,end:e}},this.isReverse=function(){var t=this.__cursor;return t.nodePos<this.start[0]||t.nodePos===this.start[0]&&t.charPos<this.start[1]},this.setCursor=function(t){return this.__cursor.set(t[0],t[1]),this.start=t,this},this.getCursor=function(){return this.__cursor.copy()},this.getCursorPosition=function(){return[this.__cursor.nodePos,this.__cursor.charPos]},this.selectNode=function(t){var e=this.container.getPosition(t);if(0>e)throw new s("Node is not visible: "+t);var n=this.container.getNodeFromPosition(e);this.set({start:[e,0],end:[e,n.getLength()]})},this.getPredecessor=function(){var t=this.isReverse()?this.__cursor.nodePos:this.start[0];return 0===t?null:this.__node(t-1)},this.getSuccessor=function(){var t=this.isReverse()?this.start[0]:this.__cursor.nodePos;return this.__node(t+1)},this.hasPredecessor=function(t){return t>0},this.hasSuccessor=function(t){var e=this.container.getLength();return e-1>t},this.collapse=function(t){if("right"!==t&&"left"!==t&&"start"!==t&&"cursor"!==t)throw new s("Invalid direction: "+t);if(!this.isCollapsed()&&!this.isNull()){if("start"===t)this.__cursor.set(this.start[0],this.start[1]);else if("cursor"===t)this.start[0]=this.__cursor.nodePos,this.start[1]=this.__cursor.charPos;else{var e=this.range();this.isReverse()?"left"===t?this.start=e.start:this.__cursor.set(e.end[0],e.end[1]):"left"===t?this.__cursor.set(e.start[0],e.start[1]):this.start=e.end}this.trigger("selection:changed",this.range())}},this.move=function(t,e){this.isCollapsed()||"char"!==e?(this.__cursor.move(t,e),this.start=this.__cursor.position()):this.collapse(t),this.trigger("selection:changed",this.range())},this.expand=function(t,e){this.__cursor.move(t,e),this.trigger("selection:changed",this.range())},this.toJSON=function(){return this.range()},this.getNodes=function(){var t=this.container.getNodes();if(this.isNull())return[];var e=this.range();return t.slice(e.start[0],e.end[0]+1)},this.getRanges=function(){for(var t=[],e=this.range(),r=e.start[0];r<=e.end[0];r++){var i=0,o=null;if(r===e.start[0]&&(i=e.start[1]),r===e.end[0]&&(o=e.end[1]),!n.isNumber(o)){var s=this.__node(r);o=s.getLength()}t.push(new a.Range(this,r,i,o))}return t},this.startNode=function(){return this.isReverse()?this.__cursor.nodePos:this.start[0]},this.endNode=function(){return this.isReverse()?this.start[0]:this.__cursor.nodePos},this.startChar=function(){return this.isReverse()?this.__cursor.charPos:this.start[1]},this.endChar=function(){return this.isReverse()?this.start[1]:this.__cursor.charPos},this.isNull=function(){return null===this.start},this.isCollapsed=function(){return this.start[0]===this.__cursor.nodePos&&this.start[1]===this.__cursor.charPos},this.hasMultipleNodes=function(){return!this.isNull()&&this.startNode()!==this.endNode()}},a.Prototype.prototype=r.Events,a.prototype=new a.Prototype,Object.defineProperties(a.prototype,{cursor:{get:function(){return this.__cursor.copy()},set:function(){throw"immutable property"}}});var c=function(t,e,n,r){this.selection=t,this.nodePos=e,this.node=t.__node(e),this.start=n,this.end=r};c.Prototype=function(){this.isFirst=function(){return this.nodePos===this.selection.startNode()},this.isLast=function(){return this.nodePos===this.selection.endNode()},this.hasPredecessor=function(){return!this.isFirst()},this.hasSuccessor=function(){return!this.isLast()},this.isEnclosed=function(){return this.hasPredecessor()&&this.hasSuccessor()},this.isRightBound=function(){return this.end===this.node.getLength()},this.isLeftBound=function(){return 0===this.start},this.length=function(){return this.end-this.start},this.content=function(){return this.node.content.slice(this.start,this.end)},this.isFull=function(){return this.isLeftBound()&&this.isRightBound()},this.isPartial=function(){return!this.isFull()}},c.prototype=new c.Prototype,a.Range=c,a.SelectionError=s,e.exports=a},{"./cursor":79,"substance-util":139,underscore:144}],83:[function(t,e){"use strict";var n=t("underscore"),r=t("substance-operator"),i=t("substance-regexp"),o=r.ObjectOperation,s=r.TextOperation,a=t("./node"),c=function(t,e){a.call(this,t,e)};c.type={id:"text",parent:"content",properties:{source_id:"Text element source id",content:"string"}},c.description={name:"Text",remarks:["A simple text fragement that can be annotated. Usually text nodes are combined in a paragraph."],properties:{content:"Content"}},c.example={type:"paragraph",id:"paragraph_1",content:"Lorem ipsum dolor sit amet, adipiscing elit."},c.Prototype=function(){this.getChangePosition=function(t){if("content"===t.path[1]){var e=r.Helpers.last(t.diff);if(e.isInsert())return e.pos+e.length();if(e.isDelete())return e.pos}return-1},this.getLength=function(){return this.properties.content.length},this.insertOperation=function(t,e){return o.Update([this.properties.id,"content"],s.Insert(t,e))},this.deleteOperation=function(t,e){var n=this.properties.content;return o.Update([this.properties.id,"content"],s.Delete(t,n.substring(t,e)),"string")},this.prevWord=function(t){var e=this.properties.content,r=new i(/\b\w/g).match(e),o=n.select(r,function(e){return e.index<t},this);return 0===o.length?0:n.last(o).index},this.nextWord=function(t){var e=this.properties.content,n=new i(/\w\b/g).match(e.substring(t));if(0===n.length)return e.length;var r=n[0];return t+r.index+1},this.canJoin=function(t){return t instanceof c},this.join=function(t,e){var r=this.properties.content.length,i=e.content;t.update([this.id,"content"],[r,i]);var o=t.indexes.annotations.get(e.id);n.each(o,function(e){t.set([e.id,"path"],[this.properties.id,"content"]),t.set([e.id,"range"],[e.range[0]+r,e.range[1]+r])},this)},this.isBreakable=function(){return!0},this.break=function(t,e){var r=this.properties.content.substring(e),i=this.toJSON();i.type=this.splitInto?this.splitInto:this.properties.type,i.id=t.uuid(this.properties.type),i.content=r,t.create(i);var o=t.indexes.annotations.get(this.properties.id);return n.each(o,function(n){n.range[0]>=e&&(t.set([n.id,"path"],[i.id,"content"]),t.set([n.id,"range"],[n.range[0]-e,n.range[1]-e]))}),t.update([this.properties.id,"content"],s.Delete(e,r)),i}},c.Prototype.prototype=a.prototype,c.prototype=new c.Prototype,c.prototype.constructor=c,a.defineProperties(c.prototype,["content"]),e.exports=c},{"./node":81,"substance-operator":152,"substance-regexp":133,underscore:144}],84:[function(t,e){"use strict";e.exports={node:t("./src/node"),composite:t("./src/composite"),text:t("./src/text"),paragraph:t("./src/paragraph"),heading:t("./src/heading"),list:t("./src/list"),codeblock:t("./src/codeblock"),webresource:t("./src/web_resource"),image:t("./src/image"),formula:t("./src/formula"),table:t("./src/table"),figure:t("./src/figure"),collaborator:t("./src/collaborator"),cover:t("./src/cover"),description:t("./src/description"),footnote:t("./src/footnote")}},{"./src/codeblock":87,"./src/collaborator":90,"./src/composite":93,"./src/cover":96,"./src/description":99,"./src/figure":102,"./src/footnote":105,"./src/formula":108,"./src/heading":111,"./src/image":114,"./src/list":115,"./src/node":118,"./src/paragraph":121,"./src/table":124,"./src/text":127,"./src/web_resource":130}],85:[function(t,e){"use strict";var n=t("../text/text_node"),r=function(t,e){n.call(this,t,e)};r.type={id:"codeblock",parent:"content",properties:{source_id:"string",content:"string"}},r.config={zoomable:!0},r.description={name:"Codeblock",remarks:["Text in a codeblock is displayed in a fixed-width font, and it preserves both spaces and line breaks"],properties:{content:"Content"}},r.example={type:"codeblock",id:"codeblock_1",content:'var text = "Sun";\nvar op1 = Operator.TextOperation.Delete(2, "n");\ntext = op2.apply(op1.apply(text));\nconsole.log(text);'},r.Prototype=function(){},r.Prototype.prototype=n.prototype,r.prototype=new r.Prototype,r.prototype.constructor=r,e.exports=r},{"../text/text_node":128}],86:[function(t,e){"use strict";var n=t("../text/text_view"),r=function(t){n.call(this,t),this.$el.addClass("content-node codeblock")};r.Prototype=function(){},r.Prototype.prototype=n.prototype,r.prototype=new r.Prototype,e.exports=r},{"../text/text_view":129}],87:[function(t,e){"use strict";e.exports={Model:t("./codeblock"),View:t("./codeblock_view")}},{"./codeblock":85,"./codeblock_view":86}],88:[function(t,e){var n=t("underscore"),r=t("substance-document").Node,i=function(t,e){r.call(this,t,e)};i.type={id:"collaborator",parent:"content",properties:{source_id:"string",name:"string",role:"string",organization:"string",image:"string",email:"string",contribution:"string"}},i.description={name:"Collaborator",remarks:["Describes an article collaborator such as an author or editor."],properties:{name:"Full name."}},i.example={id:"collaborator_1",type:"collaborator",role:"author",name:"John Doe",image:"http://john.com/doe.png",email:"a@b.com",contribution:"Revising the article, data cleanup"},i.Prototype=function(){this.getAffiliations=function(){return n.map(this.properties.affiliations,function(t){return this.document.get(t)},this)}},i.Prototype.prototype=r.prototype,i.prototype=new i.Prototype,i.prototype.constructor=i;var o={},o={header:{get:function(){return this.properties.name}}};n.each(i.type.properties,function(t,e){o[e]={get:function(){return this.properties[e]}}}),Object.defineProperties(i.prototype,o),e.exports=i},{"substance-document":73,underscore:144}],89:[function(t,e){"use strict";var n=(t("underscore"),t("substance-util")),r=(n.html,t("../node").View),i=t("substance-application").$$,o=function(t){r.call(this,t),this.$el.attr({id:t.id}),this.$el.addClass("content-node collaborator")};o.Prototype=function(){this.render=function(){return r.prototype.render.call(this),this.node.image&&this.content.appendChild(i(".image",{children:[i("img",{src:this.node.image})]})),this.node.organization&&this.content.appendChild(i(".organization",{text:this.node.organization})),this.node.contribution&&(this.content.appendChild(i(".label",{text:"Contribution"})),this.content.appendChild(i(".contribution",{text:this.node.contribution}))),this.node.email&&(this.content.appendChild(i(".label",{text:"Email"})),this.content.appendChild(i(".email",{children:[i("a",{href:"mailto:"+this.node.email,text:this.node.email})]}))),this}},o.Prototype.prototype=r.prototype,o.prototype=new o.Prototype,e.exports=o},{"../node":118,"substance-application":62,"substance-util":139,underscore:144}],90:[function(t,e){"use strict";e.exports={Model:t("./collaborator"),View:t("./collaborator_view")}},{"./collaborator":88,"./collaborator_view":89}],91:[function(t,e){"use strict";var n=t("substance-document");e.exports=n.Composite},{"substance-document":73}],92:[function(t,e){"use strict";var n=t("../node").View,r=function(t,e){n.call(this,t,e),this.$el.addClass(t.type),this.$el.attr("id",this.node.id),this.childrenViews=[]};r.Prototype=function(){this.render=function(){this.content=document.createElement("DIV"),this.content.classList.add("content");var t;for(t=0;t<this.childrenViews.length;t++)this.childrenViews[t].dispose();var e=this.node.getNodes();for(t=0;t<e.length;t++){var n=this.node.document.get(e[t]),r=this.viewFactory.createView(n);this.content.appendChild(r.render().el),this.childrenViews.push(r)}return this.el.appendChild(this.content),this},this.dispose=function(){n.prototype.dispose.call(this);for(var t=0;t<this.childrenViews.length;t++)this.childrenViews[t].dispose()},this.delete=function(){},this.getCharPosition=function(){return 0},this.getDOMPosition=function(){var t=this.$(".content")[0],e=document.createRange();return e.setStartBefore(t.childNodes[0]),e}},r.Prototype.prototype=n.prototype,r.prototype=new r.Prototype,e.exports=r},{"../node":118}],93:[function(t,e){"use strict";e.exports={Model:t("./composite"),View:t("./composite_view")}},{"./composite":91,"./composite_view":92}],94:[function(t,e){var n=t("underscore"),r=t("../node/node"),i=function(t,e){r.call(this,t,e)};i.type={id:"cover",parent:"content",properties:{source_id:"string",authors:["array","person_reference"],image:"string"}},i.description={name:"Cover",remarks:["Virtual view on the title and authors of the paper."],properties:{authors:"An array of references to collaborators"}},i.example={id:"cover",type:"cover",authors:["collaborator_reference_1","collaborator_reference_2"]},i.Prototype=function(){this.getAuthorRefs=function(){return n.map(this.properties.authors,function(t){return this.document.get(t)},this)}},i.Prototype.prototype=r.prototype,i.prototype=new i.Prototype,i.prototype.constructor=i,Object.defineProperties(i.prototype,{title:{get:function(){return this.document.title}},authors:{get:function(){return this.properties.authors}},image:{get:function(){return this.properties.image}}}),e.exports=i},{"../node/node":119,underscore:144}],95:[function(t,e){"use strict";var n=(t("underscore"),t("../node/node_view")),r=t("substance-application").$$,i=function(t,e){n.call(this,t,e),this.$el.attr({id:t.id}),this.$el.addClass("content-node cover")};i.Prototype=function(){this.render=function(){n.prototype.render.call(this);var t=this.node;this.node.document.published_on&&this.content.appendChild(r(".published-on",{html:new Date(this.node.document.published_on).toDateString()})),this.content.appendChild(r(".title",{text:t.title}));var e=this.node.getAuthorRefs();if(e){var i=document.createElement("DIV");i.classList.add("authors");for(var o,s=0;s<e.length;s++){var a=e[s],c=this.node.document.get(a.target);o=document.createElement("SPAN"),o.setAttribute("id",a.id),o.classList.add("annotation"),o.classList.add("person_reference"),o.innerHTML=c.name,i.appendChild(o)}this.content.appendChild(i)}return this.node.image&&(this.el.style.backgroundImage="url('"+this.node.image+"')"),this}},i.Prototype.prototype=n.prototype,i.prototype=new i.Prototype,e.exports=i},{"../node/node_view":120,"substance-application":62,underscore:144}],96:[function(t,e,n){arguments[4][23][0].apply(n,arguments)},{"./cover":94,"./cover_view":95,"/Users/michael/projects/elife/lens/node_modules/lens-article/nodes/cover/index.js":23}],97:[function(t,e){"use strict";var n=(t("underscore"),t("substance-document")),r=n.Node,i=n.Composite,o=function(t,e){i.call(this,t,e)};o.type={id:"description",parent:"content",properties:{source_id:"string",topic:"text",body:"paragraph"}},o.description={name:"Description",remarks:["A Description consists of two components: a topic and its textual description."],properties:{topic:"The entity to be described",body:"A paragraph containing content which describe the topic"}},o.example={type:"description",id:"description_1",topic:"text_1",body:"paragraph_2"},o.Prototype=function(){this.getLength=function(){return 2},this.getNodes=function(){return[this.properties.topic,this.properties.body]},this.getTopic=function(){return this.document.get(this.properties.topic)},this.getBody=function(){return this.document.get(this.properties.body)}},o.Prototype.prototype=i.prototype,o.prototype=new o.Prototype,o.prototype.constructor=o,r.defineProperties(o.prototype,["topic","body"]),e.exports=o},{"substance-document":73,underscore:144}],98:[function(t,e){"use strict";var n=t("../node").View,r=function(t,e){n.call(this,t,e),this.$el.addClass("description"),this.$el.attr("id",this.node.id)};r.Prototype=function(){this.render=function(){var t=document.createElement("div");t.className="content";var e=document.createElement("div");e.className="topic";var n=this.viewFactory.createView(this.node.getTopic());e.appendChild(n.render().el),this._topicEl=e;var r=document.createElement("div");r.className="body";var i=this.viewFactory.createView(this.node.getBody());
return r.appendChild(i.render().el),this._bodyEl=r,t.appendChild(e),t.appendChild(r),this.el.appendChild(t),this}},r.Prototype.prototype=n.prototype,r.prototype=new r.Prototype,e.exports=r},{"../node":118}],99:[function(t,e){"use strict";e.exports={Model:t("./description"),View:t("./description_view")}},{"./description":97,"./description_view":98}],100:[function(t,e){"use strict";var n=t("substance-document"),r=function(t,e){n.Composite.call(this,t,e)};r.type={id:"figure",parent:"content",properties:{url:"string",label:"string",caption:"paragraph"}},r.description={name:"Figure",remarks:["A figure is a figure is figure."],properties:{label:"Figure label (e.g. Figure 1)",url:"Image url",caption:"A reference to a paragraph that describes the figure"}},r.example={id:"figure_1",label:"Figure 1",url:"http://example.com/fig1.png",caption:"paragraph_1"},r.config={zoomable:!0},r.Prototype=function(){this.insertOperation=function(){return null},this.deleteOperation=function(){return null},this.hasCaption=function(){return!!this.properties.caption},this.getNodes=function(){var t=[];return this.properties.caption&&t.push(this.properties.caption),t},this.getCaption=function(){return this.properties.caption?this.document.get(this.properties.caption):void 0}},r.Prototype.prototype=n.Composite.prototype,r.prototype=new r.Prototype,r.prototype.constructor=r,r.create=function(t){var e={},n=t.id,r={id:n,type:"figure",label:t.label,url:t.url};if(t.caption){var i="caption_"+t.id,o={id:i,type:"text",content:t.caption};e[i]=o,r.caption=i}return e[n]=r,e},n.Node.defineProperties(r.prototype,["url","caption"]),Object.defineProperties(r.prototype,{header:{get:function(){return this.properties.label}}}),e.exports=r},{"substance-document":73}],101:[function(t,e){"use strict";var n=t("../composite").View,r=t("substance-application").$$,i=function(t,e){n.call(this,t,e)};i.Prototype=function(){this.render=function(){this.el.innerHTML="",this.content=r("div.content");var t=r(".image-wrapper",{children:[r("img",{src:this.node.url})]});this.content.appendChild(t);var e;for(e=0;e<this.childrenViews.length;e++)this.childrenViews[e].dispose();var n=this.node.getCaption();if(n){var i=this.viewFactory.createView(n),o=i.render().el;this.content.appendChild(o),this.childrenViews.push(i)}return this.el.appendChild(this.content),this}},i.Prototype.prototype=n.prototype,i.prototype=new i.Prototype,e.exports=i},{"../composite":93,"substance-application":62}],102:[function(t,e,n){arguments[4][29][0].apply(n,arguments)},{"./figure":100,"./figure_view":101,"/Users/michael/projects/elife/lens/node_modules/lens-article/nodes/figure/index.js":29}],103:[function(t,e){"use strict";var n=t("substance-document"),r=n.Node,i=t("../paragraph/paragraph"),o=function(t,e){i.call(this,t,e)};o.type={id:"footnote",parent:"paragraph",properties:{label:"string"}},o.description={name:"Footnote",remarks:["A Footnote is basically a Paragraph with a label."],properties:{label:"A string used as label"}},o.example={type:"footnote",id:"footnote_1",label:"a","children ":["text_1","image_1","text_2"]},o.Prototype=function(){},o.Prototype.prototype=i.prototype,o.prototype=new o.Prototype,o.prototype.constructor=o,r.defineProperties(o.prototype,["label"]),e.exports=o},{"../paragraph/paragraph":122,"substance-document":73}],104:[function(t,e){"use strict";var n=t("../paragraph/paragraph_view"),r=function(t,e){n.call(this,t,e)};r.Prototype=function(){this.render=function(){n.prototype.render.call(this);var t=document.createElement("span");return t.classList.add("label"),t.innerHTML=this.node.label,this.el.insertBefore(t,this.content),this}},r.Prototype.prototype=n.prototype,r.prototype=new r.Prototype,e.exports=r},{"../paragraph/paragraph_view":123}],105:[function(t,e){"use strict";e.exports={Model:t("./footnote"),View:t("./footnote_view")}},{"./footnote":103,"./footnote_view":104}],106:[function(t,e){var n=t("underscore"),r=t("substance-document").Node,i=function(t){r.call(this,t)};i.type={id:"formula",parent:"content",properties:{source_id:"string",label:"string",data:"string",format:"string",inline:"boolean"}},i.description={name:"Formula",remarks:["Can either be expressed in MathML format or using an image url"],properties:{label:"Formula label (4)",data:"Formula data, either MathML or image url",format:"Can either be `mathml` or `image`"}},i.example={type:"formula",id:"formula_eqn1",label:"(1)",content:"<mml:mrow>...</mml:mrow>",format:"mathml"},i.Prototype=function(){this.inline=!1},i.Prototype.prototype=r.prototype,i.prototype=new i.Prototype,i.prototype.constuctor=new i;var o={};n.each(i.type.properties,function(t,e){o[e]={get:function(){return this.properties[e]}}}),Object.defineProperties(i.prototype,o),e.exports=i},{"substance-document":73,underscore:144}],107:[function(t,e){"use strict";var n=t("../node").View,r=function(t){n.call(this,t),this.$el.attr({id:t.id}),this.$el.addClass("content-node formula"),this.node.inline&&this.$el.addClass("inline")};r.Prototype=function(){this.render=function(){var t=this.node.format;switch(t){case"mathml":this.$el.html(this.node.data);break;case"image":this.$el.append('<img src="'+this.node.url+'"/>');break;case"latex":this.$el.html(this.node.inline?"\\("+this.node.data+"\\)":"\\["+this.node.data+"\\]");break;default:console.error("Unknown formula format:",t)}return this.node.label&&this.$el.append($('<div class="label">').html(this.node.label)),this}},r.Prototype.prototype=n.prototype,r.prototype=new r.Prototype,e.exports=r},{"../node":118}],108:[function(t,e){"use strict";e.exports={Model:t("./formula"),View:t("./formula_view")}},{"./formula":106,"./formula_view":107}],109:[function(t,e){"use strict";var n=t("substance-document").Node,r=t("../text/text_node"),i=function(t,e){r.call(this,t,e)};i.type={id:"heading",parent:"content",properties:{source_id:"string",content:"string",level:"number"}},i.example={type:"heading",id:"heading_1",content:"Introduction",level:1},i.description={name:"Heading",remarks:["Denotes a section or sub section in your article."],properties:{content:"Heading content",level:"Heading level. Ranges from 1..4"}},i.Prototype=function(){this.splitInto="paragraph"},i.Prototype.prototype=r.prototype,i.prototype=new i.Prototype,i.prototype.constructor=i,n.defineProperties(i.prototype,["level"]),e.exports=i},{"../text/text_node":128,"substance-document":73}],110:[function(t,e){"use strict";var n=t("../text/text_view"),r=function(t){n.call(this,t),this.$el.addClass("heading"),this.$el.addClass("level-"+this.node.level),this.$el.attr("title","Click to set anchor. Great for sharing!")};r.Prototype=function(){},r.Prototype.prototype=n.prototype,r.prototype=new r.Prototype,e.exports=r},{"../text/text_view":129}],111:[function(t,e){"use strict";e.exports={Model:t("./heading"),View:t("./heading_view")}},{"./heading":109,"./heading_view":110}],112:[function(t,e){"use strict";var n=(t("substance-document").Node,t("../web_resource/web_resource")),r=function(t,e){n.call(this,t,e)};r.type={id:"image",parent:"webresource",properties:{source_id:"string"}},r.example={type:"image",id:"image_1",url:"http://substance.io/image_1.png"},r.description={name:"Image",remarks:["Represents a web-resource for an image."],properties:{}},r.Prototype=function(){},r.Prototype.prototype=n.prototype,r.prototype=new r.Prototype,r.prototype.constructor=r,e.exports=r},{"../web_resource/web_resource":131,"substance-document":73}],113:[function(t,e){"use strict";var n=t("../node").View,r=function(t,e){n.call(this,t,e),this.$el.addClass("image"),this.$el.attr("id",this.node.id)};r.Prototype=function(){var t=Array.prototype.indexOf;this.render=function(){var e=document.createElement("div");e.className="content";var n=document.createElement("div");n.className="image-char",this._imgChar=n;var r=document.createElement("img");return r.src=this.node.url,r.alt="alt text",r.title="alt text",n.appendChild(r),e.appendChild(n),this.el.appendChild(e),this._imgPos=t.call(n.childNodes,r),this},this.delete=function(t,e){for(var n=this.$(".content")[0],r=n.childNodes,i=e-1;i>=0;i--)n.removeChild(r[t+i])},this.getCharPosition=function(t,e){return t===this._imgChar?e>this._imgPos?1:0:void console.log("Errhhh..")},this.getDOMPosition=function(t){var e=this.$(".content")[0],n=document.createRange();return 0===t?n.setStartBefore(e.childNodes[0]):n.setStartAfter(e.childNodes[0]),n}},r.Prototype.prototype=n.prototype,r.prototype=new r.Prototype,e.exports=r},{"../node":118}],114:[function(t,e){"use strict";e.exports={Model:t("./image"),View:t("./image_view")}},{"./image":112,"./image_view":113}],115:[function(t,e){"use strict";e.exports={Model:t("./list"),View:t("./list_view")}},{"./list":116,"./list_view":117}],116:[function(t,e){"use strict";var n=t("underscore"),r=t("substance-document"),i=r.Node,o=r.Composite,s=function(t,e){o.call(this,t,e)};s.type={id:"list",parent:"content",properties:{source_id:"string",items:["array","paragraph"],ordered:"boolean"}},s.description={name:"List",remarks:["Lists can either be numbered or bullet lists"],properties:{ordered:"Specifies wheter the list is ordered or not",items:"An array of paragraph references"}},s.example={type:"list",id:"list_1","items ":["paragraph_listitem_1","paragraph_listitem_2"]},s.Prototype=function(){this.getLength=function(){return this.properties.items.length},this.getNodes=function(){return n.clone(this.items)},this.getItems=function(){return n.map(this.properties.items,function(t){return this.document.get(t)},this)},this.getChangePosition=function(t){if("items"===t.path[1])if("update"===t.type){var e=t.diff;if(e.isInsert())return t.diff.pos+1;if(e.isDelete())return t.diff.pos;if(e.isMove())return t.diff.target}else if("set"===t.type)return this.properties.items.length-1;return-1},this.isMutable=function(){return!0},this.insertChild=function(t,e,n){t.update([this.id,"items"],["+",e,n])},this.deleteChild=function(t,e){var n=this.items.indexOf(e);t.update([this.id,"items"],["-",n,e]),t.delete(e)},this.canJoin=function(t){return"list"===t.type},this.isBreakable=function(){return!0},this.break=function(t,e,n){var r=this.properties.items.indexOf(e);if(0>r)throw new Error("Unknown child "+e);var i=t.get(e),o=i.break(t,n);return t.update([this.id,"items"],["+",r+1,o.id]),o}},s.Prototype.prototype=o.prototype,s.prototype=new s.Prototype,s.prototype.constructor=s,i.defineProperties(s.prototype,["items","ordered"]),e.exports=s},{"substance-document":73,underscore:144}],117:[function(t,e){"use strict";var n=t("../composite/composite_view"),r=t("./list"),i=function(t,e){n.call(this,t,e)};i.whoami="SubstanceListView",i.Prototype=function(){this.render=function(){this.el.innerHTML="";var t=this.node.ordered?"OL":"UL";this.content=document.createElement(t),this.content.classList.add("content");var e;for(e=0;e<this.childrenViews.length;e++)this.childrenViews[e].dispose();var n=this.node.getNodes();for(e=0;e<n.length;e++){var i,o=this.node.document.get(n[e]),s=this.viewFactory.createView(o);o instanceof r?i=s.render().el:(i=document.createElement("LI"),i.appendChild(s.render().el)),this.content.appendChild(i),this.childrenViews.push(s)}return this.el.appendChild(this.content),this},this.onNodeUpdate=function(t){t.path[0]===this.node.id&&"items"===t.path[1]&&this.render()}},i.Prototype.prototype=n.prototype,i.prototype=new i.Prototype,e.exports=i},{"../composite/composite_view":92,"./list":116}],118:[function(t,e){"use strict";e.exports={Model:t("./node"),View:t("./node_view")}},{"./node":119,"./node_view":120}],119:[function(t,e){"use strict";var n=t("substance-document"),r=n.Node;r.description={name:"Node",remarks:["Abstract node type."],properties:{source_id:"Useful for document conversion where the original id of an element should be remembered."}},e.exports=r},{"substance-document":73}],120:[function(t,e){var n=t("substance-application").View,r=function(t,e){n.call(this),this.node=t,this.viewFactory=e,this.$el.addClass("content-node"),this.$el.attr("id",this.node.id)};r.Prototype=function(){this.render=function(){return this.content=document.createElement("DIV"),this.content.classList.add("content"),this.el.appendChild(this.content),this},this.dispose=function(){this.stopListening()},this.getCharPosition=function(){throw new Error("NodeView.getCharPosition() is abstract.")},this.getDOMPosition=function(){throw new Error("NodeView.getDOMPosition() is abstract.")},this.onGraphUpdate=function(t){t.path[0]!==this.node.id||"update"!==t.type&&"set"!==t.type||this.onNodeUpdate(t)},this.onNodeUpdate=function(){}},r.Prototype.prototype=n.prototype,r.prototype=new r.Prototype,e.exports=r},{"substance-application":62}],121:[function(t,e){"use strict";e.exports={Model:t("./paragraph"),View:t("./paragraph_view")}},{"./paragraph":122,"./paragraph_view":123}],122:[function(t,e){"use strict";var n=t("underscore"),r=t("substance-document"),i=r.Node,o=r.Composite,s=function(t,e){o.call(this,t,e)};s.type={id:"paragraph",parent:"content",properties:{children:["array","content"]}},s.description={name:"Paragraph",remarks:["A Paragraph can have inline elements such as images."],properties:{children:"An array of content node references"}},s.example={type:"paragraph",id:"paragraph_1","children ":["text_1","image_1","text_2"]},s.Prototype=function(){this.getLength=function(){return this.properties.children.length},this.getNodes=function(){return n.clone(this.properties.children)},this.getChildren=function(){return n.map(this.properties.children,function(t){return this.document.get(t)},this)},this.getChangePosition=function(t){if("children"===t.path[1])if("update"===t.type){var e=t.diff;if(e.isInsert())return t.diff.pos+1;if(e.isDelete())return t.diff.pos;if(e.isMove())return t.diff.target}else if("set"===t.type)return this.properties.children.length-1;return-1},this.isMutable=function(){return!0},this.insertChild=function(t,e,n){t.update([this.id,"children"],["+",e,n])},this.deleteChild=function(t,e){var n=this.children.indexOf(e);t.update([this.id,"children"],["-",n,e]),t.delete(e)},this.canJoin=function(t){return"paragraph"===t.type},this.isBreakable=function(){return!0},this.break=function(t,e,n){var r=this.properties.children.indexOf(e);if(0>r)throw new Error("Unknown child "+e);var i=t.get(e),o=i.break(t,n);return t.update([this.id,"children"],["+",r+1,o.id]),o}},s.Prototype.prototype=o.prototype,s.prototype=new s.Prototype,s.prototype.constructor=s,i.defineProperties(s.prototype,["children"]),e.exports=s},{"substance-document":73,underscore:144}],123:[function(t,e){"use strict";var n=t("../composite/composite_view"),r=function(t,e){n.call(this,t,e)};r.Prototype=function(){this.onNodeUpdate=function(t){t.path[0]===this.node.id&&"children"===t.path[1]&&this.render()}},r.Prototype.prototype=n.prototype,r.prototype=new r.Prototype,e.exports=r},{"../composite/composite_view":92}],124:[function(t,e){"use strict";e.exports={Model:t("./table"),View:t("./table_view")}},{"./table":125,"./table_view":126}],125:[function(t,e){"use strict";var n=t("substance-document"),r=t("underscore"),i=n.Node,o=n.Composite,s=function(t,e){o.call(this,t,e)};s.type={id:"table",parent:"content",properties:{label:"string",source_id:"string",headers:["array","content"],cells:["array","array","content"],caption:"content"}},s.description={name:"Table",remarks:[],properties:{items:"An array of references which contain the content of each cell"}},s.example={type:"table",id:"table_1",headers:["text_1","text_2"],cells:[["cell_1_1","cell_1_2"],["cell_2_1","cell_2_2"]]},s.Prototype=function(){this.getLength=function(){var t=0;t+=this.properties.headers.length;for(var e=0;e<this.properties.cells.length;e++){var n=this.properties.cells[e];t+=n.length}return this.properties.caption&&(t+=1),t},this.getNodes=function(){for(var t=[],e=0;e<this.properties.headers.length;e++)t.push(this.properties.headers[e]);for(var n=0;n<this.properties.cells.length;n++){var r=this.properties.cells[n];t=t.concat(r)}return this.properties.caption&&t.push(this.properties.caption),t},this.getHeaders=function(){return r.map(this.properties.headers,function(t){return this.document.get(t)},this)},this.getCells=function(){for(var t=[],e=0;e<this.properties.cells.length;e++){for(var n=this.properties.cells[e],r=[],i=0;i<n.length;i++)r.push(this.document.get(n[i]));t.push(r)}return t},this.getCaption=function(){var t;return this.properties.caption&&(t=this.document.get(this.properties.caption)),t},this.getChangePosition=function(){return-1},this.isMutable=function(){return!1},this.canJoin=function(){return!1},this.isBreakable=function(){return!1}},s.Prototype.prototype=o.prototype,s.prototype=new s.Prototype,s.prototype.constructor=s,s.create=function(t){var e,n,r={},i=t.id,o={id:i,type:"table",label:t.label,headers:[],cells:[]};if(t.headers)for(var s=0;s<t.headers.length;s++){var a=t.headers[s];e="th_"+s+"_"+i,n={id:e,type:"text",content:a},r[e]=n,o.headers.push(e)}for(var c=0;c<t.cells.length;c++){for(var u=t.cells[c],l=[],p=0;p<u.length;p++){var h=u[p];e="td__"+c+"_"+p+"_"+i,n={id:e,type:"text",content:h},r[e]=n,l.push(e)}o.cells.push(l)}return t.caption&&(e="caption_"+i,n={id:e,type:"text",content:t.caption},r[e]=n,o.caption=e),r[o.id]=o,r},i.defineProperties(s.prototype,["headers","cells","caption"]),Object.defineProperties(s.prototype,{header:{get:function(){return this.properties.label}}}),e.exports=s},{"substance-document":73,underscore:144}],126:[function(t,e){"use strict";var n=t("../composite/composite_view"),r=(t("underscore"),function(t,e){n.call(this,t,e)});r.Prototype=function(){this.render=function(){this.el.innerHTML="",this.content=document.createElement("div"),this.content.classList.add("content");for(var t=0;t<this.childrenViews.length;t++)this.childrenViews[t].dispose();var e,n,r=document.createElement("table"),i=this.node.getHeaders(),o=document.createElement("thead");if(i.length>0){for(var s=document.createElement("tr"),t=0;t<i.length;t++){e=i[t],n=this.viewFactory.createView(e);var a=document.createElement("th");a.appendChild(n.render().el),s.appendChild(a),this.childrenViews.push(n)}o.appendChild(s)}r.appendChild(o);for(var c=this.node.getCells(),u=document.createElement("tbody"),l=0;l<c.length;l++){for(var p=c[l],s=document.createElement("tr"),h=0;h<p.length;h++){e=p[h],n=this.viewFactory.createView(e);var a=document.createElement("td");a.appendChild(n.render().el),s.appendChild(a),this.childrenViews.push(n)}u.appendChild(s)}if(r.appendChild(u),this.content.appendChild(r),this.node.caption){var d=this.node.getCaption(),f=this.viewFactory.createView(d),g=f.render().el;g.classList.add("caption"),this.content.appendChild(g),this.childrenViews.push(f)}return this.el.appendChild(this.content),this},this.onNodeUpdate=function(t){t.path[0]===this.node.id&&("headers"===t.path[1]||"cells"===t.path[1])&&this.render()}},r.Prototype.prototype=n.prototype,r.prototype=new r.Prototype,r.prototype.constructor=r,e.exports=r},{"../composite/composite_view":92,underscore:144}],127:[function(t,e){"use strict";e.exports={Model:t("./text_node"),View:t("./text_view")}},{"./text_node":128,"./text_view":129}],128:[function(t,e){"use strict";var n=t("substance-document");e.exports=n.TextNode},{"substance-document":73}],129:[function(t,e){var n=t("underscore"),r=t("../node/node_view"),i=t("substance-document"),o=i.Annotator,s=t("substance-application").$$,a=!1,c=function(t,e){r.call(this,t),e=e||{},this.path=e.path||[t.id,"content"],this.property=t.document.resolve(this.path),this.$el.addClass(e.classes?e.classes:"content-node text"),e.path||this.$el.attr("id",this.node.id),this._annotations={}};c.Prototype=function(){this.render=function(t){return r.prototype.render.call(this,t),this.renderContent(),this},this.dispose=function(){r.prototype.dispose.call(this),console.log("disposing paragraph view")},this.renderContent=function(){this.content.innerHTML="",this._annotations=this.node.document.getIndex("annotations").get(this.path),this.renderWithAnnotations(this._annotations)},this.insert=function(t,e){var n=this.getDOMPosition(t),r=n.startContainer,i=n.startOffset,o=r.textContent;o=o.substring(0,i)+e+o.substring(i),r.textContent=o},this.delete=function(t,e){var n=this.getDOMPosition(t),r=n.startContainer,i=n.startOffset,o=r.textContent;o=o.substring(0,i)+o.substring(i+e),r.textContent=o},this.onNodeUpdate=function(t){if("update"===t.type){var e=t.diff;e.isInsert()?this.insert(e.pos,e.str):e.isDelete()&&this.delete(e.pos,e.str.length)}else"set"===t.type&&this.renderContent()},this.onGraphUpdate=function(t){!n.isEqual(t.path,this.path)||"update"!==t.type&&"set"!==t.type||this.onNodeUpdate(t);var e,r=this.node.document,i=r.getSchema();if(e="delete"!==t.type?r.get(t.path[0]):t.val,i.isInstanceOf(e.type,"annotation")){var o=!1;e.path[0]===this.node.id?o=!0:"set"===t.type&&"path"===t.path[1]&&t.original[0]===this.node.id&&(o=!0),o&&(console.log("Rerendering TextView due to annotation update",t),this.renderContent())}},this.getCharPosition=function(t,e){var n=document.createRange();n.setStart(this.content.childNodes[0],0),n.setEnd(t,e);var r=n.toString(),i=Math.min(this.property.get().length,r.length);return i},this.getDOMPosition=function(t){if(void 0===this.content)throw new Error("Not rendered yet.");var e=document.createRange();if(0===this.property.get().length)return e.setStart(this.content.childNodes[0],0),e;for(var n=[this.content];n.length>0;){var r=n.pop();if(r.nodeType===Node.TEXT_NODE){var i=r;if(i.length>=t)return e.setStart(r,t),e;t-=i.length}else if(r.childNodes.length>0)for(var o=r.childNodes.length-1;o>=0;o--)n.push(r.childNodes[o])}console.log("Bug-Alarm: the model and the view are out of sync."),console.log("The model as "+t+" more characters"),console.log("Returning the last available position... but please fix me. Anyone?");var s=this.content.childNodes,a=s[s.length-1];return e.setStart(a,a.length),e},this.createAnnotationElement=function(t){var e;return e="link"===t.type?s("a.annotation."+t.type,{id:t.id,href:this.node.document.get(t.id).url}):s("span.annotation."+t.type,{id:t.id})},this.renderWithAnnotations=function(t){var e=this,n=this.property.get(),r=document.createDocumentFragment(),i=new o.Fragmenter({});i.onText=function(t,e){t.appendChild(document.createTextNode(e))},i.onEnter=function(t,n){var r=e.createAnnotationElement(t);return n.appendChild(r),r},i.start(r,n,t),a&&r.appendChild(document.createTextNode(" ")),this.content.innerHTML="",this.content.appendChild(r)},this.dispose=function(){this.stopListening()}},c.Prototype.prototype=r.prototype,c.prototype=new c.Prototype,e.exports=c},{"../node/node_view":120,"substance-application":62,"substance-document":73,underscore:144}],130:[function(t,e){"use strict";e.exports={Model:t("./web_resource"),View:t("./web_resource_view")}},{"./web_resource":131,"./web_resource_view":132}],131:[function(t,e){"use strict";var n=t("substance-document").Node,r=function(t,e){n.call(this,t,e)};r.type={id:"webresource",parent:"content",properties:{source_id:"string",url:"string"}},r.description={name:"WebResource",description:"A resource which can be accessed via URL",remarks:["This element is a parent for several other nodes such as Image."],properties:{url:"URL to a resource"}},r.example={type:"webresource",id:"webresource_3",url:"http://elife.elifesciences.org/content/elife/1/e00311/F3.medium.gif"},r.Prototype=function(){},r.Prototype.prototype=n.prototype,r.prototype=new r.Prototype,r.prototype.constructor=r,n.defineProperties(r.prototype,["url"]),e.exports=r},{"substance-document":73}],132:[function(t,e){"use strict";e.exports=t("../node").View},{"../node":118}],133:[function(t,e){"use strict";e.exports=t("./src/regexp")},{"./src/regexp":134}],134:[function(t,e){"use strict";var n=function(t){this.index=t.index,this.match=[];for(var e=0;e<t.length;e++)this.match.push(t[e])};n.Prototype=function(){this.captures=function(){return this.match.slice(1)},this.toString=function(){return this.match[0]}},n.prototype=new n.Prototype;var r=function(t){this.exp=t};r.Prototype=function(){this.match=function(t){if(void 0===t)throw new Error("No string given");if(this.exp.global){var e,r=[];for(this.exp.compile(this.exp);null!==(e=this.exp.exec(t));)r.push(new n(e));return r}return this.exp.exec(t)}},r.prototype=new r.Prototype,r.Match=n,e.exports=r},{}],135:[function(t,e){"use strict";var n=t("./src/surface");e.exports=n},{"./src/surface":136}],136:[function(t,e){"use strict";var n=t("underscore"),r=t("substance-application").View,i=t("substance-util"),o=t("substance-commander"),s=function(t,e){e=n.extend({editable:!0},e),r.call(this);var i=this;if(this.options=e,this.renderer=this.options.renderer?this.options.renderer:new t.__document.constructor.Renderer(t),this.doc=t,this.nodeTypes=t.__document.nodeTypes,this.listenTo(this.doc.selection,"selection:changed",this.renderSelection),this.listenTo(this.doc.__document,"property:updated",this.onUpdateView),this.listenTo(this.doc.__document,"graph:reset",this.reset),this.build(),this.$el.addClass("surface"),this.$el.addClass(this.doc.view),e.editable){this.el.setAttribute("contenteditable","true"),this.el.spellcheck=!1,this.$el.mouseup(function(t){this.ignoreNextSelection=!0,this.updateSelection(t)}.bind(this)),this.$el.delegate("img","click",function(t){var e=$(t.currentTarget).parent().parent().parent(),n=e.attr("id");return i.doc.selection.selectNode(n),!1}),this._dirt=[],this._onKeyDown=function(){this._dirtPossible=!0}.bind(this),this._onTextInput=function(t){for(this._dirtPossible=!1;this._dirt.length>0;){var e=this._dirt.shift();e[0].textContent=e[1]}this.doc.write(t.data),t.preventDefault()}.bind(this);var s=function(t,e){return function(n){i._dirtPossible=!1,setTimeout(t,0),e!==!0&&n.preventDefault()}};this.keyboard=new o.Mousetrap,this.keyboard.bind(["up","down","left","right","shift+up","shift+down","shift+left","shift+right","ctrl+up","ctrl+down","ctrl+left","ctrl+right","ctrl+shift+up","ctrl+shift+down","ctrl+shift+left","ctrl+shift+right","alt+up","alt+down","alt+left","alt+right"],function(){setTimeout(function(){i.ignoreNextSelection=!0,i.updateSelection()},0)},"keydown"),this.keyboard.bind(["backspace"],s(function(){i.doc.delete("left")}),"keydown"),this.keyboard.bind(["del"],s(function(){i.doc.delete("right")}),"keydown"),this.keyboard.bind(["enter"],s(function(){i.doc.modifyNode()}),"keydown"),this.keyboard.bind(["shift+enter"],s(function(){i.doc.write("\n")}),"keydown"),this.keyboard.bind(["space"],s(function(){i.doc.write(" ")}),"keydown"),this.keyboard.bind(["tab"],s(function(){i.doc.write("  ")}),"keydown"),this.keyboard.bind(["ctrl+z"],s(function(){i.doc.undo()}),"keydown"),this.keyboard.bind(["ctrl+shift+z"],s(function(){i.doc.redo()}),"keydown"),this.makeEditable(this.el)}};s.Prototype=function(){function t(t,e,n){var r=t.childNodes;if(e<r.length){var i=r[e];t.insertBefore(n,i)}else t.appendChild(n)}var e=function(t){for(var e=t;void 0!==e;){if($(e).is(".content-node"))return e;e=e.parentElement}return null};this.makeEditable=function(t){var e=this;t.addEventListener("keydown",this._onKeyDown),t.addEventListener("textInput",this._onTextInput,!0),t.addEventListener("input",this._onTextInput,!0),this._dirt=[],this._observer=new MutationObserver(function(t){t.forEach(function(t){e._dirtPossible&&e._dirt.push([t.target,t.oldValue])})});var n={subtree:!0,characterData:!0,characterDataOldValue:!0};this._observer.observe(t,n),this.keyboard.connect(t)},this.updateSelection=function(){var t=window.getSelection();if(null!==t.anchorNode){if($(t.anchorNode.parentElement).is(".cursor"))return void this.doc.selection.collapse("cursor");var n,r,i=t.getRangeAt(0);if(n=[i.startContainer,i.startOffset],r=[i.endContainer,i.endOffset],i.endContainer===t.anchorNode&&i.endOffset===t.anchorOffset){var o=n;n=r,r=o}var s=e.call(this,n[0]),a=e.call(this,r[0]),c=s.getAttribute("id"),u=this.doc.getPosition(c),l=this.nodes[c].getCharPosition(n[0],n[1]),p=a.getAttribute("id"),h=this.doc.getPosition(p),d=this.nodes[p].getCharPosition(r[0],r[1]),f=[u,l],g=[h,d];this.doc.selection.set({start:f,end:g})}},this.renderSelection=function(){if(this.ignoreNextSelection===!0)return void(this.ignoreNextSelection=!1);if(this.doc.selection.isNull())return void this.$cursor.hide();var t=window.getSelection(),e=this.doc.selection.range(),n=this.doc.getNodeFromPosition(e.start[0]),r=this.renderer.nodes[n.id],i=r.getDOMPosition(e.start[1]),o=this.doc.getNodeFromPosition(e.end[0]),s=this.renderer.nodes[o.id],a=s.getDOMPosition(e.end[1]),c=document.createRange();c.setStart(i.startContainer,i.startOffset),c.setEnd(a.endContainer,a.endOffset),t.removeAllRanges(),t.addRange(c)},this.build=function(){this.nodes=this.renderer.nodes},this.render=function(){var t=document.createElement("input");t.className="image-files",t.setAttribute("type","file"),t.setAttribute("name","files[]");var e=document.createElement("div");e.className="controls";var n=document.createElement("div");n.className="nodes";var r=document.createElement("div");return r.className="cursor",this.el.appendChild(t),this.el.appendChild(e),this.el.appendChild(n),this.el.appendChild(r),n.appendChild(this.renderer.render()),this.$("input.image-files").hide(),this.$cursor=this.$(".cursor"),this.$cursor.hide(),this._nodesEl=n,this},this.reset=function(){n.each(this.nodes,function(t){t.dispose()}),this.build(),this.render()},this.dispose=function(){this.stopListening(),n.each(this.nodes,function(t){t.dispose()},this)},this.onUpdateView=function(e,n){if(2===e.length&&"content"===e[0]&&"nodes"===e[1]){var r,i,o,s,a=this._nodesEl;if(n.isInsert()){if(r=n.val,i=this.doc.get(r),this.nodeTypes[i.type]){var c=this.renderer.createView(i);this.nodes[r]=c,s=c.render().el,t(a,n.pos,s)}}else if(n.isDelete())r=n.val,this.nodes[r]&&this.nodes[r].dispose(),delete this.nodes[r],o=a.children,a.removeChild(o[n.pos]);else if(n.isMove())o=a.children,s=o[n.pos],a.removeChild(s),t(a,n.target,s);else if("NOP"!==n.type)throw new Error("Illegal state.")}}},n.extend(s.Prototype,i.Events.Listener),s.Prototype.prototype=r.prototype,s.prototype=new s.Prototype,e.exports=s},{"substance-application":62,"substance-commander":152,"substance-util":139,underscore:144}],137:[function(t,e){"use strict";var n=t("./toc_view");e.exports=n},{"./toc_view":138}],138:[function(t,e){"use strict";var n=t("substance-application").View,r=t("substance-application").$$,i=t("substance-data"),o=(i.Graph.Index,t("underscore")),s=function(t){n.call(this),this.doc=t,this.$el.addClass("toc")};s.Prototype=function(){this.render=function(){return this.doc.getHeadings().length<2?this:(o.each(this.doc.getHeadings(),function(t){this.el.appendChild(r("a.heading-ref.level-"+t.level,{id:"toc_"+t.id,text:t.content,"sbs-click":"jumpToNode("+t.id+")"}))},this),this)},this.setActiveNode=function(t){this.$(".heading-ref.active").removeClass("active"),this.$("#toc_"+t).addClass("active")}},s.Prototype.prototype=n.prototype,s.prototype=new s.Prototype,e.exports=s},{"substance-application":62,"substance-data":68,underscore:144}],139:[function(t,e){"use strict";var n=t("./src/util");n.errors=t("./src/errors"),n.html=t("./src/html"),n.dom=t("./src/dom"),e.exports=n},{"./src/dom":140,"./src/errors":141,"./src/html":142,"./src/util":143}],140:[function(t,e){"use strict";var n=t("underscore"),r={};r.ChildNodeIterator=function(t){this.nodes=n.isArray(t)?t:t.childNodes,this.length=this.nodes.length,this.pos=-1},r.ChildNodeIterator.prototype={hasNext:function(){return this.pos<this.length-1},next:function(){return this.pos+=1,this.nodes[this.pos]},back:function(){return this.pos>=0&&(this.pos-=1),this}},r.getChildren=function(t){if(void 0!==t.children)return t.children;for(var e=[],n=t.firstElementChild;n;)e.push(n),n=n.nextElementSibling;return e},r.getNodeType=function(t){if(t.nodeType===Node.TEXT_NODE)return"text";if(t.nodeType===Node.COMMENT_NODE)return"comment";if(t.tagName)return t.tagName.toLowerCase();throw new Error("Unknown node type")},e.exports=r},{underscore:144}],141:[function(t,e){"use strict";var n=(t("underscore"),t("./util")),r={};r.SubstanceError=function(t,e,r){1==arguments.length&&(r=t,t="SubstanceError",e=-1),this.message=r,this.name=t,this.code=e,this.__stack=n.callstack(1)
},r.SubstanceError.Prototype=function(){this.toString=function(){return this.name+":"+this.message},this.toJSON=function(){return{name:this.name,message:this.message,code:this.code,stack:this.stack}},this.printStackTrace=function(){n.printStackTrace(this)}},r.SubstanceError.prototype=new r.SubstanceError.Prototype,Object.defineProperty(r.SubstanceError.prototype,"stack",{get:function(){for(var t=[],e=0;e<this.__stack.length;e++){var n=this.__stack[e];t.push(n.file+":"+n.line+":"+n.col+" ("+n.func+")")}return t.join("\n")},set:function(){throw new Error("immutable.")}}),r.define=function(t,e){return void 0===e&&(e=-1),r[t]=r.SubstanceError.bind(null,t,e),r[t].prototype=r.SubstanceError.prototype,r[t]},e.exports=r},{"./util":143,underscore:144}],142:[function(t,e){"use strict";var n={},r=t("underscore");n.templates={},n.renderTemplate=function(t,e){return n.templates[t](e)},"undefined"!=typeof window&&(window.console||(window.console={log:function(){}})),n.tpl=function(t,e){e=e||{};var n=$("script[name="+t+"]").html();return r.template(n,e)},e.exports=n},{underscore:144}],143:[function(t,e,n){"use strict";function r(t,e){function n(t){var e=a[c];if(!e)return l.length>0?r(new Error("Multiple errors occurred.",t)):r(null,t);var i=p(function(t,e){if(t){if(u)return r(t,null);l.push(t)}c+=1,n(e)});try{1===e.length?e(i):e(t,i)}catch(o){console.log("util.async caught error:",o),s.printStackTrace(o),r(o)}}var r=t.finally||function(t,n){e(t,n)};r=p(r);var i=t.data||{},a=t.functions;if(!o.isFunction(e))return e("Illegal arguments: a callback function must be provided");var c=0,u=void 0===t.stopOnError?!0:t.stopOnError,l=[];n(i)}function i(t){return function(e,n){function i(t,e){return function(n,r){2===p.length?p(t,r):3===p.length?p(t,e,r):p(t,e,n,r)}}function s(t,e){return function(n,r){2===p.length?p(t,r):3===p.length?p(t,e,r):p(t,e,n,r)}}var a=t.selector?t.selector(e):t.items,c=t.finally||function(t,e){n(t,e)};if(!a)return c(null,e);var u=o.isArray(a);t.before&&t.before(e);var l=[],p=t.iterator;if(u)for(var h=0;h<a.length;h++)l.push(i(a[h],h));else for(var d in a)l.push(s(a[d],d));var f={functions:l,data:e,"finally":c,stopOnError:t.stopOnError};r(f,n)}}var o=t("underscore"),s={};s.uuid=function(t,e){var n,r="0123456789abcdefghijklmnopqrstuvwxyz".split(""),i=[],o=16;if(e=e||32)for(n=0;e>n;n++)i[n]=r[0|Math.random()*o];else{var s;for(i[8]=i[13]=i[18]=i[23]="-",i[14]="4",n=0;36>n;n++)i[n]||(s=0|16*Math.random(),i[n]=r[19==n?3&s|8:s])}return(t?t:"")+i.join("")},s.uuidGen=function(t){var e=1;return t=void 0!==t?t:"uuid_",function(n){return n=n||t,n+e++}};var a=function(t,e){var n,r=-1,i=t.length,o=e[0],s=e[1],a=e[2];switch(e.length){case 0:for(;++r<i;)(n=t[r]).callback.call(n.ctx);return;case 1:for(;++r<i;)(n=t[r]).callback.call(n.ctx,o);return;case 2:for(;++r<i;)(n=t[r]).callback.call(n.ctx,o,s);return;case 3:for(;++r<i;)(n=t[r]).callback.call(n.ctx,o,s,a);return;default:for(;++r<i;)(n=t[r]).callback.apply(n.ctx,e)}},c=/\s+/,u=function(t,e,n,r){if(!n)return!0;if("object"==typeof n){for(var i in n)t[e].apply(t,[i,n[i]].concat(r));return!1}if(c.test(n)){for(var o=n.split(c),s=0,a=o.length;a>s;s++)t[e].apply(t,[o[s]].concat(r));return!1}return!0};s.Events={on:function(t,e,n){if(!u(this,"on",t,[e,n])||!e)return this;this._events=this._events||{};var r=this._events[t]||(this._events[t]=[]);return r.push({callback:e,context:n,ctx:n||this}),this},once:function(t,e,n){if(!u(this,"once",t,[e,n])||!e)return this;var r=this,i=o.once(function(){r.off(t,i),e.apply(this,arguments)});return i._callback=e,this.on(t,i,n)},off:function(t,e,n){var r,i,s,a,c,l,p,h;if(!this._events||!u(this,"off",t,[e,n]))return this;if(!t&&!e&&!n)return this._events={},this;for(a=t?[t]:o.keys(this._events),c=0,l=a.length;l>c;c++)if(t=a[c],s=this._events[t]){if(this._events[t]=r=[],e||n)for(p=0,h=s.length;h>p;p++)i=s[p],(e&&e!==i.callback&&e!==i.callback._callback||n&&n!==i.context)&&r.push(i);r.length||delete this._events[t]}return this},trigger:function(t){if(!this._events)return this;var e=Array.prototype.slice.call(arguments,1);if(!u(this,"trigger",t,e))return this;var n=this._events[t],r=this._events.all;return n&&a(n,e),r&&a(r,arguments),this},triggerLater:function(){var t=this,e=arguments;setTimeout(function(){t.trigger.apply(t,e)},0)},stopListening:function(t,e,n){var r=this._listeners;if(!r)return this;var i=!e&&!n;"object"==typeof e&&(n=this),t&&((r={})[t._listenerId]=t);for(var o in r)r[o].off(e,n,this),i&&delete this._listeners[o];return this}};var l={listenTo:"on",listenToOnce:"once"};o.each(l,function(t,e){s.Events[e]=function(e,n,r){var i=this._listeners||(this._listeners={}),s=e._listenerId||(e._listenerId=o.uniqueId("l"));return i[s]=e,"object"==typeof n&&(r=this),e[t](n,r,this),this}}),s.Events.bind=s.Events.on,s.Events.unbind=s.Events.off,s.Events.Listener={listenTo:function(t,e,n){if(!o.isFunction(n))throw new Error("Illegal argument: expecting function as callback, was: "+n);return this._handlers=this._handlers||[],t.on(e,n,this),this._handlers.push({unbind:function(){t.off(e,n)}}),this},stopListening:function(){if(this._handlers)for(var t=0;t<this._handlers.length;t++)this._handlers[t].unbind()}};var p=o.once;s.async={},s.async.sequential=function(t,e){o.isArray(t)&&(t={functions:t}),r(t,e)},s.async.iterator=function(t,e){var n;return n=1==arguments.length?t:{items:t,iterator:e},i(n)},s.async.each=function(t,e){var n=i(t);n(null,e)},s.propagate=function(t,e){if(!o.isFunction(e))throw"Illegal argument: provided callback is not a function";return function(n){return n?e(n):void e(null,t)}};var h=function(){};s.inherits=function(t,e,n){var r;return r=e&&e.hasOwnProperty("constructor")?e.constructor:function(){t.apply(this,arguments)},o.extend(r,t),h.prototype=t.prototype,r.prototype=new h,e&&o.extend(r.prototype,e),n&&o.extend(r,n),r.prototype.constructor=r,r.__super__=t.prototype,r},s.getJSON=function(e,r){if("undefined"!=typeof n){var i=t("fs"),o=JSON.parse(i.readFileSync(e,"utf8"));r(null,o)}else $.getJSON(e).done(function(t){r(null,t)}).error(function(t){r(t,null)})},s.prototype=function(t){return Object.getPrototypeOf?Object.getPrototypeOf(t):t.__proto__},s.inherit=function(t,e){var n,r=o.isFunction(t)?new t:t;if(o.isFunction(e))e.prototype=r,n=new e;else{var i=function(){};i.prototype=r,n=o.extend(new i,e)}return n},s.pimpl=function(t){var e=function(t){this.self=t};return e.prototype=t,function(t){return t=t||this,new e(t)}},s.parseStackTrace=function(t){var e,n=/([^@]*)@(.*):(\d+)/,r=/\s*at ([^(]*)[(](.*):(\d+):(\d+)[)]/,i=t.stack.split("\n"),o=[];for(e=0;e<i.length;e++){var s=n.exec(i[e]);if(s||(s=r.exec(i[e])),s){var a={func:s[1],file:s[2],line:s[3],col:s[4]||0};""===a.func&&(a.func="<anonymous>"),o.push(a)}}return o},s.callstack=function(t){var e;try{throw new Error}catch(n){e=n}var r=s.parseStackTrace(e);return t=t||0,r.splice(t+1)},s.stacktrace=function(t){var e=0===arguments.length?s.callstack().splice(1):s.parseStackTrace(t),n=[];return o.each(e,function(t){n.push(t.file+":"+t.line+":"+t.col+" ("+t.func+")")}),n.join("\n")},s.printStackTrace=function(t,e){if(t.stack){var n;if(void 0!==t.__stack)n=t.__stack;else{if(!o.isString(t.stack))return;n=s.parseStackTrace(t)}e=e||n.length,e=Math.min(e,n.length);for(var r=0;e>r;r++){var i=n[r];console.log(i.file+":"+i.line+":"+i.col,"("+i.func+")")}}},s.diff=function(t,e){var n;return o.isArray(t)&&o.isArray(e)?(n=o.difference(e,t),0===n.length?null:n):o.isObject(t)&&o.isObject(e)?(n={},o.each(Object.keys(e),function(r){var i=s.diff(t[r],e[r]);i&&(n[r]=i)}),o.isEmpty(n)?null:n):t!==e?e:void 0},s.deepclone=function(t){return JSON.parse(JSON.stringify(t))},s.clone=function(t){return null===t||void 0===t?t:o.isFunction(t.clone)?t.clone():s.deepclone(t)},s.freeze=function(t){var e;if(o.isObject(t)){if(Object.isFrozen(t))return t;var n=Object.keys(t);for(e=0;e<n.length;e++){var r=n[e];t[r]=s.freeze(t[r])}return Object.freeze(t)}if(o.isArray(t)){var i=t;for(e=0;e<i.length;e++)i[e]=s.freeze(i[e]);return Object.freeze(i)}return t},s.later=function(t,e){return function(){var n=arguments;setTimeout(function(){t.apply(e,n)},0)}},s.isEmpty=function(t){return!t.match(/\w/)},e.exports=s},{fs:152,underscore:144}],144:[function(t,e,n){(function(){var t=this,r=t._,i={},o=Array.prototype,s=Object.prototype,a=Function.prototype,c=o.push,u=o.slice,l=o.concat,p=s.toString,h=s.hasOwnProperty,d=o.forEach,f=o.map,g=o.reduce,m=o.reduceRight,y=o.filter,v=o.every,b=o.some,w=o.indexOf,x=o.lastIndexOf,_=Array.isArray,C=Object.keys,P=a.bind,S=function(t){return t instanceof S?t:this instanceof S?void(this._wrapped=t):new S(t)};"undefined"!=typeof n?("undefined"!=typeof e&&e.exports&&(n=e.exports=S),n._=S):t._=S,S.VERSION="1.5.2";var N=S.each=S.forEach=function(t,e,n){if(null!=t)if(d&&t.forEach===d)t.forEach(e,n);else if(t.length===+t.length){for(var r=0,o=t.length;o>r;r++)if(e.call(n,t[r],r,t)===i)return}else for(var s=S.keys(t),r=0,o=s.length;o>r;r++)if(e.call(n,t[s[r]],s[r],t)===i)return};S.map=S.collect=function(t,e,n){var r=[];return null==t?r:f&&t.map===f?t.map(e,n):(N(t,function(t,i,o){r.push(e.call(n,t,i,o))}),r)};var k="Reduce of empty array with no initial value";S.reduce=S.foldl=S.inject=function(t,e,n,r){var i=arguments.length>2;if(null==t&&(t=[]),g&&t.reduce===g)return r&&(e=S.bind(e,r)),i?t.reduce(e,n):t.reduce(e);if(N(t,function(t,o,s){i?n=e.call(r,n,t,o,s):(n=t,i=!0)}),!i)throw new TypeError(k);return n},S.reduceRight=S.foldr=function(t,e,n,r){var i=arguments.length>2;if(null==t&&(t=[]),m&&t.reduceRight===m)return r&&(e=S.bind(e,r)),i?t.reduceRight(e,n):t.reduceRight(e);var o=t.length;if(o!==+o){var s=S.keys(t);o=s.length}if(N(t,function(a,c,u){c=s?s[--o]:--o,i?n=e.call(r,n,t[c],c,u):(n=t[c],i=!0)}),!i)throw new TypeError(k);return n},S.find=S.detect=function(t,e,n){var r;return A(t,function(t,i,o){return e.call(n,t,i,o)?(r=t,!0):void 0}),r},S.filter=S.select=function(t,e,n){var r=[];return null==t?r:y&&t.filter===y?t.filter(e,n):(N(t,function(t,i,o){e.call(n,t,i,o)&&r.push(t)}),r)},S.reject=function(t,e,n){return S.filter(t,function(t,r,i){return!e.call(n,t,r,i)},n)},S.every=S.all=function(t,e,n){e||(e=S.identity);var r=!0;return null==t?r:v&&t.every===v?t.every(e,n):(N(t,function(t,o,s){return(r=r&&e.call(n,t,o,s))?void 0:i}),!!r)};var A=S.some=S.any=function(t,e,n){e||(e=S.identity);var r=!1;return null==t?r:b&&t.some===b?t.some(e,n):(N(t,function(t,o,s){return r||(r=e.call(n,t,o,s))?i:void 0}),!!r)};S.contains=S.include=function(t,e){return null==t?!1:w&&t.indexOf===w?-1!=t.indexOf(e):A(t,function(t){return t===e})},S.invoke=function(t,e){var n=u.call(arguments,2),r=S.isFunction(e);return S.map(t,function(t){return(r?e:t[e]).apply(t,n)})},S.pluck=function(t,e){return S.map(t,function(t){return t[e]})},S.where=function(t,e,n){return S.isEmpty(e)?n?void 0:[]:S[n?"find":"filter"](t,function(t){for(var n in e)if(e[n]!==t[n])return!1;return!0})},S.findWhere=function(t,e){return S.where(t,e,!0)},S.max=function(t,e,n){if(!e&&S.isArray(t)&&t[0]===+t[0]&&t.length<65535)return Math.max.apply(Math,t);if(!e&&S.isEmpty(t))return-1/0;var r={computed:-1/0,value:-1/0};return N(t,function(t,i,o){var s=e?e.call(n,t,i,o):t;s>r.computed&&(r={value:t,computed:s})}),r.value},S.min=function(t,e,n){if(!e&&S.isArray(t)&&t[0]===+t[0]&&t.length<65535)return Math.min.apply(Math,t);if(!e&&S.isEmpty(t))return 1/0;var r={computed:1/0,value:1/0};return N(t,function(t,i,o){var s=e?e.call(n,t,i,o):t;s<r.computed&&(r={value:t,computed:s})}),r.value},S.shuffle=function(t){var e,n=0,r=[];return N(t,function(t){e=S.random(n++),r[n-1]=r[e],r[e]=t}),r},S.sample=function(t,e,n){return arguments.length<2||n?t[S.random(t.length-1)]:S.shuffle(t).slice(0,Math.max(0,e))};var E=function(t){return S.isFunction(t)?t:function(e){return e[t]}};S.sortBy=function(t,e,n){var r=E(e);return S.pluck(S.map(t,function(t,e,i){return{value:t,index:e,criteria:r.call(n,t,e,i)}}).sort(function(t,e){var n=t.criteria,r=e.criteria;if(n!==r){if(n>r||void 0===n)return 1;if(r>n||void 0===r)return-1}return t.index-e.index}),"value")};var T=function(t){return function(e,n,r){var i={},o=null==n?S.identity:E(n);return N(e,function(n,s){var a=o.call(r,n,s,e);t(i,a,n)}),i}};S.groupBy=T(function(t,e,n){(S.has(t,e)?t[e]:t[e]=[]).push(n)}),S.indexBy=T(function(t,e,n){t[e]=n}),S.countBy=T(function(t,e){S.has(t,e)?t[e]++:t[e]=1}),S.sortedIndex=function(t,e,n,r){n=null==n?S.identity:E(n);for(var i=n.call(r,e),o=0,s=t.length;s>o;){var a=o+s>>>1;n.call(r,t[a])<i?o=a+1:s=a}return o},S.toArray=function(t){return t?S.isArray(t)?u.call(t):t.length===+t.length?S.map(t,S.identity):S.values(t):[]},S.size=function(t){return null==t?0:t.length===+t.length?t.length:S.keys(t).length},S.first=S.head=S.take=function(t,e,n){return null==t?void 0:null==e||n?t[0]:u.call(t,0,e)},S.initial=function(t,e,n){return u.call(t,0,t.length-(null==e||n?1:e))},S.last=function(t,e,n){return null==t?void 0:null==e||n?t[t.length-1]:u.call(t,Math.max(t.length-e,0))},S.rest=S.tail=S.drop=function(t,e,n){return u.call(t,null==e||n?1:e)},S.compact=function(t){return S.filter(t,S.identity)};var $=function(t,e,n){return e&&S.every(t,S.isArray)?l.apply(n,t):(N(t,function(t){S.isArray(t)||S.isArguments(t)?e?c.apply(n,t):$(t,e,n):n.push(t)}),n)};S.flatten=function(t,e){return $(t,e,[])},S.without=function(t){return S.difference(t,u.call(arguments,1))},S.uniq=S.unique=function(t,e,n,r){S.isFunction(e)&&(r=n,n=e,e=!1);var i=n?S.map(t,n,r):t,o=[],s=[];return N(i,function(n,r){(e?r&&s[s.length-1]===n:S.contains(s,n))||(s.push(n),o.push(t[r]))}),o},S.union=function(){return S.uniq(S.flatten(arguments,!0))},S.intersection=function(t){var e=u.call(arguments,1);return S.filter(S.uniq(t),function(t){return S.every(e,function(e){return S.indexOf(e,t)>=0})})},S.difference=function(t){var e=l.apply(o,u.call(arguments,1));return S.filter(t,function(t){return!S.contains(e,t)})},S.zip=function(){for(var t=S.max(S.pluck(arguments,"length").concat(0)),e=new Array(t),n=0;t>n;n++)e[n]=S.pluck(arguments,""+n);return e},S.object=function(t,e){if(null==t)return{};for(var n={},r=0,i=t.length;i>r;r++)e?n[t[r]]=e[r]:n[t[r][0]]=t[r][1];return n},S.indexOf=function(t,e,n){if(null==t)return-1;var r=0,i=t.length;if(n){if("number"!=typeof n)return r=S.sortedIndex(t,e),t[r]===e?r:-1;r=0>n?Math.max(0,i+n):n}if(w&&t.indexOf===w)return t.indexOf(e,n);for(;i>r;r++)if(t[r]===e)return r;return-1},S.lastIndexOf=function(t,e,n){if(null==t)return-1;var r=null!=n;if(x&&t.lastIndexOf===x)return r?t.lastIndexOf(e,n):t.lastIndexOf(e);for(var i=r?n:t.length;i--;)if(t[i]===e)return i;return-1},S.range=function(t,e,n){arguments.length<=1&&(e=t||0,t=0),n=arguments[2]||1;for(var r=Math.max(Math.ceil((e-t)/n),0),i=0,o=new Array(r);r>i;)o[i++]=t,t+=n;return o};var V=function(){};S.bind=function(t,e){var n,r;if(P&&t.bind===P)return P.apply(t,u.call(arguments,1));if(!S.isFunction(t))throw new TypeError;return n=u.call(arguments,2),r=function(){if(!(this instanceof r))return t.apply(e,n.concat(u.call(arguments)));V.prototype=t.prototype;var i=new V;V.prototype=null;var o=t.apply(i,n.concat(u.call(arguments)));return Object(o)===o?o:i}},S.partial=function(t){var e=u.call(arguments,1);return function(){return t.apply(this,e.concat(u.call(arguments)))}},S.bindAll=function(t){var e=u.call(arguments,1);if(0===e.length)throw new Error("bindAll must be passed function names");return N(e,function(e){t[e]=S.bind(t[e],t)}),t},S.memoize=function(t,e){var n={};return e||(e=S.identity),function(){var r=e.apply(this,arguments);return S.has(n,r)?n[r]:n[r]=t.apply(this,arguments)}},S.delay=function(t,e){var n=u.call(arguments,2);return setTimeout(function(){return t.apply(null,n)},e)},S.defer=function(t){return S.delay.apply(S,[t,1].concat(u.call(arguments,1)))},S.throttle=function(t,e,n){var r,i,o,s=null,a=0;n||(n={});var c=function(){a=n.leading===!1?0:new Date,s=null,o=t.apply(r,i)};return function(){var u=new Date;a||n.leading!==!1||(a=u);var l=e-(u-a);return r=this,i=arguments,0>=l?(clearTimeout(s),s=null,a=u,o=t.apply(r,i)):s||n.trailing===!1||(s=setTimeout(c,l)),o}},S.debounce=function(t,e,n){var r,i,o,s,a;return function(){o=this,i=arguments,s=new Date;var c=function(){var u=new Date-s;e>u?r=setTimeout(c,e-u):(r=null,n||(a=t.apply(o,i)))},u=n&&!r;return r||(r=setTimeout(c,e)),u&&(a=t.apply(o,i)),a}},S.once=function(t){var e,n=!1;return function(){return n?e:(n=!0,e=t.apply(this,arguments),t=null,e)}},S.wrap=function(t,e){return function(){var n=[t];return c.apply(n,arguments),e.apply(this,n)}},S.compose=function(){var t=arguments;return function(){for(var e=arguments,n=t.length-1;n>=0;n--)e=[t[n].apply(this,e)];return e[0]}},S.after=function(t,e){return function(){return--t<1?e.apply(this,arguments):void 0}},S.keys=C||function(t){if(t!==Object(t))throw new TypeError("Invalid object");var e=[];for(var n in t)S.has(t,n)&&e.push(n);return e},S.values=function(t){for(var e=S.keys(t),n=e.length,r=new Array(n),i=0;n>i;i++)r[i]=t[e[i]];return r},S.pairs=function(t){for(var e=S.keys(t),n=e.length,r=new Array(n),i=0;n>i;i++)r[i]=[e[i],t[e[i]]];return r},S.invert=function(t){for(var e={},n=S.keys(t),r=0,i=n.length;i>r;r++)e[t[n[r]]]=n[r];return e},S.functions=S.methods=function(t){var e=[];for(var n in t)S.isFunction(t[n])&&e.push(n);return e.sort()},S.extend=function(t){return N(u.call(arguments,1),function(e){if(e)for(var n in e)t[n]=e[n]}),t},S.pick=function(t){var e={},n=l.apply(o,u.call(arguments,1));return N(n,function(n){n in t&&(e[n]=t[n])}),e},S.omit=function(t){var e={},n=l.apply(o,u.call(arguments,1));for(var r in t)S.contains(n,r)||(e[r]=t[r]);return e},S.defaults=function(t){return N(u.call(arguments,1),function(e){if(e)for(var n in e)void 0===t[n]&&(t[n]=e[n])}),t},S.clone=function(t){return S.isObject(t)?S.isArray(t)?t.slice():S.extend({},t):t},S.tap=function(t,e){return e(t),t};var I=function(t,e,n,r){if(t===e)return 0!==t||1/t==1/e;if(null==t||null==e)return t===e;t instanceof S&&(t=t._wrapped),e instanceof S&&(e=e._wrapped);var i=p.call(t);if(i!=p.call(e))return!1;switch(i){case"[object String]":return t==String(e);case"[object Number]":return t!=+t?e!=+e:0==t?1/t==1/e:t==+e;case"[object Date]":case"[object Boolean]":return+t==+e;case"[object RegExp]":return t.source==e.source&&t.global==e.global&&t.multiline==e.multiline&&t.ignoreCase==e.ignoreCase}if("object"!=typeof t||"object"!=typeof e)return!1;for(var o=n.length;o--;)if(n[o]==t)return r[o]==e;var s=t.constructor,a=e.constructor;if(s!==a&&!(S.isFunction(s)&&s instanceof s&&S.isFunction(a)&&a instanceof a))return!1;n.push(t),r.push(e);var c=0,u=!0;if("[object Array]"==i){if(c=t.length,u=c==e.length)for(;c--&&(u=I(t[c],e[c],n,r)););}else{for(var l in t)if(S.has(t,l)&&(c++,!(u=S.has(e,l)&&I(t[l],e[l],n,r))))break;if(u){for(l in e)if(S.has(e,l)&&!c--)break;u=!c}}return n.pop(),r.pop(),u};S.isEqual=function(t,e){return I(t,e,[],[])},S.isEmpty=function(t){if(null==t)return!0;if(S.isArray(t)||S.isString(t))return 0===t.length;for(var e in t)if(S.has(t,e))return!1;return!0},S.isElement=function(t){return!(!t||1!==t.nodeType)},S.isArray=_||function(t){return"[object Array]"==p.call(t)},S.isObject=function(t){return t===Object(t)},N(["Arguments","Function","String","Number","Date","RegExp"],function(t){S["is"+t]=function(e){return p.call(e)=="[object "+t+"]"}}),S.isArguments(arguments)||(S.isArguments=function(t){return!(!t||!S.has(t,"callee"))}),"function"!=typeof/./&&(S.isFunction=function(t){return"function"==typeof t}),S.isFinite=function(t){return isFinite(t)&&!isNaN(parseFloat(t))},S.isNaN=function(t){return S.isNumber(t)&&t!=+t},S.isBoolean=function(t){return t===!0||t===!1||"[object Boolean]"==p.call(t)},S.isNull=function(t){return null===t},S.isUndefined=function(t){return void 0===t},S.has=function(t,e){return h.call(t,e)},S.noConflict=function(){return t._=r,this},S.identity=function(t){return t},S.times=function(t,e,n){for(var r=Array(Math.max(0,t)),i=0;t>i;i++)r[i]=e.call(n,i);return r},S.random=function(t,e){return null==e&&(e=t,t=0),t+Math.floor(Math.random()*(e-t+1))};var O={escape:{"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#x27;"}};O.unescape=S.invert(O.escape);var j={escape:new RegExp("["+S.keys(O.escape).join("")+"]","g"),unescape:new RegExp("("+S.keys(O.unescape).join("|")+")","g")};S.each(["escape","unescape"],function(t){S[t]=function(e){return null==e?"":(""+e).replace(j[t],function(e){return O[t][e]})}}),S.result=function(t,e){if(null==t)return void 0;var n=t[e];return S.isFunction(n)?n.call(t):n},S.mixin=function(t){N(S.functions(t),function(e){var n=S[e]=t[e];S.prototype[e]=function(){var t=[this._wrapped];return c.apply(t,arguments),F.call(this,n.apply(S,t))}})};var L=0;S.uniqueId=function(t){var e=++L+"";return t?t+e:e},S.templateSettings={evaluate:/<%([\s\S]+?)%>/g,interpolate:/<%=([\s\S]+?)%>/g,escape:/<%-([\s\S]+?)%>/g};var R=/(.)^/,q={"'":"'","\\":"\\","\r":"r","\n":"n","	":"t","\u2028":"u2028","\u2029":"u2029"},M=/\\|'|\r|\n|\t|\u2028|\u2029/g;S.template=function(t,e,n){var r;n=S.defaults({},n,S.templateSettings);var i=new RegExp([(n.escape||R).source,(n.interpolate||R).source,(n.evaluate||R).source].join("|")+"|$","g"),o=0,s="__p+='";t.replace(i,function(e,n,r,i,a){return s+=t.slice(o,a).replace(M,function(t){return"\\"+q[t]}),n&&(s+="'+\n((__t=("+n+"))==null?'':_.escape(__t))+\n'"),r&&(s+="'+\n((__t=("+r+"))==null?'':__t)+\n'"),i&&(s+="';\n"+i+"\n__p+='"),o=a+e.length,e}),s+="';\n",n.variable||(s="with(obj||{}){\n"+s+"}\n"),s="var __t,__p='',__j=Array.prototype.join,print=function(){__p+=__j.call(arguments,'');};\n"+s+"return __p;\n";try{r=new Function(n.variable||"obj","_",s)}catch(a){throw a.source=s,a}if(e)return r(e,S);var c=function(t){return r.call(this,t,S)};return c.source="function("+(n.variable||"obj")+"){\n"+s+"}",c},S.chain=function(t){return S(t).chain()};var F=function(t){return this._chain?S(t).chain():t};S.mixin(S),N(["pop","push","reverse","shift","sort","splice","unshift"],function(t){var e=o[t];S.prototype[t]=function(){var n=this._wrapped;return e.apply(n,arguments),"shift"!=t&&"splice"!=t||0!==n.length||delete n[0],F.call(this,n)}}),N(["concat","join","slice"],function(t){var e=o[t];S.prototype[t]=function(){return F.call(this,e.apply(this._wrapped,arguments))}}),S.extend(S.prototype,{chain:function(){return this._chain=!0,this},value:function(){return this._wrapped}})}).call(this)},{}],145:[function(t,e){"use strict";var n=t("substance-application"),r=t("./lens_controller"),i=t("lens-converter"),o=[{route:":context/:node/:resource/:fullscreen",name:"document-resource",command:"openReader"},{route:":context/:node/:resource",name:"document-resource",command:"openReader"},{route:":context/:node/:resource",name:"document-resource",command:"openReader"},{route:":context/:node",name:"document-node",command:"openReader"},{route:":context",name:"document-context",command:"openReader"},{route:"url/:url",name:"document-context",command:"openReader"},{route:"",name:"document",command:"openReader"}],s=function(e){e=e||{},e.routes=o,n.call(this,e);var a=t("./panel_specification"),c=new s.Reader.PanelFactory(a);e.panelFactory=c,e.converter=new i.Importer,this.controller=new r(e)};s.Article=t("lens-article"),s.Reader={Controller:t("./reader_controller"),View:t("./reader_view"),PanelFactory:t("./panel_factory")},s.Outline=t("lens-outline"),s.Prototype=function(){this.render=function(){this.view=this.controller.createView(),this.$el.html(this.view.render().el)}},s.Prototype.prototype=n.prototype,s.prototype=new s.Prototype,s.prototype.constructor=s;var a={util:t("substance-util"),Application:t("substance-application"),Document:t("substance-document"),Operator:t("substance-operator"),Chronicle:t("substance-chronicle"),Data:t("substance-data"),Surface:t("substance-surface")};s.Substance=a,e.exports=s},{"./lens_controller":146,"./panel_factory":148,"./panel_specification":149,"./reader_controller":150,"./reader_view":151,"lens-article":4,"lens-converter":53,"lens-outline":60,"substance-application":62,"substance-chronicle":152,"substance-data":68,"substance-document":73,"substance-operator":152,"substance-surface":135,"substance-util":139}],146:[function(t,e){"use strict";var n=t("underscore"),r=t("substance-util"),i=t("substance-application").Controller,o=t("./lens_view"),s=t("./reader_controller"),a=t("lens-article"),c=function(t){i.call(this),this.config=t,this.converter=t.converter,this.on("open:reader",this.openReader)},u={TRIM_WHITESPACES:!0,REMOVE_INNER_WS:!0};c.Prototype=function(){this.createView=function(){var t=new o(this);return this.view=t,t},this.importXML=function(t){var e=this.converter.import(t,u);this.createReader(e,{context:"toc"})},this.updatePath=function(t){var e=[];e.push(t.context),e.push(t.node?t.node:"all"),t.resource&&e.push(t.resource),t.fullscreen&&e.push("fullscreen"),window.app.router.navigate(e.join("/"),{trigger:!1,replace:!1})},this.createReader=function(t,e){var n=this;this.reader=new s(t,e,this.config),this.reader.on("state-changed",function(){n.updatePath(n.reader.state)}),this.modifyState({context:"reader"})},this.openReader=function(t,e,n,r){var i=this,o={context:t||"toc",node:e,resource:n,fullscreen:!!r};if(this.reader)this.reader.modifyState(o),o.resource&&this.reader.view.jumpToResource(o.resource);else if("lens_article.xml"===this.config.document_url){var s=a.describe();i.createReader(s,o)}else this.trigger("loading:started","Loading article"),$.get(this.config.document_url).done(function(t){var e,n=$.isXMLDoc(t);n?e=i.converter.import(t,u):("string"==typeof t&&(t=$.parseJSON(t)),e=a.fromSnapshot(t)),"toc"===o.context&&e.getHeadings().length<=2&&(o.context="info"),i.createReader(e,o)}).fail(function(t){i.view.startLoading("Error during loading. Please try again."),console.error(t)})},this.getActiveControllers=function(){var t=[["lens",this]];return t.push(["reader",this.reader]),t}},c.Prototype.prototype=i.prototype,c.prototype=new c.Prototype,n.extend(c.prototype,r.Events),e.exports=c},{"./lens_view":147,"./reader_controller":150,"lens-article":4,"substance-application":62,"substance-util":139,underscore:144}],147:[function(t,e){"use strict";var n=t("underscore"),r=t("substance-application").View,i=t("substance-application").$$,o=function(t){r.call(this),this.controller=t,this.$el.attr({id:"container"}),this.listenTo(this.controller,"state-changed",this.onStateChanged),this.listenTo(this.controller,"loading:started",this.startLoading),$(document).on("dragover",function(){return!1}),$(document).on("ondragend",function(){return!1}),$(document).on("drop",this.handleDroppedFile.bind(this))};o.Prototype=function(){this.handleDroppedFile=function(){var t=this.controller,e=event.dataTransfer.files,n=e[0],r=new FileReader;return r.onload=function(e){t.importXML(e.target.result)},r.readAsText(n),!1},this.onStateChanged=function(){var t=this.controller.state;"reader"===t.context?this.openReader():console.log("Unknown application state: "+t)},this.startLoading=function(t){t||(t="Loading article"),$(".spinner-wrapper .message").html(t),$("body").addClass("loading")},this.stopLoading=function(){$("body").removeClass("loading")},this.openReader=function(){var t=this.controller.reader.createView(),e=this;e.replaceMainView("reader",t),e.startLoading("Typesetting"),this.$("#main").css({opacity:0}),n.delay(function(){e.stopLoading(),e.$("#main").css({opacity:1})},1e3)},this.replaceMainView=function(t,e){$("body").removeClass().addClass("current-view "+t),this.mainView&&this.mainView!==e&&this.mainView.dispose(),this.mainView=e,this.$("#main").html(e.render().el)},this.render=function(){return this.el.innerHTML="",this.el.appendChild(i(".browser-not-supported",{text:"Sorry, your browser is not supported.",style:"display: none;"})),this.el.appendChild(i(".spinner-wrapper",{children:[i(".spinner"),i(".message",{html:"Loading article"})]})),this.el.appendChild(i("#main")),this},this.dispose=function(){this.stopListening(),this.mainView&&this.mainView.dispose()}},o.Prototype.prototype=r.prototype,o.prototype=new o.Prototype,e.exports=o},{"substance-application":62,underscore:144}],148:[function(t,e){function n(t){this.panelSpecs={},r.each(t,function(t,e){this.addPanel(e,t)},this)}var r=t("underscore"),i=t("substance-document"),o=t("substance-surface"),s=t("substance-toc");n.Prototype=function(){var t=function(t,e){var n=e.get(t);return!!n&&0!==n.nodes.length};this.addPanel=function(e,n){n.name=e,n.shouldBeVisible=n.shouldBeVisible||t,this.panelSpecs[n.name]=n},this.getSpec=function(t){return this.panelSpecs[t]},this.getNames=function(){return Object.keys(this.panelSpecs)},this.createPanelController=function(t,e){return new i.Controller(t,{view:e})},this.createPanelView=function(t,e){var n,r,i=this.getSpec(t),a=e.__document;if(i.createRenderer)n=i.createRenderer(t,e);else{var c=a.constructor.Renderer;n=new c(e)}return r="toc"===t?new s(a):new o(e,{editable:!1,renderer:n}),r.$el.addClass("resource-view"),r}},n.prototype=new n.Prototype,e.exports=n},{"substance-document":73,"substance-surface":135,"substance-toc":137,underscore:144}],149:[function(t,e){var n=t("substance-application").$$,r=t("lens-article"),i=function(t,e){var r=e.node;if("info"!==t.view||"contributor"===r.type||"collaborator"===r.type){var i=[n("a.name",{href:"#",text:r.header,"sbs-click":"toggleResource("+r.id+")"})],o=r.constructor.config;o&&o.zoomable&&i.push(n("a.toggle-fullscreen",{href:"#",html:'<i class="icon-resize-full"></i><i class="icon-resize-small"></i>',"sbs-click":"toggleFullscreen("+r.id+")"})),i.push(n("a.toggle-res",{href:"#","sbs-click":"toggleResource("+r.id+")",html:'<i class="icon-eye-open"></i><i class="icon-eye-close"></i>'}));var s=n(".resource-header",{children:i});e.el.insertBefore(s,e.content)}},o=function(t,e){return new r.Renderer(e,{afterRender:i})},s={content:{type:"content",label:"Text",title:"Content",icon:"icon-align-left",createRenderer:function(t,e){return new r.Renderer(e)}},toc:{type:"toc",label:"Content",title:"Content",icon:"icon-align-left",shouldBeVisible:function(){return!0}},figures:{type:"resource",label:"Figures",title:"Figures",icon:"icon-picture",references:["figure_reference"],createRenderer:o},citations:{type:"resource",label:"References",title:"References",icon:"icon-link",references:["citation_reference"],createRenderer:o},definitions:{type:"resource",label:"Glossary",title:"Glossary",icon:"icon-book",references:["definition_reference"],createRenderer:o},info:{type:"resource",label:"Info",title:"Article Info",icon:"icon-info-sign",references:["contributor_reference"],createRenderer:o}};e.exports=s},{"lens-article":4,"substance-application":62}],150:[function(t,e){"use strict";var n=t("underscore"),r=t("substance-application").Controller,i=t("./reader_view"),o=t("./panel_factory"),s=function(t,e,r){this.__document=t,this.options=r||{},this.panelFactory=r.panelFactory||new o,this.panelCtrls={},this.contentCtrl=this.panelFactory.createPanelController(t,"content"),n.each(this.panelFactory.getNames(),function(e){"content"!==e&&"toc"!==e&&(this.panelCtrls[e]=this.panelFactory.createPanelController(t,e))},this),this.state=e,this.currentContext="toc"};s.Prototype=function(){this.createView=function(){return this.view||(this.view=new i(this)),this.view},this.switchContext=function(t){this.currentContext=t,this.modifyState({context:t,node:null,resource:null})},this.modifyState=function(t){r.prototype.modifyState.call(this,t)},this.getActiveControllers=function(){var t=[];return t.push(["article",this]),t.push(["reader",this.panelCtrls[this.context]]),t}},s.Prototype.prototype=r.prototype,s.prototype=new s.Prototype,e.exports=s},{"./panel_factory":148,"./reader_view":151,"substance-application":62,underscore:144}],151:[function(t,e){"use strict";var n=t("underscore"),r=t("lens-outline"),i=t("substance-application").View,o=t("substance-data"),s=o.Graph.Index,a=t("substance-application").$$,c=0,u=function(t){var e=document.createDocumentFragment(),r=a(".document");r.appendChild(t.contentView.render().el);var i=[],o=t.panelFactory;n.each(o.getNames(),function(e){if("content"!==e&&t.panelViews[e]){var n=o.getSpec(e);if("toc"===e&&t.doc.getHeadings().length<=2)return;
i.push(a("a.context-toggle."+e,{href:"#","sbs-click":"switchContext("+e+")",title:n.title,html:'<i class="'+n.icon+'"></i><span> '+n.label+'</span><div class="label">'+n.label+"</div>"}))}});var s=a(".context-toggles",{children:i}),c=a(".medial-strip"),u=t.readerCtrl.options.collection;u&&c.appendChild(a("a.back-nav",{href:u.url,title:"Go back",html:'<i class=" icon-chevron-up"></i>'})),c.appendChild(a(".separator-line")),c.appendChild(s),e.appendChild(c);var l=a(".resources");return n.each(o.getNames(),function(e){"content"!==e&&t.panelViews[e]&&l.appendChild(t.panelViews[e].render().el)}),e.appendChild(r),e.appendChild(l),e},l=function(t){i.call(this),this.readerCtrl=t,this.panelFactory=t.panelFactory;var e=this.readerCtrl.contentCtrl.__document;this.doc=e,this.$el.addClass("article"),this.$el.addClass(e.schema.id),this.bodyScroll={};var o=t.panelFactory;this.contentView=o.createPanelView("content",t.contentCtrl),this.panelViews={},n.each(o.getNames(),function(n){if("content"!==n){var r=o.getSpec(n);if(r.shouldBeVisible(n,e)){var i;"toc"===n?i=o.createPanelView("toc",t.contentCtrl):t.panelCtrls[n]&&(i=o.createPanelView(n,t.panelCtrls[n])),i&&(this.panelViews[n]=i)}}},this),this.tocView=this.panelViews.toc,this.listenTo(this.readerCtrl,"state-changed",this.updateState),this.resources=new s(this.readerCtrl.__document,{types:["resource_reference"],property:"target"}),this.outline=new r(this.contentView),this.resourcesOutline=new r(this.figuresView),this.contentView.$el.on("scroll",n.bind(this.onContentScroll,this)),n.each(this.panelFactory.getNames(),function(t){if(this.panelViews[t]){var e=this.panelFactory.getSpec(t),r=this.panelViews[t];r.$el.on("scroll",n.bind(this.onResourceContentScroll,this)),n.each(e.references,function(t){this.$el.on("click",".annotation."+t,n.bind(this.toggleResourceReference,this,e.name))},this)}},this),this.$el.on("click",".annotation.cross_reference",n.bind(this.followCrossReference,this)),this.$el.on("click",".document .content-node.heading .top",n.bind(this.gotoTop,this)),this.outline.$el.on("click",".node",n.bind(this._jumpToNode,this))};l.Prototype=function(){this.setAnchor=function(t){this.toggleNode("toc",$(t.currentTarget).attr("id"))},this.gotoTop=function(){return this.jumpToNode("cover"),$(document).scrollTop(0),!1},this.toggleFullscreen=function(t){var e=this.readerCtrl.state;this.readerCtrl.modifyState({resource:t,fullscreen:!e.fullscreen})},this._jumpToNode=function(t){var e=$(t.currentTarget).attr("id").replace("outline_","");return this.jumpToNode(e),!1},this.toggleResourceReference=function(t,e){var n=this.readerCtrl.state,r=$(e.currentTarget).attr("id"),i=this.readerCtrl.__document.get(r),o=this.readerCtrl.contentCtrl.container.getRoot(i.path[0]),s=i.target;s===n.resource?this.readerCtrl.modifyState({context:this.readerCtrl.currentContext,node:null,resource:null}):(this.saveScroll(),this.readerCtrl.modifyState({context:t,node:o,resource:s}),this.jumpToResource(s)),e.preventDefault()},this.followCrossReference=function(t){var e=$(t.currentTarget).attr("id"),n=this.readerCtrl.__document.get(e);this.jumpToNode(n.target)},this.onContentScroll=function(){var t=this.contentView.$el.scrollTop();this.outline.updateVisibleArea(t),this.markActiveHeading(t)},this.onResourceContentScroll=function(){if(this.resourcesOutline.surface){var t=this.resourcesOutline.surface.$el.scrollTop();this.resourcesOutline.updateVisibleArea(t)}},this.markActiveHeading=function(t){var e=$(".nodes").height(),r=this.doc.getHeadings();if(0!==r.length){var i=n.first(r).id;this.contentView.$(".content-node.heading").each(function(){t>=$(this).position().top+c&&(i=this.id)}),t+this.contentView.$el.height()>=e&&(i=n.last(r).id),this.tocView.setActiveNode(i)}},this.toggleResource=function(t){var e=this.readerCtrl.state,n=e.node;e.resource===t&&(t=null,n=null),this.readerCtrl.modifyState({fullscreen:!1,resource:t,node:n})},this.jumpToNode=function(t){var e=$("#"+t);if(e.length>0){var n=e.position().top+c;this.contentView.$el.scrollTop(n)}},this.jumpToResource=function(t){var e=$("#"+t);if(e.length>0){var n=e.position().top,r=this.panelViews[this.readerCtrl.state.context];r&&r.$el.scrollTop(n),$(document).scrollTop(n)}},this.toggleNode=function(t,e){var n=this.readerCtrl.state;this.readerCtrl.modifyState(n.node===e&&n.context===t?{context:this.readerCtrl.currentContext,node:null,resource:null}:{context:t,node:e,resource:null})},this.getScroll=function(){return $(document).scrollTop()},this.recoverScroll=function(){var t=this.bodyScroll[this.readerCtrl.state.context];t&&$(document).scrollTop(t)},this.saveScroll=function(){this.bodyScroll[this.readerCtrl.state.context]=this.getScroll()},this.switchContext=function(t){this.saveScroll(),this.readerCtrl.switchContext(t),this.recoverScroll()},this.updateState=function(t){t=t||{};var e=this.readerCtrl.state;this.$el.removeClass("toc figures citations info definitions"),this.contentView.$(".content-node.active").removeClass("active"),this.$el.addClass(e.context),e.node&&this.contentView.$("#"+e.node).addClass("active"),this.updateResource()},this.updateResource=function(){var t=this.readerCtrl.state;if(this.$(".resources .content-node.active").removeClass("active fullscreen"),this.contentView.$(".annotation.active").removeClass("active"),t.resource){var e=this.$("#"+t.resource);e.addClass("active"),t.fullscreen&&e.addClass("fullscreen");var r=this.resources.get(t.resource);n.each(r,function(t){this.contentView.$("#"+t.id).addClass("active")},this)}else this.recoverScroll();this.updateOutline()},this.isMobile=function(){},this.updateOutline=function(){var t=this,e=this.readerCtrl.state,n=this.getResourceReferenceContainers();return t.outline.update({context:e.context,selectedNode:e.node,highlightedNodes:n}),"toc"===e.context?void $(t.resourcesOutline.el).addClass("hidden"):(t.resourcesOutline.surface=this.panelViews[e.context]?this.panelViews[e.context]:this.panelViews.info,$(t.resourcesOutline.el).removeClass("hidden"),void t.resourcesOutline.update({context:e.context,selectedNode:e.node,highlightedNodes:[e.resource]}))},this.getResourceReferenceContainers=function(){var t=this.readerCtrl.state;if(!t.resource)return[];var e=this.resources.get(t.resource),r=this.readerCtrl.contentCtrl.container,i=n.uniq(n.map(e,function(t){var e=r.getRoot(t.path[0]);return e}));return i},this.render=function(){var t=this,e=this.readerCtrl.state;this.el.appendChild(new u(this)),this.$(".document").append(t.outline.el),this.$(".resources").append(t.resourcesOutline.el),n.delay(function(){t.updateState(),window.MathJax.Hub.Queue(["Typeset",window.MathJax.Hub])},1),n.delay(function(){t.updateOutline()},2e3);var r=n.debounce(function(){t.updateOutline()},1);return e.node&&n.delay(function(){t.jumpToNode(e.node),e.resource&&t.jumpToResource(e.resource)},100),$(window).resize(r),this},this.dispose=function(){this.contentView.dispose(),this.figuresView&&this.figuresView.dispose(),this.citationsView&&this.citationsView.dispose(),this.infoView&&this.infoView.dispose(),this.resources.dispose(),this.stopListening()}},l.Prototype.prototype=i.prototype,l.prototype=new l.Prototype,l.prototype.constructor=l,e.exports=l},{"lens-outline":60,"substance-application":62,"substance-data":68,underscore:144}],152:[function(){},{}]},{},[1]);